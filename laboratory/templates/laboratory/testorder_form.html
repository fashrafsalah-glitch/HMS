{# laboratory/templates/laboratory/testorder_form.html #}
{% extends "base.html" %}
{% load widget_tweaks static %}

{% block title %}New Lab Request{% endblock %}

{% block content %}
<div class="container my-4">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{% url 'manager:patient_detail' patient.id %}">
          ← Back to {{ patient.first_name }} {{ patient.last_name }}
        </a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">New Lab Request</li>
    </ol>
  </nav>

  <div class="row">
    <!-- Patient card -->
    <div class="col-md-4 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <img src="{% if patient.photo %}{{ patient.photo.url }}{% else %}{% static 'images/patient-placeholder.png' %}{% endif %}"
               alt="Patient photo"
               class="rounded-circle mb-2"
               style="width:100px;height:100px;object-fit:cover;">
          <h5 class="card-title mb-0">{{ patient.first_name }} {{ patient.last_name }}</h5>
          <small class="text-muted d-block">MRN {{ patient.mrn }}</small>
          <small class="text-muted d-block">DOB {{ patient.date_of_birth }}</small>
        </div>
      </div>
    </div>

    <!-- Form -->
    <div class="col-md-8">
      <div class="card">
        <div class="card-header"><h4 class="mb-0">Submit Lab Request</h4></div>
        <div class="card-body">
          <form method="post" novalidate>
            {% csrf_token %}
            {{ form.non_field_errors }}

            <div class="row g-3">
              <!-- Category -->
              <div class="col-md-4">
                <label class="form-label fw-bold" for="{{ form.category.id_for_label }}">Category</label>
                {{ form.category|add_class:"form-select" }}
                {{ form.category.errors }}
              </div>

              <!-- Sub-category -->
              <div class="col-md-4">
                <label class="form-label fw-bold" for="{{ form.sub_category.id_for_label }}">Sub-category</label>
                {{ form.sub_category|add_class:"form-select" }}
                {{ form.sub_category.errors }}
              </div>

              <!-- Tube type -->
              <div class="col-md-4">
                <label class="form-label fw-bold" for="{{ form.tube_type.id_for_label }}">Tube type</label>
                {{ form.tube_type|add_class:"form-select" }}
                {{ form.tube_type.errors }}
              </div>

              <!-- Test group -->
              <div class="col-md-6">
                <label class="form-label fw-bold" for="{{ form.group.id_for_label }}">Test Group</label>
                {{ form.group|add_class:"form-select" }}
                {{ form.group.errors }}
              </div>

              <!-- Tests (with quick filter) -->
              <div class="col-md-6">
                <label class="form-label fw-bold">Tests</label>
                <input type="text" id="test-search"
                       class="form-control form-control-sm mb-2"
                       placeholder="Type to filter tests…">
                <div class="border rounded p-2" style="max-height:260px;overflow-y:auto;">
                  {% for checkbox in form.tests %}
                    <div class="form-check">
                      {{ checkbox.tag }}
                      <label class="form-check-label" for="{{ checkbox.id_for_label }}">
                        {{ checkbox.choice_label }}
                      </label>
                    </div>
                  {% endfor %}
                </div>
                {{ form.tests.errors }}
                <div class="form-text">Pick one or more tests, or choose a group.</div>
              </div>
            </div> <!-- /row -->

            <!-- Actions -->
            <div class="d-flex justify-content-end mt-4">
              <button type="submit" class="btn btn-primary btn-sm me-2">
                <i class="bi bi-send"></i> Submit
              </button>
              <a href="{% url 'manager:patient_detail' patient.id %}" class="btn btn-secondary btn-sm">
                Cancel
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('test-search').addEventListener('input', e => {
  const term = e.target.value.toLowerCase();
  document.querySelectorAll('.form-check').forEach(row => {
    const label = row.querySelector('label').textContent.toLowerCase();
    row.style.display = label.includes(term) ? '' : 'none';
  });
});
</script>
{% endblock %}
