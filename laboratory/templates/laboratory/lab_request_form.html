{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <h3 class="mb-3">Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ù…Ø®ØªØ¨Ø± Ø¬Ø¯ÙŠØ¯</h3>

  <form id="lab-form" method="post" novalidate>
    {% csrf_token %}

    <div class="row g-4">
      <!-- =============== Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠØ³Ø±: Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª =============== -->
      <div class="col-lg-5">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <span class="fw-semibold">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</span>
            <small class="text-muted">Ø§Ø®ØªØ± Ù…Ø¬Ù…ÙˆØ¹Ø© Ù„ØªØ­Ø¯ÙŠØ¯ ÙƒÙ„ ØªØ­Ø§Ù„ÙŠÙ„Ù‡Ø§</small>
          </div>
          <div class="card-body">
            <div id="groups-list" class="list-group">
              {% for g in groups %}
                <div class="list-group-item">
                  <div class="d-flex align-items-center gap-2">
                    <input
                      type="checkbox"
                      class="form-check-input js-group"
                      id="grp_{{ g.id }}"
                      data-test-ids="{% for t in g.tests.all %}{{ t.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
                    <label class="form-check-label fw-semibold" for="grp_{{ g.id }}">{{ g.name }}</label>
                    <span class="badge bg-secondary ms-1">{{ g.tests.count }} ØªØ­Ù„ÙŠÙ„</span>

                    <button type="button"
                            class="btn btn-sm btn-outline-primary ms-auto js-group-select-all"
                            data-target="#grp_{{ g.id }}">
                      ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
                    </button>

                    <button type="button"
                            class="btn btn-sm btn-outline-secondary js-group-toggle"
                            data-collapse="#grp_tests_{{ g.id }}">
                      Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡
                    </button>
                  </div>

                  <div id="grp_tests_{{ g.id }}" class="mt-2 collapse">
                    <div class="small text-muted">
                      {% for t in g.tests.all %}
                        <span class="badge bg-light border text-dark me-1 mb-1">
                          {{ t.english_name|default:t }}
                        </span>
                      {% empty %} â€” Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ø§Ù„ÙŠÙ„ â€” {% endfor %}
                    </div>
                  </div>
                </div>
              {% empty %}
                <div class="text-muted px-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª.</div>
              {% endfor %}
              <!-- â€œØ£Ø®Ø±Ù‰â€ Ø³ØªÙØ­Ù‚Ù† Ù‡Ù†Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ù„Ø²ÙˆÙ… -->
            </div>

            <div class="d-flex gap-2 mt-3">
              <a class="btn btn-sm btn-outline-primary" href="{% url 'laboratory:testgroup_create' %}">+ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</a>
              <a class="btn btn-sm btn-outline-secondary" href="{% url 'laboratory:testgroup_list' %}">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</a>
            </div>
          </div>
        </div>
      </div>

      <!-- =============== Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠÙ…Ù†: Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„ (Ø§Ù„ØªØ´ÙŠÙƒØ¨ÙˆÙƒØ³Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ©) =============== -->
      <div class="col-lg-7">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-header bg-white d-flex align-items-center gap-2">
            <span class="fw-semibold">Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„</span>
            <input id="test-filter" type="search" class="form-control form-control-sm ms-auto"
                   placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØªØ­Ù„ÙŠÙ„..." style="max-width: 260px;">
          </div>
          <div class="card-body">
            <div id="tests-grid" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-2">
              {% for subwidget in form.tests %}
                <div class="col js-test-item">
                  <div class="form-check">
                    {{ subwidget }}
                  </div>
                </div>
              {% empty %}
                <div class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ø§Ù„ÙŠÙ„.</div>
              {% endfor %}
            </div>
            {{ form.tests.errors }}

            <div class="mt-3 d-flex gap-2">
              <button type="button" id="btn-clear-tests" class="btn btn-sm btn-outline-danger">Ù…Ø³Ø­ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª</button>
              <a class="btn btn-sm btn-outline-primary" href="{% url 'laboratory:test_add' %}">+ ØªØ­Ù„ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</a>
              <a class="btn btn-sm btn-outline-secondary" href="{% url 'laboratory:test_list' %}">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­ÙØ¸ -->
    <div class="mt-4 d-flex gap-2">
      <button class="btn btn-primary">Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨</button>
      <a class="btn btn-outline-secondary" href="javascript:history.back()">Ø¥Ù„ØºØ§Ø¡</a>
    </div>
  </form>
</div>

<script>
(function(){
  const form          = document.getElementById('lab-form');
  const testsGrid     = document.getElementById('tests-grid');
  const filterInput   = document.getElementById('test-filter');
  const groupsList    = document.getElementById('groups-list');

  // ÙƒÙ„ ØªØ´ÙŠÙƒØ¨ÙˆÙƒØ³Ø§Øª Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„ (Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ù„Ù„Ø³ÙŠØ±ÙØ±)
  function getTestCheckboxes(){
    // Django ØºØ§Ù„Ø¨Ù‹Ø§ ÙŠØ³ØªØ®Ø¯Ù… name="tests" Ù„Ù€ CheckboxSelectMultiple
    return Array.from(form.querySelectorAll('input[type="checkbox"][name="tests"], input[type="checkbox"][name="tests[]"]'));
  }

  // Ø¹Ù„Ù‘ÙÙ…/Ø£Ù„Øº ØªØ¹Ù„ÙŠÙ… IDs
  function setTestsCheckedByIds(ids, checked){
    const set = new Set(ids.map(String));
    getTestCheckboxes().forEach(cb => {
      if (set.has(String(cb.value))) cb.checked = !!checked;
    });
    updateAllGroupsState();
  }

  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ù…Ø¬Ù…ÙˆØ¹Ø© ÙˆØ§Ø­Ø¯Ø© (checked/indeterminate) Ø­Ø³Ø¨ ØªØ­Ø§Ù„ÙŠÙ„Ù‡Ø§
  function updateGroupState(groupEl){
    const ids = (groupEl.dataset.testIds || '').split(',').map(s => s.trim()).filter(Boolean);
    if (!ids.length){ groupEl.checked = false; groupEl.indeterminate = false; return; }

    const set = new Set(ids);
    let selected = 0;
    getTestCheckboxes().forEach(cb => { if (set.has(String(cb.value)) && cb.checked) selected++; });

    if (selected === 0)       { groupEl.checked = false; groupEl.indeterminate = false; }
    else if (selected === ids.length) { groupEl.checked = true;  groupEl.indeterminate = false; }
    else                      { groupEl.checked = false; groupEl.indeterminate = true; }
  }

  function updateAllGroupsState(){
    groupsList.querySelectorAll('.js-group').forEach(updateGroupState);
  }

  // Ø¨Ù†Ø§Ø¡ â€œÙ…Ø¬Ù…ÙˆØ¹Ø© Ø£Ø®Ø±Ù‰â€ Ù„Ù„ØªØ­Ø§Ù„ÙŠÙ„ ØºÙŠØ± Ø§Ù„Ù…Ù†Ø³ÙˆØ¨Ø© Ù„Ø£ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø©
  function ensureOtherGroup(){
    const allIds = new Set(getTestCheckboxes().map(cb => String(cb.value)));
    const inGroups = new Set();
    groupsList.querySelectorAll('.js-group').forEach(grp => {
      (grp.dataset.testIds || '').split(',').map(s => s.trim()).filter(Boolean).forEach(id => inGroups.add(id));
    });
    const others = Array.from(allIds).filter(id => !inGroups.has(id));
    if (others.length > 0 && !document.getElementById('grp_other')) {
      const item = document.createElement('div');
      item.className = 'list-group-item';
      item.innerHTML = `
        <div class="d-flex align-items-center gap-2">
          <input type="checkbox" class="form-check-input js-group" id="grp_other" data-test-ids="${others.join(',')}">
          <label class="form-check-label fw-semibold" for="grp_other">Ø£Ø®Ø±Ù‰</label>
          <span class="badge bg-secondary ms-1">${others.length} ØªØ­Ù„ÙŠÙ„</span>
          <button type="button" class="btn btn-sm btn-outline-primary ms-auto js-group-select-all" data-target="#grp_other">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
          <button type="button" class="btn btn-sm btn-outline-secondary js-group-toggle" data-collapse="#grp_tests_other">Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡</button>
        </div>
        <div id="grp_tests_other" class="mt-2 collapse">
          <div class="small text-muted">
            ${
              getTestCheckboxes()
                .filter(cb => others.includes(String(cb.value)))
                .map(cb => {
                  const label = cb.closest('.form-check')?.querySelector('label');
                  return '<span class="badge bg-light border text-dark me-1 mb-1">' +
                         (label ? label.textContent.trim() : cb.value) +
                         '</span>';
                }).join(' ')
            }
          </div>
        </div>`;
      groupsList.appendChild(item);
    }
  }

  // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
  groupsList.addEventListener('change', function(e){
    const grp = e.target.closest('.js-group');
    if (!grp) return;
    const ids = (grp.dataset.testIds || '').split(',').map(s => s.trim()).filter(Boolean);
    setTestsCheckedByIds(ids, grp.checked || grp.indeterminate);
  });

  groupsList.addEventListener('click', function(e){
    const btnAll = e.target.closest('.js-group-select-all');
    if (btnAll){
      const sel = btnAll.getAttribute('data-target');
      const grp = sel ? document.querySelector(sel) : null;
      if (!grp) return;
      const ids = (grp.dataset.testIds || '').split(',').map(s => s.trim()).filter(Boolean);
      setTestsCheckedByIds(ids, true);
      return;
    }
    const btnTog = e.target.closest('.js-group-toggle');
    if (btnTog){
      const sel = btnTog.getAttribute('data-collapse');
      const area = sel ? document.querySelector(sel) : null;
      if (area) area.classList.toggle('collapse');
    }
  });

  // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø£ÙŠ ØªØ­Ù„ÙŠÙ„ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø­Ø¯Ø« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
  testsGrid.addEventListener('change', function(e){
    const cb = e.target;
    if (cb && (cb.name === 'tests' || cb.name === 'tests[]')){
      updateAllGroupsState();
    }
  });

  // ÙÙ„ØªØ±Ø© Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„
  if (filterInput){
    filterInput.addEventListener('input', function(){
      const q = this.value.trim().toLowerCase();
      testsGrid.querySelectorAll('.js-test-item').forEach(item => {
        const txt = item.textContent.toLowerCase();
        item.style.display = (!q || txt.includes(q)) ? '' : 'none';
      });
    });
  }

  // Ø²Ø± Ù…Ø³Ø­
  const clearBtn = document.getElementById('btn-clear-tests');
  if (clearBtn){
    clearBtn.addEventListener('click', () => {
      getTestCheckboxes().forEach(cb => cb.checked = false);
      updateAllGroupsState();
    });
  }

  // ğŸ”’ Ø¶Ù…Ø§Ù† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ø¯ÙˆÙ…Ù‹Ø§:
  form.addEventListener('submit', function(){
    // Ø§Ø­Ø°Ù Ø£ÙŠ hidden Ø£Ø¶ÙÙ†Ø§Ù‡ Ø³Ø§Ø¨Ù‚Ù‹Ø§
    form.querySelectorAll('input[type="hidden"][name="tests"]').forEach(n => n.remove());
    // Ù„ÙƒÙ„ ØªØ­Ù„ÙŠÙ„ Ù…ÙØ¹Ù„Ù‘ÙÙ… â†’ Ø£Ø¶Ù input hidden ÙŠØ¶Ù…Ù† ÙˆØµÙˆÙ„Ù‡
    getTestCheckboxes().forEach(cb => {
      if (cb.checked){
        const h = document.createElement('input');
        h.type  = 'hidden';
        h.name  = 'tests';
        h.value = cb.value;
        form.appendChild(h);
      }
    });
  });

  // ØªÙ‡ÙŠØ¦Ø©
  ensureOtherGroup();
  updateAllGroupsState();
})();
</script>
{% endblock %}