{% load i18n static %}
{% get_current_language as LANGUAGE_CODE %}
{% get_current_language_bidi as LANGUAGE_BIDI %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}" dir="{% if LANGUAGE_BIDI %}rtl{% else %}ltr{% endif %}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% trans "Patient Management" %}{% endblock %}</title>

    {# Bootstrap: RTL للعربية، عادي للإنجليزية #}
    {% if LANGUAGE_BIDI %}
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    {% else %}
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    {% endif %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
  .btn-soft-primary{
    background: rgba(13,110,253,.08);
    border-color: rgba(13,110,253,.25);
    color:#0d6efd;
  }
  .btn-soft-primary:hover{ background:#0d6efd; color:#fff; }

  .btn-soft-secondary{
    background: rgba(108,117,125,.08);
    border-color: rgba(108,117,125,.25);
    color:#6c757d;
  }
  .btn-soft-secondary:hover{ background:#6c757d; color:#fff; }

        :root {
            /* Light mode defaults */
            --body-bg: #f5f7fa;
            --body-color: #333;
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --text-on-gradient: #ffffff;
            --icon-on-gradient: #ffffff;
            --main-content-bg: #f5f7fa;
            --sidebar-bg: linear-gradient(180deg, #007bff, #00c4ff);
            --card-bg: white;
            --card-border: #e3e6f0;
            --table-bg: transparent;
            --table-color: #333;
            --table-border-color: #dee2e6; /* Bootstrap default border */
            --table-hover-bg: #f1f4f8;
            --table-striped-bg: rgba(0, 0, 0, 0.05);
            --shadow-light: rgba(0,0,0,0.1);
        }

        /* Dark mode overrides */
        body.dark-mode {
            --body-bg: #1a1d23;
            --body-color: #f7fafc;
            --text-primary: #f7fafc;
            --text-secondary: #cbd5e0;
            --text-on-gradient: #ffffff;
            --icon-on-gradient: #ffffff;
            --main-content-bg: #2d3748;
            --sidebar-bg: linear-gradient(180deg, #1e3a8a, #3b82f6);
            --card-bg: #2d3748;
            --card-border: rgba(255,255,255,0.1);
            --table-bg: transparent;
            --table-color: #f7fafc;
            --table-border-color: #4a5568;
            --table-hover-bg: #4a5568;
            --table-striped-bg: rgba(255, 255, 255, 0.05);
            --shadow-light: rgba(0,0,0,0.4);
        }

        /* Apply variables */
        body {
            background-color: var(--body-bg);
            font-family: 'Poppins', sans-serif;
            color: var(--body-color);
            display: flex;
            min-height: 100vh;
            margin: 0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .sidebar {
            width: 250px;
            background: var(--sidebar-bg);
            color: white;
            position: fixed;
            top: 0;
            /* Use logical property for RTL/LTR without template logic */
            inset-inline-start: 0; /* replaces left/right depending on dir */
            left: auto; right: auto; /* reset explicit sides */
            bottom: 0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            padding-top: 20px;
            transition: width 0.3s ease, background 0.3s ease;
            overflow-y: auto; /* Enable scrolling */
            overflow-x: hidden; /* Prevent horizontal scroll */
            /* Hide scrollbar visually while keeping scroll */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }
        .sidebar::-webkit-scrollbar { width: 0; height: 0; }
        .sidebar.collapsed { width: 60px; }
        .sidebar .sidebar-brand {
            color: white !important;
            font-weight: 600;
            padding: 20px;
            display: flex;
            align-items: center;
            text-decoration: none;
            font-size: 1.2rem;
            white-space: normal; /* Allow text wrapping */
            overflow: visible; /* Prevent text truncation */
            line-height: 1.2;
        }
        .sidebar.collapsed .sidebar-brand span { display: none; }
        .sidebar .nav-link {
            color: white !important;
            font-weight: 500;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
        }
        .sidebar.collapsed .nav-link span { display: none; }
        .sidebar .nav-link:hover {
            color: #e0e0e0 !important;
            background-color: rgba(255, 255, 255, 0.1);
            transform: none; /* prevent horizontal/vertical shift */
            transition: all 0.2s ease;
        }
        .sidebar .nav-link.active {
            background: rgba(255, 255, 255, 0.18);
            border-radius: 8px;
            color: #ffffff !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        /* Collapse toggle caret */
        .sidebar .nav-link[data-bs-toggle="collapse"]{ position: relative; }
        .sidebar .nav-link[data-bs-toggle="collapse"]::after{
            content: "\f282"; /* bi-chevron-down */
            font-family: 'bootstrap-icons';
            font-size: .9rem;
            margin-inline-start: auto;
            transition: transform .2s ease;
            opacity: .85;
        }
        .sidebar .nav-link[aria-expanded="true"][data-bs-toggle="collapse"]::after{ transform: rotate(180deg); }
        /* Hide caret in collapsed sidebar to avoid clutter */
        .sidebar.collapsed .nav-link[data-bs-toggle="collapse"]::after{ display: none; }

        /* Submenu indentation & divider using logical property */
        #manageHospitalSubmenu{ padding-inline-start: 12px; }
        #manageHospitalSubmenu .nav-link{ padding: 8px 16px; border-radius: 6px; }
        #manageHospitalSubmenu .nav-link:hover{ background-color: rgba(255,255,255,.08); }
        #manageHospitalSubmenu{ border-inline-start: 2px solid rgba(255,255,255,.15); margin-inline-start: 8px; border-radius: 0 0 0 0; }
        /* Icon sizing and alignment */
        .sidebar .nav-link i { width: 1.25rem; text-align: center; font-size: 1.1rem; }
        /* Collapsed: center icons, keep spacing, no movement */
        .sidebar.collapsed .nav-link { justify-content: center; padding: 12px 0; }
        .sidebar.collapsed .nav-link i { margin: 0; font-size: 1.25rem; }
        .sidebar.collapsed .nav-link:hover { transform: none; }
        .sidebar nav.flex-column { display: flex; flex-direction: column; gap: 4px; }
        .main-content {
            {% if LANGUAGE_BIDI %}
              margin-right: 250px; margin-left: 0;
            {% else %}
              margin-left: 250px;
            {% endif %}
            padding: 20px;
            flex-grow: 1;
            background-color: var(--main-content-bg);
            transition: margin 0.3s ease, background-color 0.3s ease;
        }
        .main-content.collapsed {
            {% if LANGUAGE_BIDI %}
              margin-right: 60px; margin-left: 0;
            {% else %}
              margin-left: 60px;
            {% endif %}
        }
        .toggle-btn {
            background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0 20px;
        }
        .mode-toggle {
            background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; padding: 12px 20px; display: flex; align-items: center;
        }
        .container { max-width: 1200px; }
        h2, h4, h5 { color: #007bff; font-weight: 600; }
        body.dark-mode h2, body.dark-mode h4, body.dark-mode h5 { color: #3b82f6; }
        .form-control, .form-select {
            border-radius: 8px; border: 1px solid #d1d9e6; padding: 10px 15px; font-size: 0.95rem; box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            background-color: #fff; color: #333; transition: border-color 0.3s ease, background-color 0.3s ease, color 0.3s ease;
        }
        body.dark-mode .form-control, body.dark-mode .form-select {
            background-color: #3a3a3a !important; color: #e0e0e0 !important; border-color: #555 !important;
        }
        .form-control:focus, .form-select:focus { border-color: #007bff; box-shadow: 0 0 5px rgba(0, 123, 255, 0.3); }
        body.dark-mode .form-control:focus, body.dark-mode .form-select:focus { border-color: #3b82f6; box-shadow: 0 0 5px rgba(59, 130, 246, 0.3); }
        .form-label { font-size: 0.9rem; color: #555; margin-bottom: 5px; }
        body.dark-mode .form-label { color: #b0b0b0; }
        .input-group-text { background-color: #f8f9fa; border: 1px solid #d1d9e6; border-radius: 8px 0 0 8px; color: #007bff; }
        body.dark-mode .input-group-text { background-color: #3a3a3a; border-color: #555; color: #3b82f6; }
        .btn-primary {
            background: linear-gradient(90deg, #007bff, #00c4ff); border: none; border-radius: 8px; padding: 10px 20px; font-weight: 500; transition: all 0.3s ease;
        }
        body.dark-mode .btn-primary { background: linear-gradient(90deg, #1e3a8a, #3b82f6); }
        .btn-primary:hover { background: linear-gradient(90deg, #0056b3, #0096cc); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3); }
        body.dark-mode .btn-primary:hover { background: linear-gradient(90deg, #1e40af, #60a5fa); }
        .btn { border-radius: 8px; padding: 8px 14px; font-weight: 500; letter-spacing: .2px; transition: all .2s ease; }
        .btn-sm { padding: 6px 10px; border-radius: 7px; font-weight: 500; }
        .btn:focus { box-shadow: 0 0 0 .2rem rgba(13,110,253,.25); outline: 0; }
        body.dark-mode .btn:focus { box-shadow: 0 0 0 .2rem rgba(59,130,246,.35); }
        .btn:hover { transform: translateY(-1px); }
        .btn-info, .btn-warning { border-radius: 8px; padding: 8px 15px; font-weight: 500; }
        body.dark-mode .btn-info { background-color: #1e40af; border-color: #1e40af; }
        body.dark-mode .btn-warning { background-color: #d97706; border-color: #d97706; }

        /* Outline variants - improve contrast in dark mode */
        .btn-outline-primary { color: #0d6efd; border-color: #0d6efd; }
        .btn-outline-primary:hover { background-color: #0d6efd; color: #fff; }
        body.dark-mode .btn-outline-primary { color: #93c5fd; border-color: #3b82f6; }
        body.dark-mode .btn-outline-primary:hover { background-color: #3b82f6; color:#fff; }

        .btn-outline-secondary { color: #6c757d; border-color: #6c757d; }
        .btn-outline-secondary:hover { background-color: #6c757d; color: #fff; }
        body.dark-mode .btn-outline-secondary { color: #cbd5e1; border-color: #64748b; }
        body.dark-mode .btn-outline-secondary:hover { background-color: #475569; color: #fff; border-color:#475569; }

        .btn-outline-success { color: #198754; border-color: #198754; }
        .btn-outline-success:hover { background-color: #198754; color: #fff; }
        body.dark-mode .btn-outline-success { color: #86efac; border-color: #22c55e; }
        body.dark-mode .btn-outline-success:hover { background-color: #16a34a; color: #fff; border-color:#16a34a; }

        .btn-outline-info { color: #0dcaf0; border-color: #0dcaf0; }
        .btn-outline-info:hover { background-color: #0dcaf0; color: #0b2540; }
        body.dark-mode .btn-outline-info { color: #7dd3fc; border-color: #38bdf8; }
        body.dark-mode .btn-outline-info:hover { background-color: #0ea5e9; color: #fff; border-color:#0ea5e9; }

        .btn-outline-warning { color: #ffc107; border-color: #ffc107; }
        .btn-outline-warning:hover { background-color: #ffc107; color: #0b2540; }
        body.dark-mode .btn-outline-warning { color: #fde68a; border-color: #f59e0b; }
        body.dark-mode .btn-outline-warning:hover { background-color: #d97706; color: #fff; border-color:#d97706; }

        .btn-outline-danger { color: #dc3545; border-color: #dc3545; }
        .btn-outline-danger:hover { background-color: #dc3545; color: #fff; }
        body.dark-mode .btn-outline-danger { color: #fca5a5; border-color: #ef4444; }
        body.dark-mode .btn-outline-danger:hover { background-color: #dc2626; color: #fff; border-color:#dc2626; }

        /* Soft variants (already defined) - add dark-mode versions */
        .btn-soft-success{ background: rgba(25,135,84,.08); border-color: rgba(25,135,84,.25); color:#198754; }
        .btn-soft-success:hover{ background:#198754; color:#fff; }
        .btn-soft-danger{ background: rgba(220,53,69,.08); border-color: rgba(220,53,69,.25); color:#dc3545; }
        .btn-soft-danger:hover{ background:#dc3545; color:#fff; }
        body.dark-mode .btn-soft-primary{ background: rgba(59,130,246,.15); border-color: rgba(59,130,246,.35); color:#93c5fd; }
        body.dark-mode .btn-soft-secondary{ background: rgba(100,116,139,.18); border-color: rgba(100,116,139,.35); color:#cbd5e1; }
        body.dark-mode .btn-soft-success{ background: rgba(22,163,74,.18); border-color: rgba(22,163,74,.35); color:#86efac; }
        body.dark-mode .btn-soft-danger{ background: rgba(220,38,38,.18); border-color: rgba(220,38,38,.35); color:#fca5a5; }

        /* Buttons inside tables: compact spacing and subtle shadow */
        .table .btn { box-shadow: none; }
        .table .btn:hover { box-shadow: 0 2px 6px rgba(0,0,0,.15); }
        .table .btn + .btn { margin-inline-start: .35rem; }
        .table {
            background-color: var(--table-bg); color: var(--table-color); border-color: var(--table-border-color);
            border-radius: 10px; overflow: hidden; box-shadow: none;
        }
        .table thead { background: linear-gradient(90deg, #007bff, #00c4ff); color: white; }
        body.dark-mode .table thead { background: linear-gradient(90deg, #1e3a8a, #3b82f6); }
        .table tbody tr:hover { background-color: var(--table-hover-bg); transition: background-color 0.2s ease; }
        .table-striped tbody tr:nth-of-type(odd) { background-color: var(--table-striped-bg); }
        .table th, .table td { border-color: var(--table-border-color); }
        .table td.text-center { color: #666; }
        body.dark-mode .table td.text-center { color: #b0b0b0 !important; }
        /* Global dark-mode table fixes */
        body.dark-mode .table {
            --bs-table-color: #e5e7eb;
            --bs-table-bg: #1f1f1f;
            --bs-table-striped-bg: #232323;
            --bs-table-striped-color: #e5e7eb;
            --bs-table-hover-bg: #2a2a2a;
            --bs-table-hover-color: #e5e7eb;
            --bs-table-border-color: #3a3a3a;
            --bs-table-accent-bg: transparent;
            color: var(--bs-table-color) !important;
            background-color: var(--bs-table-bg) !important;
            border-color: var(--bs-table-border-color) !important;
        }
        body.dark-mode .table > :not(caption) > * > * {
            background-color: var(--bs-table-bg) !important;
            color: var(--bs-table-color) !important;
        }
        body.dark-mode .table-striped > tbody > tr:nth-of-type(odd) > * {
            background-color: var(--bs-table-striped-bg) !important;
            color: var(--bs-table-striped-color) !important;
        }
        body.dark-mode .table-hover > tbody > tr:hover > * {
            background-color: var(--bs-table-hover-bg) !important;
            color: var(--bs-table-hover-color) !important;
        }
        .card { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); background-color: var(--card-bg) !important; transition: background-color 0.3s ease; }
        .card-body { background-color: var(--card-bg) !important; transition: background-color 0.3s ease; }
        body.dark-mode .card { box-shadow: 0 2px 10px rgba(0,0,0,0.2) !important; }
        .alert { border-radius: 8px; font-size: 0.95rem; }
        .alert-success { background-color: #e6f4ea; color: #2e7d32; border-color: #c8e6c9; }
        body.dark-mode .alert-success { background-color: #2e7d32; color: #e0e0e0; border-color: #4caf50; }
        .alert-info { background-color: #e3f2fd; color: #1565c0; border-color: #bbdefb; }
        body.dark-mode .alert-info { background-color: #1e40af; color: #e0e0e0; border-color: #3b82f6; }

        /* Additional alerts for dark mode */
        .alert-warning { background-color: #fff8e1; color: #7a5d00; border-color: #ffe082; }
        body.dark-mode .alert-warning { background-color: #d97706; color: #f3f4f6; border-color: #f59e0b; }
        .alert-danger { background-color: #ffebee; color: #b00020; border-color: #ffcdd2; }
        body.dark-mode .alert-danger { background-color: #991b1b; color: #f3f4f6; border-color: #ef4444; }

        /* Bootstrap utility overrides for dark mode */
        body.dark-mode .bg-white { background-color: #2d2d2d !important; }
        body.dark-mode .bg-light, body.dark-mode .text-bg-light { background-color: #3a3a3a !important; color: #e0e0e0 !important; border-color: #555 !important; }
        body.dark-mode .text-dark { color: #e0e0e0 !important; }
        body.dark-mode .border { border-color: #555 !important; }
        
        /* Fix text-white classes for both modes */
        .text-white { color: white !important; }
        .text-white-50 { color: rgba(255, 255, 255, 0.5) !important; }
        
        /* Ensure text-white works in light mode on gradient backgrounds */
        body:not(.dark-mode) .text-white { color: white !important; }
        body:not(.dark-mode) .text-white-50 { color: rgba(255, 255, 255, 0.7) !important; }
        
        /* Button outline fixes for both modes */
        .btn-outline-light { 
            border-color: rgba(255,255,255,0.5) !important; 
            color: white !important; 
            background-color: transparent !important; 
        }
        .btn-outline-light:hover { 
            background-color: rgba(255,255,255,0.2) !important; 
            border-color: rgba(255,255,255,0.8) !important; 
            color: white !important; 
        }
        
        /* Light mode button styling */
        body:not(.dark-mode) .btn-light { 
            background-color: rgba(255,255,255,0.9) !important; 
            border-color: rgba(255,255,255,0.9) !important; 
            color: #333 !important; 
        }
        body:not(.dark-mode) .btn-light:hover { 
            background-color: white !important; 
            border-color: white !important; 
            color: #333 !important; 
        }

        /* Components (dropdowns, modals, list groups, input groups) */
        /* Dropdowns: force dark backgrounds using Bootstrap variables */
        body.dark-mode .dropdown-menu {
            --bs-dropdown-bg: #2d2d2d;
            --bs-dropdown-color: #e5e7eb;
            --bs-dropdown-border-color: #555;
            --bs-dropdown-link-color: #e5e7eb;
            --bs-dropdown-link-hover-bg: #3a3a3a;
            --bs-dropdown-link-hover-color: #ffffff;
            --bs-dropdown-link-active-bg: #1e3a8a;
            --bs-dropdown-link-active-color: #ffffff;
            background-color: var(--bs-dropdown-bg) !important;
            color: var(--bs-dropdown-color) !important;
            border-color: var(--bs-dropdown-border-color) !important;
        }
        body.dark-mode .dropdown-item { color: var(--bs-dropdown-link-color) !important; }
        body.dark-mode .dropdown-item:hover, 
        body.dark-mode .dropdown-item:focus { background-color: var(--bs-dropdown-link-hover-bg) !important; color: var(--bs-dropdown-link-hover-color) !important; }

        body.dark-mode .modal-content { background-color: #2d2d2d; color: #e0e0e0; border-color: #555; }
        body.dark-mode .modal-header, body.dark-mode .modal-footer { border-color: #555; }

        /* List groups */
        body.dark-mode .list-group {
            --bs-list-group-bg: #2b2b2b;
            --bs-list-group-color: #e5e7eb;
            --bs-list-group-border-color: #555;
        }
        body.dark-mode .list-group-item { 
            background-color: var(--bs-list-group-bg) !important; 
            color: var(--bs-list-group-color) !important; 
            border-color: var(--bs-list-group-border-color) !important; 
        }
        body.dark-mode .list-group-item:hover { background-color: #353535 !important; }
        body.dark-mode .list-group-item.active { background: linear-gradient(90deg, #1e3a8a, #3b82f6) !important; border-color: transparent !important; color: #fff !important; }

        /* Pagination */
        body.dark-mode .page-link { background-color: #2b2b2b; color: #e5e7eb; border-color: #555; }
        body.dark-mode .page-link:hover { background-color: #3a3a3a; color: #fff; border-color: #666; }
        body.dark-mode .page-item.active .page-link { background-color: #3b82f6; border-color: #3b82f6; color: #fff; }

        /* Nav tabs/pills */
        body.dark-mode .nav-tabs { border-color: #555; }
        body.dark-mode .nav-tabs .nav-link { background-color: #2b2b2b; color: #e5e7eb; border-color: #555; }
        body.dark-mode .nav-tabs .nav-link.active { background-color: #3a3a3a; color: #fff; border-color: #666; }
        body.dark-mode .nav-pills .nav-link { color: #e5e7eb; }
        body.dark-mode .nav-pills .nav-link.active { background-color: #3b82f6; color: #fff; }

        /* Accordion */
        body.dark-mode .accordion-item { background-color: #2b2b2b; border-color: #555; }
        body.dark-mode .accordion-button { background-color: #2b2b2b; color: #e5e7eb; }
        body.dark-mode .accordion-button:not(.collapsed) { background-color: #3a3a3a; color: #fff; }
        body.dark-mode .accordion-button:focus { box-shadow: 0 0 0 .2rem rgba(59,130,246,.25); }
        body.dark-mode .accordion-body { background-color: #2b2b2b; color: #e5e7eb; }

        /* Offcanvas */
        body.dark-mode .offcanvas, 
        body.dark-mode .offcanvas-header, 
        body.dark-mode .offcanvas-body { background-color: #2b2b2b; color: #e5e7eb; border-color: #555; }

        body.dark-mode .input-group-text { background-color: #3a3a3a; color: #e0e0e0; border-color: #555; }
        body.dark-mode .form-control, body.dark-mode .form-select { background-color: #2b2b2b; color: #e0e0e0; border-color: #555; }
        body.dark-mode .form-control::placeholder, body.dark-mode .form-select::placeholder { color: #9ca3af; }
        body.dark-mode .form-control:focus, body.dark-mode .form-select:focus { border-color: #3b82f6; box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25); }
        body.dark-mode .form-check-input { background-color: #3a3a3a; border-color: #666; }
        body.dark-mode .form-check-input:checked { background-color: #3b82f6; border-color: #3b82f6; }

        /* Badges */
        body.dark-mode .badge.bg-light, body.dark-mode .badge.text-bg-light { background-color: #3a3a3a !important; color: #e0e0e0 !important; border-color: #555 !important; }
        
        /* Strong text color overrides in dark mode */
        body.dark-mode, 
        body.dark-mode p, 
        body.dark-mode li, 
        body.dark-mode span, 
        body.dark-mode small, 
        body.dark-mode label, 
        body.dark-mode .form-text,
        body.dark-mode .table, 
        body.dark-mode .table td, 
        body.dark-mode .table th { color: #e5e7eb !important; }

        body.dark-mode h1, 
        body.dark-mode h2, 
        body.dark-mode h3, 
        body.dark-mode h4, 
        body.dark-mode h5, 
        body.dark-mode h6, 
        body.dark-mode .h1, 
        body.dark-mode .h2, 
        body.dark-mode .h3, 
        body.dark-mode .h4, 
        body.dark-mode .h5, 
        body.dark-mode .h6, 
        body.dark-mode .card-title { color: #f3f4f6 !important; }

        /* Links */
        body.dark-mode a { color: #93c5fd !important; }
        body.dark-mode a:hover { color: #bfdbfe !important; }
        body.dark-mode .text-muted, 
        body.dark-mode .text-secondary, 
        body.dark-mode .muted { color: #9ca3af !important; }

        /* Navbar/Sidebar links */
        body.dark-mode .navbar, 
        body.dark-mode .navbar * { color: #e5e7eb !important; }
        body.dark-mode .sidebar a, 
        body.dark-mode .sidebar .nav-link { color: #e5e7eb !important; }
        body.dark-mode .sidebar .nav-link.active { color: #ffffff !important; }

        /* Dropdowns & menus */
        body.dark-mode .dropdown-menu { background-color: #2b2b2b !important; color: #e5e7eb !important; }
        body.dark-mode .dropdown-item { color: #e5e7eb !important; }
        body.dark-mode .dropdown-item:hover { background-color: #3a3a3a !important; color: #ffffff !important; }
        
        /* FontAwesome and Bootstrap Icons - Context aware */
        .fas, .far, .fab, .fal, .bi {
            color: var(--text-primary);
        }
        
        /* Icons on gradient backgrounds - always white */
        [style*="gradient"] .fas,
        [style*="gradient"] .far,
        [style*="gradient"] .fab,
        [style*="gradient"] .fal,
        [style*="gradient"] .bi,
        .text-white .fas,
        .text-white .far,
        .text-white .fab,
        .text-white .fal,
        .text-white .bi {
            color: var(--icon-on-gradient) !important;
        }
        
        /* Dark mode icon colors */
        body.dark-mode .fas:not(.text-white),
        body.dark-mode .far:not(.text-white),
        body.dark-mode .fab:not(.text-white),
        body.dark-mode .fal:not(.text-white),
        body.dark-mode .bi:not(.text-white) {
            color: var(--text-primary);
        }
        
        /* Button icons inherit button color */
        .btn .fas, .btn .far, .btn .fab, .btn .fal, .btn .bi {
            color: inherit !important;
        }
    </style>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
</head>
<body>
    <!-- Sidebar collapsed by default -->
    <div class="sidebar collapsed" id="sidebar">
        <div class="d-flex align-items-center">
            <button class="toggle-btn" id="toggleSidebar"><i class="bi bi-list"></i></button>
            <a class="sidebar-brand" href="{% url 'manager:patient_list' %}">
                <span>{% if settings.system_name %}{{ settings.system_name }}{% else %}{% trans "Patient Management" %}{% endif %}</span>
            </a>
        </div>

        {# مُبدّل اللغة #}
        <form action="{% url 'set_language' %}" method="post" class="px-3 mb-2">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.get_full_path }}">
          <select name="language" class="form-select form-select-sm" onchange="this.form.submit()">
            <option value="ar" {% if LANGUAGE_CODE == 'ar' %}selected{% endif %}>العربية</option>
            <option value="en" {% if LANGUAGE_CODE == 'en' %}selected{% endif %}>English</option>
          </select>
        </form>

        <nav class="nav flex-column">
            {% if user.is_authenticated %}
                {% if user.role == 'super_admin' %}
                    <a class="nav-link {% if request.resolver_match.url_name == 'hospital_list' %}active{% endif %}" href="{% url 'superadmin:hospital_list' %}">
                        <i class="bi bi-building me-2"></i><span>{% trans "Hospitals" %}</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'create_hospital' %}active{% endif %}" href="{% url 'superadmin:create_hospital' %}">
                        <i class="bi bi-plus-circle me-2"></i><span>{% trans "Create Hospital" %}</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'system_settings' %}active{% endif %}" href="{% url 'superadmin:system_settings' %}">
                        <i class="bi bi-gear me-2"></i><span>{% trans "Settings" %}</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'user_list' %}active{% endif %}" href="{% url 'superadmin:user_list' %}">
                        <i class="bi bi-people me-2"></i><span>{% trans "Users" %}</span>
                    </a>
                {% elif user.role == 'hospital_manager' %}
                    <a class="nav-link {% if request.resolver_match.url_name == 'patient_list' %}active{% endif %}" href="{% url 'manager:patient_list' %}">
                        <i class="bi bi-person-lines-fill me-2"></i><span>{% trans "Patients" %}</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'admission_list' %}active{% endif %}" href="{% url 'manager:admission_list' %}">
                        <i class="bi bi-clipboard-check me-2"></i><span>{% trans "Admissions" %}</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'appointment_list' %}active{% endif %}" href="{% url 'manager:appointment_list' %}">
                        <i class="bi bi-calendar me-2"></i><span>{% trans "Appointments" %}</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'visit_list' %}active{% endif %}" href="{% url 'manager:visit_list' %}">
                        <i class="bi bi-clipboard me-2"></i><span>{% trans "Visits" %}</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'clinic_list' %}active{% endif %}" href="{% url 'manager:clinic_list' %}">
                        <i class="bi bi-building me-2"></i><span>{% trans "Outpatient" %}</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'department_list' %}active{% endif %}" href="{% url 'manager:department_list' %}">
                        <i class="bi bi-building me-2"></i><span>{% trans "Departments" %}</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'staff_home' %}active{% endif %}" href="{% url 'hr:staff_home' %}">
                        <i class="bi bi-people me-2"></i><span>{% trans "Staff" %}</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'bed_list' %}active{% endif %}" href="{% url 'manager:bed_list' %}">
                        <i class="fas fa-bed me-2"></i><span>{% trans "Beds" %}</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'emergency_department_list' %}active{% endif %}" href="{% url 'manager:emergency_department_list' %}">
                        <i class="bi bi-exclamation-triangle me-2"></i><span>{% trans "Emergency Dept" %}</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'surgical_operations_department_list' %}active{% endif %}" href="{% url 'manager:surgical_operations_department_list' %}">
                        <i class="bi bi-scissors me-2"></i><span>{% trans "Surgical Ops" %}</span>
                    </a>

                    <!-- Maintenance Submenu -->
                    <a class="nav-link" href="#" data-bs-toggle="collapse" data-bs-target="#maintenanceSubmenu" aria-expanded="false" aria-controls="maintenanceSubmenu">
                        <i class="fas fa-tools me-2"></i><span>{% trans "Maintenance" %}</span>
                    </a>
                    <div class="collapse" id="maintenanceSubmenu">
                        <nav class="nav flex-column" style="padding-left: 20px;">
                            <a class="nav-link" href="{% url 'maintenance:maintenance_index' %}"><i class="fas fa-tachometer-alt me-2"></i><span>لوحة التحكم</span></a>
                            <a class="nav-link" href="{% url 'maintenance:device_list' %}"><i class="fas fa-laptop-medical me-2"></i><span>إدارة الأجهزة</span></a>
                            <a class="nav-link" href="{% url 'maintenance:cmms:service_request_list' %}"><i class="fas fa-clipboard-list me-2"></i><span>طلبات الخدمة</span></a>
                            <a class="nav-link" href="{% url 'maintenance:cmms:work_order_list' %}"><i class="fas fa-tasks me-2"></i><span>أوامر العمل</span></a>
                            <a class="nav-link" href="{% url 'maintenance:cmms:pm_schedule_list' %}"><i class="fas fa-calendar-check me-2"></i><span>الصيانة الوقائية</span></a>
                            <a class="nav-link" href="{% url 'maintenance:cmms:job_plan_list' %}"><i class="fas fa-clipboard-list me-2"></i><span>خطط العمل</span></a>
                            <a class="nav-link" href="{% url 'maintenance:cmms:sla_list' %}"><i class="fas fa-handshake me-2"></i><span>اتفاقيات الخدمة</span></a>
                            <a class="nav-link" href="{% url 'maintenance:calibration_tracking' %}"><i class="fas fa-balance-scale me-2"></i><span>المعايرة</span></a>
                            <a class="nav-link" href="{% url 'maintenance:spare_parts:downtime_list' %}"><i class="fas fa-clock me-2"></i><span>سجلات التوقف</span></a>
                            <a class="nav-link" href="{% url 'maintenance:custody_dashboard' %}"><i class="fas fa-cog me-2"></i><span>العهده</span></a>
                            <!-- QR Code System Submenu -->
                            <a class="nav-link" href="#" data-bs-toggle="collapse" data-bs-target="#qrSystemSubmenu" aria-expanded="false" aria-controls="qrSystemSubmenu">
                                <i class="fas fa-qrcode me-2"></i><span>نظام QR/Barcode</span>
                            </a>
                            <div class="collapse" id="qrSystemSubmenu">
                                <nav class="nav flex-column" style="padding-left: 40px;">
                                    <!-- QR Dashboard & Main Pages -->
                                    <a class="nav-link" href="{% url 'maintenance:scan_session_page' %}"><i class="fas fa-camera me-2"></i><span>جلسة المسح</span></a>
                                    <a class="nav-link" href="{% url 'maintenance:qr_test_page' %}"><i class="fas fa-vial me-2"></i><span>اختبار النظام</span></a>
                                    <a class="nav-link" href="{% url 'maintenance:device_usage_logs' %}"><i class="fas fa-history me-2"></i><span>سجلات الاستخدام</span></a>
                                    
                                    <!-- Operations Management -->
                                    <div class="nav-divider my-2" style="border-top: 1px solid rgba(255,255,255,0.1);"></div>
                                    <small class="text-white-50 px-3 mb-1" style="font-size: 0.75rem;">إدارة العمليات</small>
                                    <a class="nav-link" href="{% url 'maintenance:operations_list' %}"><i class="fas fa-cogs me-2"></i><span>قائمة العمليات</span></a>
                                    <a class="nav-link" href="{% url 'maintenance:operation_create' %}"><i class="fas fa-plus me-2"></i><span>إنشاء عملية</span></a>
                                    <a class="nav-link" href="{% url 'maintenance:sessions_list' %}"><i class="fas fa-list me-2"></i><span>جلسات المسح</span></a>
                                    <a class="nav-link" href="{% url 'maintenance:executions_list' %}"><i class="fas fa-play me-2"></i><span>تنفيذ العمليات</span></a>
                                    
                                    <!-- Device Operations -->
                                    <div class="nav-divider my-2" style="border-top: 1px solid rgba(255,255,255,0.1);"></div>
                                    <small class="text-white-50 px-3 mb-1" style="font-size: 0.75rem;">عمليات الأجهزة</small>
                                    <a class="nav-link" href="{% url 'maintenance:all_devices_transfer' %}"><i class="fas fa-exchange-alt me-2"></i><span>نقل الأجهزة</span></a>
                                    <a class="nav-link" href="{% url 'maintenance:transfer_requests_list' %}"><i class="fas fa-clipboard-list me-2"></i><span>طلبات النقل</span></a>
                                </nav>
                            </div>
                            <a class="nav-link" href="{% url 'maintenance:spare_parts:spare_part_list' %}"><i class="fas fa-cogs me-2"></i><span>قطع الغيار</span></a>
                        </nav>
                    </div>

                    <!-- Laboratory -->
                    <a class="nav-link {% if request.resolver_match.namespace == 'laboratory' and request.resolver_match.url_name == 'dashboard' %}active{% endif %}"
                       href="{% url 'laboratory:dashboard' %}">
                         <i class="bi bi-beaker me-2"></i><span>{% trans "Lab Dashboard" %}</span>
                    </a>

                    <!-- Pharmacy link -->
                    <a class="nav-link {% if request.resolver_match.url_name == 'dispense_action' %}active{% endif %}" href="{% url 'manager:dispense_action' %}">
                        <i class="fas fa-pills me-2"></i><span>{% trans "Pharmacy" %}</span>
                    </a>

                    <!-- Manage Hospital Submenu -->
                    <a class="nav-link" href="#" data-bs-toggle="collapse" data-bs-target="#manageHospitalSubmenu" aria-expanded="false" aria-controls="manageHospitalSubmenu">
                        <i class="bi bi-building-fill-gear me-2"></i><span>{% trans "Manage Hospital" %}</span>
                    </a>
                    <div class="collapse" id="manageHospitalSubmenu">
                        <nav class="nav flex-column" style="padding-left: 20px;">
                            <a class="nav-link" href="{% url 'manager:building_list'%}"><i class="bi bi-building me-2"></i><span>{% trans "Buildings" %}</span></a>
                            <a class="nav-link" href="{% url 'manager:floor_list'%}"><i class="bi bi-ladder me-2"></i><span>{% trans "Floors" %}</span></a>
                            <a class="nav-link" href="{% url 'manager:ward_list'%}"><i class="bi bi-door-closed me-2"></i><span>{% trans "Wards" %}</span></a>
                            <a class="nav-link" href="{% url 'manager:department_list'%}"><i class="bi bi-building-fill-gear me-2"></i><span>{% trans "Departments" %}</span></a>
                            <a class="nav-link" href="{% url 'manager:room_list'%}"><i class="bi bi-house-door me-2"></i><span>{% trans "Rooms" %}</span></a>
                            <a class="nav-link" href="{% url 'manager:hr_user_add'%}"><i class="bi bi-person-plus me-2"></i><span>{% trans "Add HR User" %}</span></a>
                        </nav>
                    </div>
                {% elif user.role == 'hr' %}
                    <a class="nav-link {% if request.resolver_match.url_name == 'staff_list' %}active{% endif %}" href="{% url 'hr:staff_list' %}">
                        <i class="bi bi-people me-2"></i><span>{% trans "Staff" %}</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'attendance_list' %}active{% endif %}" href="{% url 'hr:attendance_list' %}">
                        <i class="bi bi-clock me-2"></i><span>{% trans "Attendance" %}</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'payroll_list' %}active{% endif %}" href="{% url 'hr:payroll_list' %}">
                        <i class="bi bi-cash me-2"></i><span>{% trans "Payroll" %}</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'leave_request_list' %}active{% endif %}" href="{% url 'hr:leave_request_list' %}">
                        <i class="bi bi-calendar-x me-2"></i><span>{% trans "Leave Requests" %}</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'schedule_list' %}active{% endif %}" href="{% url 'hr:schedule_list' %}">
                        <i class="bi bi-calendar me-2"></i><span>{% trans "Schedules" %}</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'shift_assignment_list' %}active{% endif %}" href="{% url 'hr:shift_assignment_list' %}">
                        <i class="bi bi-calendar-check me-2"></i><span>{% trans "Shift Assignments" %}</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'shift_swap_request_list' %}active{% endif %}" href="{% url 'hr:shift_swap_request_list' %}">
                        <i class="bi bi-arrow-left-right me-2"></i><span>{% trans "Shift Swaps" %}</span>
                    </a>
                {% elif user.role == 'inventory_manager' %}
                    <!-- Inventory Manager Navigation -->
                    <a class="nav-link {% if request.resolver_match.url_name == 'inventory_dashboard' %}active{% endif %}" href="{% url 'maintenance:spare_parts:inventory_dashboard' %}">
                        <i class="fas fa-warehouse me-2"></i><span>لوحة تحكم المخزون</span>
                    </a>
                    
                    <a class="nav-link {% if request.resolver_match.url_name == 'pending_' %}active{% endif %}" href="{% url 'maintenance:spare_parts:pending_requests' %}">
                        <i class="fas fa-clock me-2"></i><span>الطلبات المعلقة</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'spare_part_list' %}active{% endif %}" href="{% url 'maintenance:spare_parts:spare_part_list' %}">
                        <i class="fas fa-cogs me-2"></i><span>قطع الغيار</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'spare_part_transaction_list' %}active{% endif %}" href="{% url 'maintenance:spare_parts:spare_part_transaction_list' %}">
                        <i class="fas fa-exchange-alt me-2"></i><span>معاملات المخزون</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'supplier_list' %}active{% endif %}" href="{% url 'maintenance:spare_parts:supplier_list' %}">
                        <i class="fas fa-truck me-2"></i><span>الموردين</span>
                    </a>
                {% elif user.role == 'technician' %}
                    <!-- Technician Navigation -->
                    <a class="nav-link {% if request.resolver_match.url_name == 'technician_dashboard' %}active{% endif %}" href="{% url 'maintenance:cmms:technician_dashboard' %}">
                        <i class="fas fa-tachometer-alt me-2"></i><span>{% trans "Dashboard" %}</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'work_order_list' %}active{% endif %}" href="{% url 'maintenance:cmms:work_order_list' %}">
                        <i class="fas fa-tasks me-2"></i><span>{% trans "Work Orders" %}</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'service_request_list' %}active{% endif %}" href="{% url 'maintenance:cmms:service_request_list' %}">
                        <i class="fas fa-clipboard-list me-2"></i><span>{% trans "Service Requests" %}</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'my_requests' %}active{% endif %}" href="{% url 'maintenance:spare_parts:my_requests' %}">
                        <i class="fas fa-list me-2"></i><span>طلبات قطع الغيار</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'request_spare_part' %}active{% endif %}" href="{% url 'maintenance:spare_parts:request_spare_part' %}">
                        <i class="fas fa-plus-circle me-2"></i><span>طلب قطعة غيار</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'leave_request_list' %}active{% endif %}" href="{% url 'staff:leave_request_list' %}">
                        <i class="bi bi-calendar-x me-2"></i><span>{% trans "Leave Requests" %}</span>
                    </a>
                {% elif user.role in 'doctor,nurse,receptionist,pharmacist' %}
                    <a class="nav-link {% if request.resolver_match.url_name == 'patient_list' %}active{% endif %}" href="{% url 'staff:patient_list' %}">
                        <i class="bi bi-person-lines-fill me-2"></i><span>{% trans "Patients" %}</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'admission_list' %}active{% endif %}" href="{% url 'manager:admission_list' %}">
                        <i class="bi bi-clipboard-check me-2"></i><span>{% trans "Admissions" %}</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'clinic_list' %}active{% endif %}" href="{% url 'staff:clinic_list' %}">
                        <i class="bi bi-building me-2"></i><span>{% trans "Clinics" %}</span>
                    </a>
                    <!-- Pharmacy link for staff -->
                    <a class="nav-link {% if request.resolver_match.url_name == 'dispense_action' %}active{% endif %}" href="{% url 'manager:dispense_action' %}">
                        <i class="fas fa-pills me-2"></i><span>{% trans "Pharmacy" %}</span>
                    </a>
                    <a class="nav-link {% if request.resolver_match.url_name == 'leave_request_list' %}active{% endif %}" href="{% url 'staff:leave_request_list' %}">
                        <i class="bi bi-calendar-x me-2"></i><span>{% trans "Leave Requests" %}</span>
                    </a>
                    {% if user.role == 'doctor' %}
                        <a class="nav-link {% if request.resolver_match.url_name == 'shift_assignment_list' %}active{% endif %}" href="{% url 'staff:shift_assignment_list' %}">
                            <i class="bi bi-calendar-check me-2"></i><span>{% trans "My Shifts" %}</span>
                        </a>
                        <a class="nav-link {% if 'work-orders' in request.path %}active{% endif %}" href="{% url 'maintenance:cmms:work_order_list' %}">
                            <i class="fas fa-clipboard-list me-2"></i><span>{% trans "Work Orders" %}</span>
                        </a>
                        <a class="nav-link {% if request.resolver_match.url_name == 'shift_swap_request_list' %}active{% endif %}" href="{% url 'staff:shift_swap_request_list' %}">
                            <i class="bi bi-arrow-left-right me-2"></i><span>{% trans "Shift Swaps" %}</span>
                        </a>
                    {% endif %}
                {% endif %}
                <form action="{% url 'superadmin:logout' %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="nav-link {% if request.resolver_match.url_name == 'logout' %}active{% endif %}" style="background:none;border:none;color:white;padding:12px 20px;display:flex;align-items:center;width:100%;text-align:left;">
                        <i class="bi bi-box-arrow-right me-2"></i><span>{% trans "Logout" %}</span>
                    </button>
                </form>
                <!-- Dark Mode Toggle (Icon Only) -->
                <button class="mode-toggle" id="toggleDarkMode" title="{% trans 'Toggle dark mode' %}">
                    <i class="bi bi-moon-stars-fill"></i>
                </button>
            {% else %}
                <a class="nav-link {% if request.resolver_match.url_name == 'login' %}active{% endif %}" href="{% url 'superadmin:login' %}">
                    <i class="bi bi-box-arrow-in-right me-2"></i><span>{% trans "Login" %}</span>
                </a>
            {% endif %}
        </nav>
    </div>

    <div class="main-content collapsed" id="mainContent">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    <i class="bi {% if message.tags == 'success' %}bi-check-circle-fill{% else %}bi-info-circle-fill{% endif %} me-2"></i>{{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="{% trans 'Close' %}"></button>
                </div>
            {% endfor %}
        {% endif %}
        {% block content %}{% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Sidebar Toggle
        document.getElementById('toggleSidebar').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('collapsed');
            updateSidebarTooltips();
        });

        // Dark Mode Toggle
        document.addEventListener('DOMContentLoaded', function() {
            const body = document.body;
            const toggleDarkModeBtn = document.getElementById('toggleDarkMode');
            const darkModeIcon = toggleDarkModeBtn.querySelector('i');

            // Check saved dark mode preference
            if (localStorage.getItem('darkMode') === 'enabled') {
                body.classList.add('dark-mode');
                darkModeIcon.classList.replace('bi-moon-stars-fill', 'bi-sun-fill');
            }

            // Toggle dark mode on click
            toggleDarkModeBtn.addEventListener('click', function() {
                body.classList.toggle('dark-mode');
                if (body.classList.contains('dark-mode')) {
                    localStorage.setItem('darkMode', 'enabled');
                    darkModeIcon.classList.replace('bi-moon-stars-fill', 'bi-sun-fill');
                } else {
                    localStorage.setItem('darkMode', 'disabled');
                    darkModeIcon.classList.replace('bi-sun-fill', 'bi-moon-stars-fill');
                }
            });

            // Initialize sidebar tooltips based on current state
            updateSidebarTooltips();
        });

        // Enable tooltips for collapsed sidebar so icons have labels
        let sidebarTooltips = [];
        function updateSidebarTooltips() {
            const sidebar = document.getElementById('sidebar');
            const links = sidebar.querySelectorAll('.nav-link');
            // dispose old tooltips
            sidebarTooltips.forEach(t => t.dispose && t.dispose());
            sidebarTooltips = [];
            if (sidebar.classList.contains('collapsed')) {
                links.forEach(link => {
                    // Skip collapse triggers (e.g., Manage Hospital) to avoid breaking Bootstrap collapse
                    const isCollapseTrigger = (link.getAttribute('data-bs-toggle') === 'collapse') || link.hasAttribute('data-bs-target');
                    if (isCollapseTrigger) { return; }
                    const label = link.querySelector('span');
                    if (!label) return;
                    link.setAttribute('data-bs-toggle', 'tooltip');
                    link.setAttribute('data-bs-placement', 'right');
                    link.setAttribute('title', label.textContent.trim());
                    const tt = new bootstrap.Tooltip(link);
                    sidebarTooltips.push(tt);
                });
            } else {
                links.forEach(link => {
                    // Only remove tooltip-specific attributes; keep collapse toggles intact
                    if (link.getAttribute('data-bs-toggle') === 'tooltip') {
                        link.removeAttribute('data-bs-toggle');
                    }
                    link.removeAttribute('data-bs-placement');
                    // Remove title only if we previously set it from the label
                    const label = link.querySelector('span');
                    if (label && link.getAttribute('title') === label.textContent.trim()) {
                        link.removeAttribute('title');
                    }
                });
            }
        }

        // Ensure submenu (Manage Hospital) works when sidebar is collapsed:
        // If collapsed, expand sidebar first then open the submenu.
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const collapseLinks = document.querySelectorAll('#sidebar .nav-link[data-bs-toggle="collapse"]');
            collapseLinks.forEach(link => {
                link.addEventListener('click', function(e){
                    const targetSel = link.getAttribute('data-bs-target');
                    const targetEl = targetSel ? document.querySelector(targetSel) : null;
                    if (!targetEl) { return; }
                    // If sidebar is collapsed: expand first then show submenu
                    if (sidebar.classList.contains('collapsed')) {
                        e.preventDefault();
                        sidebar.classList.remove('collapsed');
                        mainContent.classList.remove('collapsed');
                        const c = bootstrap.Collapse.getOrCreateInstance(targetEl, { toggle: false });
                        setTimeout(() => c.show(), 100);
                        updateSidebarTooltips();
                        return;
                    }
                    // If already expanded, ensure Bootstrap toggles reliably
                    // Prevent default only if href is '#'
                    if (link.getAttribute('href') === '#') { e.preventDefault(); }
                    const c = bootstrap.Collapse.getOrCreateInstance(targetEl, { toggle: false });
                    c.toggle();
                });
            });
        });
    </script>
    
    <!-- Floating QR Scanner Button -->
    <div id="floatingQRButton" style="position: fixed; bottom: 30px; right: 30px; z-index: 9999;">
        <a href="{% url 'maintenance:scan_session_page' %}" 
           class="btn btn-primary btn-lg rounded-circle shadow-lg" 
           style="width: 70px; height: 70px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
            <i class="fas fa-qrcode" style="font-size: 1.8rem;"></i>
        </a>
        <div class="text-center mt-2">
            <small class="text-muted" style="font-size: 0.75rem;">QR Scanner</small>
        </div>
    </div>
    
    <style>
    #floatingQRButton {
        animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
    }
    
    #floatingQRButton a:hover {
        transform: scale(1.1);
        transition: transform 0.3s ease;
    }
    
    #floatingQRButton a {
        transition: all 0.3s ease;
    }
    
    /* Hide on mobile landscape to avoid blocking content */
    @media (max-height: 500px) {
        #floatingQRButton {
            bottom: 10px !important;
            right: 10px !important;
        }
        #floatingQRButton a {
            width: 50px !important;
            height: 50px !important;
        }
        #floatingQRButton i {
            font-size: 1.3rem !important;
        }
        #floatingQRButton small {
            display: none;
        }
    }
    </style>
</body>
</html>