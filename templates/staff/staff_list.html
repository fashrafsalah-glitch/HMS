{% extends "base.html" %}
{% block title %}Staff{% endblock %}
{% block content %}

<div class="container my-4">
    <h2 class="mb-4 text-center"><i class="bi bi-people me-2"></i>{% if is_department_view and selected_department %}
<div class="alert alert-info">
    <i class="bi bi-building"></i>
    <span class="fs-5">قائمة موظفي قسم:</span>
    <strong class="fs-5">{{ selected_department.name }}</strong>
</div>
{% endif %}</h2>
    {% if not is_department_view %}
<div class="text-end mb-3">
    <a href="{% url 'hr:staff_create' %}" class="btn btn-primary">
        <i class="bi bi-plus-circle me-2"></i> إضافة موظف جديد
    </a>
</div>
{% endif %}
{% if near_expiry or about_to_expire %}
<div class="alert alert-warning">
  <h5>⚠️ تنبيهات تراخيص مزاولة المهنة:</h5>
  {% if about_to_expire %}
    <strong>ستنتهي خلال أسبوع:</strong>
    <ul>
      {% for s in about_to_expire %}
        <li>{{ s.get_full_name }} (ينتهي في {{ s.practice_permits.latest.expiry_date }})</li>
      {% endfor %}
    </ul>
  {% endif %}
  {% if near_expiry %}
    <strong>ستنتهي خلال شهر:</strong>
    <ul>
      {% for s in near_expiry %}
        <li>{{ s.get_full_name }} (ينتهي في {{ s.practice_permits.latest.expiry_date }})</li>
      {% endfor %}
    </ul>
  {% endif %}
</div>
{% endif %}
     <h5 class="text-muted mb-3">
    عدد الموظفين: {{ staff|length }}
</h5>
    <!-- قبل جدول الموظفين -->
<form method="get" class="row mb-4 g-2">
    <div class="col-md-4">
        <select name="department" class="form-select">
            <option value="">-- اختر القسم --</option>
            {% for dept in departments %}
                <option value="{{ dept.id }}" {% if request.GET.department == dept.id|stringformat:"s" %}selected{% endif %}>
                    {{ dept.name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-4">
        <select name="role" class="form-select">
            <option value="">-- اختر الدور الوظيفي --</option>
            {% for r in roles %}
                <option value="{{ r }}" {% if request.GET.role == r %}selected{% endif %}>
                    {{ r|title }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-4 text-end">
        <button type="submit" class="btn btn-outline-primary">
            <i class="bi bi-funnel me-1"></i> فلترة
        </button>
        <a href="{% url 'hr:staff_list' %}" class="btn btn-outline-secondary">إلغاء</a>
    </div>
</form>
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th><i class="bi bi-person me-1"></i>Name</th>
                    <th><i class="bi bi-briefcase me-1"></i>Role</th>
                    <th><i class="bi bi-briefcase me-1"></i>Department</th>
                    <th><i class="bi bi-card-text me-1"></i>National ID</th>
                    <th><i class="bi bi-calendar me-1"></i>Hire Date</th>
                    <th><i class="bi bi-gear me-1"></i>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for staff in staff %}
                <tr>
                    <td>{{ staff.first_name }} {{ staff.last_name }}</td>
                    <td>{{ staff.get_role_display }}</td>
                    <td>
                       {% for dept in staff.departments.all %}
                     <span class="badge bg-secondary">{{ dept.name }}</span>{% if not forloop.last %} {% endif %}
                       {% empty %}
                          <span class="text-muted">لا قسم</span>
                        {% endfor %}
                          </td>
                    <td>{{ staff.national_id }}</td>
                    <td>{{ staff.hire_date }}</td>
                    <td>
    <a href="{% url 'hr:staff_detail' staff.pk %}" class="btn btn-sm btn-secondary me-1">
        <i class="bi bi-eye"></i> تفاصيل
    </a>
    {% if not is_department_view %}
    <a href="{% url 'hr:staff_edit' staff.pk %}" class="btn btn-sm btn-info me-1"><i class="bi bi-pencil"></i> تعديل</a>
    <a href="{% url 'hr:staff_delete' staff.pk %}" class="btn btn-sm btn-warning"><i class="bi bi-trash"></i> حذف</a>
    {% endif %}
</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center text-muted py-4">
                        <i class="bi bi-person-x-fill me-2" style="font-size: 1.5rem;"></i>No staff found.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}