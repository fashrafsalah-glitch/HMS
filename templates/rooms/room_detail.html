{% extends "base.html" %}
{% block title %}Room {{ room.number }} Details{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-house-door me-2"></i>Room {{ room.number }} Details
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted">Basic Information</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Number:</strong></td>
                                    <td>{{ room.number }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Type:</strong></td>
                                    <td>{{ room.get_room_type_display }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Status:</strong></td>
                                    <td>
                                        <span class="badge 
                                            {% if room.status == 'available' %}bg-success
                                            {% elif room.status == 'occupied' %}bg-warning
                                            {% elif room.status == 'maintenance' %}bg-danger
                                            {% else %}bg-secondary{% endif %}">
                                            {{ room.get_status_display }}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Capacity:</strong></td>
                                    <td>{{ room.capacity }} patients</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Location</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Department:</strong></td>
                                    <td>{{ room.department.name }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Ward:</strong></td>
                                    <td>{{ room.ward.name }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Floor:</strong></td>
                                    <td>{{ room.ward.floor.name }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Building:</strong></td>
                                    <td>{{ room.ward.floor.building.name }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Beds in Room -->
            {% if beds %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-bed me-2"></i>Beds in Room ({{ beds.count }})</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for bed in beds %}
                        <div class="col-md-6 mb-3">
                            <div class="card border-secondary">
                                <div class="card-body">
                                    <h6>Bed {{ bed.bed_number }}</h6>
                                    <p class="mb-1"><strong>Type:</strong> {{ bed.get_bed_type_display }}</p>
                                    <p class="mb-1"><strong>Status:</strong> 
                                        <span class="badge 
                                            {% if bed.status == 'available' %}bg-success
                                            {% elif bed.status == 'occupied' %}bg-warning
                                            {% else %}bg-secondary{% endif %}">
                                            {{ bed.get_status_display }}
                                        </span>
                                    </p>
                                    {% if bed.qr_code %}
                                    <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#bedQrModal{{ bed.id }}">
                                        <i class="bi bi-qr-code"></i> View QR
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Devices in Room -->
            {% if devices %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-cpu me-2"></i>Devices in Room ({{ devices.count }})</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Device Name</th>
                                    <th>Serial Number</th>
                                    <th>Status</th>
                                    <th>In Use</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for device in devices %}
                                <tr>
                                    <td>{{ device.name }}</td>
                                    <td>{{ device.serial_number }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if device.status == 'working' %}bg-success
                                            {% elif device.status == 'needs_maintenance' %}bg-warning
                                            {% elif device.status == 'out_of_order' %}bg-danger
                                            {% else %}bg-secondary{% endif %}">
                                            {{ device.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if device.in_use %}
                                            <span class="badge bg-info">In Use</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Available</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- QR Code Panel -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-qr-code me-2"></i>Room QR Code</h5>
                </div>
                <div class="card-body text-center">
                    {% if room.qr_code %}
                        <div class="mb-3">
                            <img src="{{ room.qr_code.url }}" alt="Room QR Code" class="img-fluid border" style="max-width: 250px;">
                        </div>
                        <div class="alert alert-light">
                            <small class="text-muted">
                                <strong>QR Token:</strong><br>
                                <code>{{ room.qr_token }}</code>
                            </small>
                        </div>
                        <div class="d-grid gap-2">
                            <a href="{{ room.qr_code.url }}" download="room_{{ room.number }}_qr.png" class="btn btn-success">
                                <i class="bi bi-download me-2"></i>Download QR
                            </a>
                            <button class="btn btn-outline-primary" onclick="printQR()">
                                <i class="bi bi-printer me-2"></i>Print QR
                            </button>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            No QR code generated for this room yet.
                        </div>
                        <a href="{% url 'manager:generate_qr' 'room' room.id %}" class="btn btn-primary">
                            <i class="bi bi-qr-code me-2"></i>Generate QR Code
                        </a>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-lightning me-2"></i>Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'manager:room_list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Back to Rooms
                        </a>
                        {% if room.qr_code %}
                        <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#scanModal">
                            <i class="bi bi-camera me-2"></i>Scan Operations
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bed QR Modals -->
{% for bed in beds %}
{% if bed.qr_code %}
<div class="modal fade" id="bedQrModal{{ bed.id }}" tabindex="-1" aria-labelledby="bedQrModalLabel{{ bed.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bedQrModalLabel{{ bed.id }}">
                    <i class="bi bi-qr-code me-2"></i>QR Code - Bed {{ bed.bed_number }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <img src="{{ bed.qr_code.url }}" alt="Bed QR Code" class="img-fluid" style="max-width: 300px;">
                </div>
                <div class="alert alert-info">
                    <strong>Bed Details:</strong><br>
                    Number: {{ bed.bed_number }}<br>
                    Type: {{ bed.get_bed_type_display }}<br>
                    Room: {{ room.number }}<br>
                    Status: {{ bed.get_status_display }}
                </div>
                <div class="d-grid gap-2">
                    <a href="{{ bed.qr_code.url }}" download="bed_{{ bed.bed_number }}_qr.png" class="btn btn-success">
                        <i class="bi bi-download me-2"></i>Download QR Code
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}

<!-- Scan Operations Modal -->
<div class="modal fade" id="scanModal" tabindex="-1" aria-labelledby="scanModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scanModalLabel">
                    <i class="bi bi-camera me-2"></i>Room Operations
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Available operations for Room {{ room.number }}:</p>
                <div class="list-group">
                    <div class="list-group-item">
                        <i class="bi bi-brush me-2"></i>Room Cleaning
                    </div>
                    <div class="list-group-item">
                        <i class="bi bi-tools me-2"></i>Room Maintenance
                    </div>
                    <div class="list-group-item">
                        <i class="bi bi-clipboard-check me-2"></i>Room Inspection
                    </div>
                    <div class="list-group-item">
                        <i class="bi bi-arrow-repeat me-2"></i>Status Update
                    </div>
                </div>
                <div class="mt-3">
                    <a href="/maintenance/" class="btn btn-primary">
                        <i class="bi bi-camera me-2"></i>Go to QR Scanner
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function printQR() {
    const qrImage = document.querySelector('img[alt="Room QR Code"]');
    if (qrImage) {
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>Room {{ room.number }} QR Code</title>
                    <style>
                        body { text-align: center; font-family: Arial, sans-serif; }
                        img { max-width: 300px; margin: 20px; }
                        .info { margin: 20px; }
                    </style>
                </head>
                <body>
                    <h2>Room {{ room.number }} QR Code</h2>
                    <img src="${qrImage.src}" alt="Room QR Code">
                    <div class="info">
                        <p><strong>Room:</strong> {{ room.number }}</p>
                        <p><strong>Type:</strong> {{ room.get_room_type_display }}</p>
                        <p><strong>Department:</strong> {{ room.department.name }}</p>
                        <p><strong>Ward:</strong> {{ room.ward.name }}</p>
                    </div>
                </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    }
}
</script>
{% endblock %}
