{% extends "base.html" %}
{% load static %}

{% block title %}سجل نقل الملحق - {{ accessory.name }}{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-1">سجل نقل الملحق: {{ accessory.name }}</h3>
      <small class="text-muted">الجهاز الحالي: {{ accessory.device.name }} - {{ accessory.device.department }}</small>
    </div>
    <div class="d-flex gap-2">
      <a href="{% url 'maintenance:accessory_detail' accessory.id %}" class="btn btn-outline-dark">
        <i class="bi bi-arrow-right me-1"></i> عودة لتفاصيل الملحق
      </a>
      <a href="{% url 'maintenance:accessory_transfer' accessory.id %}" class="btn btn-primary">
        <i class="bi bi-arrow-left-right me-1"></i> طلب نقل جديد
      </a>
    </div>
  </div>

  <!-- Transfer Requests -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">طلبات النقل</h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>التاريخ</th>
              <th>من</th>
              <th>إلى</th>
              <th>طلب بواسطة</th>
              <th>الحالة</th>
              <th>السبب</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody>
            {% for request in transfer_requests %}
              <tr>
                <td>{{ request.requested_at|date:"Y-m-d H:i" }}</td>
                <td>
                  {% if request.from_device %}
                    <strong>{{ request.from_device.name }}</strong><br>
                    <small class="text-muted">{{ request.from_department }} - {{ request.from_room }}</small>
                  {% else %}
                    {{ request.from_department }} - {{ request.from_room }}
                  {% endif %}
                </td>
                <td>
                  {% if request.to_device %}
                    <strong>{{ request.to_device.name }}</strong><br>
                    <small class="text-muted">{{ request.to_department }} - {{ request.to_room }}</small>
                  {% else %}
                    {{ request.to_department }}{% if request.to_room %} - {{ request.to_room }}{% endif %}
                  {% endif %}
                </td>
                <td>{{ request.requested_by }}</td>
                <td>
                  {% if request.is_approved %}
                    <span class="badge bg-success">موافق عليه</span>
                    {% if request.approved_at %}
                      <br><small class="text-muted">{{ request.approved_at|date:"Y-m-d H:i" }}</small>
                    {% endif %}
                  {% elif request.rejection_reason %}
                    <span class="badge bg-danger">مرفوض</span>
                    <br><small class="text-muted">{{ request.rejection_reason }}</small>
                  {% else %}
                    <span class="badge bg-warning">في انتظار الموافقة</span>
                  {% endif %}
                </td>
                <td>{{ request.reason|default:"-" }}</td>
                <td>
                  {% if not request.is_approved and not request.rejection_reason %}
                    <form method="post" action="{% url 'maintenance:approve_accessory_transfer' request.id %}" class="d-inline">
                      {% csrf_token %}
                      <button type="submit" name="action" value="approve" class="btn btn-sm btn-success" 
                              onclick="return confirm('هل أنت متأكد من الموافقة على هذا الطلب؟')">
                        <i class="bi bi-check"></i> موافقة
                      </button>
                    </form>
                    <button type="button" class="btn btn-sm btn-danger ms-1" data-bs-toggle="modal" 
                            data-bs-target="#rejectModal{{ request.id }}">
                      <i class="bi bi-x"></i> رفض
                    </button>
                    
                    <!-- Reject Modal -->
                    <div class="modal fade" id="rejectModal{{ request.id }}" tabindex="-1">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title">رفض طلب النقل</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                          </div>
                          <form method="post" action="{% url 'maintenance:approve_accessory_transfer' request.id %}">
                            {% csrf_token %}
                            <div class="modal-body">
                              <div class="mb-3">
                                <label for="rejection_reason{{ request.id }}" class="form-label">سبب الرفض</label>
                                <textarea class="form-control" id="rejection_reason{{ request.id }}" 
                                         name="rejection_reason" rows="3" required></textarea>
                              </div>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                              <button type="submit" name="action" value="reject" class="btn btn-danger">رفض الطلب</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="7" class="text-center py-4 text-muted">لا توجد طلبات نقل</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Transfer Logs -->
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">سجل النقل المكتمل</h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>التاريخ</th>
              <th>من</th>
              <th>إلى</th>
              <th>نُقل بواسطة</th>
              <th>ملاحظات</th>
            </tr>
          </thead>
          <tbody>
            {% for log in transfer_logs %}
              <tr>
                <td>{{ log.transferred_at|date:"Y-m-d H:i" }}</td>
                <td>
                  {% if log.from_device %}
                    <strong>{{ log.from_device.name }}</strong><br>
                    <small class="text-muted">{{ log.from_department }} - {{ log.from_room }}</small>
                  {% else %}
                    {{ log.from_department }} - {{ log.from_room }}
                  {% endif %}
                </td>
                <td>
                  {% if log.to_device %}
                    <strong>{{ log.to_device.name }}</strong><br>
                    <small class="text-muted">{{ log.to_department }} - {{ log.to_room }}</small>
                  {% else %}
                    {{ log.to_department }}{% if log.to_room %} - {{ log.to_room }}{% endif %}
                  {% endif %}
                </td>
                <td>{{ log.transferred_by }}</td>
                <td>{{ log.notes|default:"-" }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="text-center py-4 text-muted">لا توجد عمليات نقل مكتملة</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}
