{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}QR Scanner Session | HMS{% endblock %}

{% block content %}
<style>
    .scanner-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .scanner-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 40px;
        margin-bottom: 30px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        color: white;
    }
    
    .scanner-header h1 {
        margin: 0;
        font-size: 2.5rem;
        font-weight: bold;
    }
    
    .scanner-header p {
        margin: 10px 0 0;
        font-size: 1.2rem;
        opacity: 0.9;
    }
    
    .camera-section {
        background: white;
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    
    .video-container {
        position: relative;
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        border-radius: 15px;
        overflow: hidden;
        background: #000;
    }
    
    #video, #canvas {
        width: 100%;
        height: auto;
        display: block;
    }
    
    #canvas {
        display: none;
    }
    
    .scan-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 250px;
        height: 250px;
        border: 3px solid #00ff00;
        border-radius: 15px;
        animation: pulse 2s infinite;
        pointer-events: none;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        50% { opacity: 0.7; transform: translate(-50%, -50%) scale(1.05); }
    }
    
    .manual-input {
        text-align: center;
        margin-top: 20px;
    }
    
    .scan-input {
        font-size: 24px;
        padding: 15px 30px;
        border: 2px solid #e0e0e0;
        border-radius: 50px;
        width: 100%;
        max-width: 500px;
        text-align: center;
        transition: all 0.3s;
    }
    
    .scan-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .camera-controls {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 20px;
    }
    
    .operations-section {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .operation-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid transparent;
    }
    
    .operation-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }
    
    .operation-card.selected {
        background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        border-color: #667eea;
    }
    
    .operation-card h4 {
        margin: 0 0 10px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .operation-card .badge {
        font-size: 0.75rem;
    }
    
    .operation-card p {
        margin: 0;
        color: #666;
        font-size: 0.9rem;
    }
    
    .scan-history {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .scan-history h3 {
        margin: 0 0 20px;
        color: #333;
    }
    
    .scan-item {
        display: flex;
        align-items: center;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 10px;
        transition: all 0.2s;
    }
    
    .scan-item:hover {
        background: #e9ecef;
    }
    
    .scan-item-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 1.2rem;
    }
    
    .scan-item-icon.device { background: #d4edda; color: #155724; }
    .scan-item-icon.patient { background: #d1ecf1; color: #004085; }
    .scan-item-icon.user { background: #f8d7da; color: #721c24; }
    .scan-item-icon.badge { background: #e7e8ea; color: #383d41; }
    .scan-item-icon.bed { background: #fff3cd; color: #856404; }
    
    .scan-item-details {
        flex: 1;
    }
    
    .scan-item-time {
        color: #999;
        font-size: 0.85rem;
    }
    
    .executions-section {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    
    .execution-item {
        padding: 15px;
        border-left: 4px solid #ffc107;
        background: #fffdf0;
        border-radius: 0 10px 10px 0;
        margin-bottom: 15px;
    }
    
    .execution-item.completed {
        border-color: #28a745;
        background: #f0fff4;
    }
    
    .execution-item.pending {
        border-color: #ffc107;
        background: #fffdf0;
    }
    
    .execution-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }
    
    .session-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }
    
    .info-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    
    .info-card i {
        font-size: 2rem;
        margin-bottom: 10px;
        color: #667eea;
    }
    
    .info-card h5 {
        margin: 0;
        color: #333;
        font-size: 1.5rem;
    }
    
    .info-card p {
        margin: 5px 0 0;
        color: #666;
        font-size: 0.9rem;
    }
</style>
<div class="scanner-container">
    <!-- Header -->
    <div class="scanner-header">
        <h1><i class="fas fa-qrcode"></i> QR Scanner Session</h1>
        <p>Session ID: {{ session.session_id }}</p>
    </div>
    
    <!-- Session Info -->
    <div class="session-info">
        <div class="info-card">
            <i class="fas fa-camera"></i>
            <h5 id="scanCount">0</h5>
            <p>{% trans "Scans" %}</p>
        </div>
        <div class="info-card">
            <i class="fas fa-clock"></i>
            <h5 id="sessionTime">00:00</h5>
            <p>{% trans "Duration" %}</p>
        </div>
        <div class="info-card">
            <i class="fas fa-tasks"></i>
            <h5>{{ pending_executions.count }}</h5>
            <p>{% trans "Pending" %}</p>
        </div>
        <div class="info-card">
            <i class="fas fa-check-circle"></i>
            <h5>{{ completed_executions.count }}</h5>
            <p>{% trans "Completed" %}</p>
        </div>
    </div>
    
    <!-- Camera Section -->
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-camera"></i> Camera Scanner</h5>
                    <div id="scanStatus" class="badge badge-secondary">Ready</div>
                </div>
                <div class="card-body text-center">
                    <div class="position-relative">
                        <video id="video" width="100%" height="400" style="border: 2px solid #ddd; border-radius: 8px; background: #000;"></video>
                        <div id="scanOverlay" class="position-absolute" style="top: 50%; left: 50%; transform: translate(-50%, -50%); border: 2px dashed #fff; width: 200px; height: 200px; pointer-events: none; display: none;">
                            <div class="text-center text-white mt-5">
                                <i class="fas fa-qrcode fa-2x"></i>
                                <div>Point camera at code</div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button id="startButton" class="btn btn-success btn-lg" onclick="startCamera()">
                            <i class="fas fa-play"></i> Start Scanner
                        </button>
                        <button id="stopButton" class="btn btn-danger btn-lg" style="display: none;" onclick="stopCamera()">
                            <i class="fas fa-stop"></i> Stop
                        </button>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            Tips: Hold steady, ensure good lighting, try different angles
                        </small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <!-- Manual Input -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-keyboard"></i> Manual Input</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-2">{% trans "Or enter code manually:" %}</p>
                    <input type="text" id="manualInput" class="form-control form-control-lg" 
                           placeholder="{% trans 'Enter QR/Barcode...' %}"
                           autocomplete="off">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Operations Selection -->
    <h3 class="mb-3"><i class="fas fa-cogs"></i> {% trans "Available Operations" %}</h3>
    <div class="operations-section">
        {% for operation in operations %}
        <div class="operation-card" data-operation-id="{{ operation.id }}" 
             data-operation-code="{{ operation.code }}">
            <h4>
                {{ operation.name }}
                {% if operation.requires_badge %}
                    <span class="badge badge-warning">
                        <i class="fas fa-id-badge"></i> Badge
                    </span>
                {% endif %}
                {% if operation.auto_execute %}
                    <span class="badge badge-success">Auto</span>
                {% endif %}
            </h4>
            <p>{{ operation.description|default:"" }}</p>
            <small class="text-muted">
                <i class="fas fa-list"></i> {{ operation.steps.count }} steps
            </small>
        </div>
        {% endfor %}
    </div>
    
    <!-- Pending Executions -->
    {% if pending_executions %}
    <div class="executions-section mb-4">
        <h3 class="mb-3">
            <i class="fas fa-hourglass-half"></i> {% trans "Pending Executions" %}
        </h3>
        {% for execution in pending_executions %}
        <div class="execution-item pending">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h5>{{ execution.operation.name }}</h5>
                    <p class="mb-1">
                        {% trans "Started at" %}: {{ execution.started_at|date:"H:i:s" }}
                    </p>
                    <small class="text-muted">
                        {% trans "Scanned entities" %}: {{ execution.scanned_entities|length }}
                    </small>
                </div>
                <div class="execution-actions">
                    <button class="btn btn-success btn-sm" 
                            onclick="confirmExecution({{ execution.id }})">
                        <i class="fas fa-check"></i> {% trans "Confirm" %}
                    </button>
                    <button class="btn btn-danger btn-sm" 
                            onclick="cancelExecution({{ execution.id }})">
                        <i class="fas fa-times"></i> {% trans "Cancel" %}
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- Scan History -->
    <div class="scan-history">
        <h3><i class="fas fa-history"></i> {% trans "Recent Scans" %}</h3>
        <div id="scanHistoryContainer">
            {% for scan in recent_scans %}
            <div class="scan-item">
                <div class="scan-item-icon {{ scan.entity_type }}">
                    {% if scan.entity_type == 'device' %}
                        <i class="fas fa-laptop-medical"></i>
                    {% elif scan.entity_type == 'patient' %}
                        <i class="fas fa-user-injured"></i>
                    {% elif scan.entity_type == 'user' %}
                        <i class="fas fa-user-md"></i>
                    {% elif scan.entity_type == 'badge' %}
                        <i class="fas fa-id-badge"></i>
                    {% elif scan.entity_type == 'bed' %}
                        <i class="fas fa-bed"></i>
                    {% else %}
                        <i class="fas fa-qrcode"></i>
                    {% endif %}
                </div>
                <div class="scan-item-details">
                    <strong>{{ scan.entity_type|title }}: {{ scan.entity_id }}</strong>
                    <div class="scan-item-time">
                        {{ scan.scanned_at|date:"H:i:s" }}
                    </div>
                </div>
            </div>
            {% empty %}
            <p class="text-muted text-center">{% trans "No scans yet" %}</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Additional Data Modal -->
<div class="modal fade" id="additionalDataModal" tabindex="-1" aria-labelledby="additionalDataModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="additionalDataModalLabel">
                    <i class="fas fa-plus-circle"></i> ÿ®ŸäÿßŸÜÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑŸÑÿπŸÖŸÑŸäÿ©
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="additionalDataForm">
                    <div id="additionalFields">
                        <!-- Fields will be populated based on operation type -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                </button>
                <button type="button" class="btn btn-primary" onclick="submitAdditionalData()">
                    <i class="fas fa-check"></i> ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿπŸÖŸÑŸäÿ©
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Operations Modal -->
<div class="modal fade" id="operationsModal" tabindex="-1" aria-labelledby="operationsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="operationsModalLabel">
                    <i class="fas fa-list-check"></i> ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="operationsContent">
                    <!-- Operations will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> ÿ•ŸÑÿ∫ÿßÿ°
                </button>
                <button type="button" class="btn btn-primary" id="continueScanning" style="display: none;">
                    <i class="fas fa-qrcode"></i> ŸÖÿ™ÿßÿ®ÿπÿ© ÿßŸÑŸÖÿ≥ÿ≠ ŸÑŸÑÿπŸÖŸÑŸäÿßÿ™ ÿ´ŸÑÿßÿ´Ÿäÿ© ÿßŸÑÿÆÿ∑Ÿàÿßÿ™
                </button>
            </div>
        </div>
    </div>
</div>


<script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
<script>// Global variables
    let codeReader = null;
    let selectedDeviceId = null;
    let selectedOperation = null;
    let scanCount = 0;
    let sessionStartTime = Date.now();
    let isScanning = false;
    let videoStream = null;
    
    // Debug helper function
    function debugLog(message, isError = false) {
        const timestamp = new Date().toLocaleTimeString();
        const prefix = isError ? '‚ùå' : '‚úÖ';
        console.log(`${prefix} [${timestamp}] ${message}`);
        
        const debugDiv = document.getElementById('debugMessages');
        if (debugDiv) {
            debugDiv.innerHTML = `${prefix} [${timestamp}] ${message}<br>` + debugDiv.innerHTML;
            // Keep only last 10 messages
            const lines = debugDiv.innerHTML.split('<br>');
            if (lines.length > 10) {
                debugDiv.innerHTML = lines.slice(0, 10).join('<br>');
            }
        }
    }
    
    // Initialize on page load
    window.addEventListener('DOMContentLoaded', function() {
        debugLog('Page loaded, initializing scanner...');
        
        // Start session timer
        updateSessionTime();
        setInterval(updateSessionTime, 1000);
        
        // Setup event listeners first
        setupEventListeners();
        
        // Simple initialization
        setTimeout(() => {
            try {
                codeReader = new ZXing.BrowserMultiFormatReader();
                debugLog('ZXing ready');
                
                // Don't auto-start, wait for user click
                debugLog('Ready to start camera manually');
            } catch (e) {
                debugLog('ZXing error: ' + e.message, true);
                focusManualInput();
            }
        }, 1000);
    });
    
    // Check browser environment
    function checkEnvironment() {
        debugLog(`Current URL: ${window.location.href}`);
        debugLog(`Protocol: ${window.location.protocol}`);
        
        // Check if HTTPS or localhost
        const isSecure = window.location.protocol === 'https:' || 
                         window.location.hostname === 'localhost' || 
                         window.location.hostname === '127.0.0.1';
        
        if (!isSecure) {
            debugLog('‚ö†Ô∏è Camera requires HTTPS or localhost!', true);
            showNotification('Camera access requires HTTPS! Please use https:// or localhost', 'error');
            return false;
        }
        
        // Check if browser supports camera
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            debugLog('Browser does not support camera API!', true);
            showNotification('Your browser does not support camera access. Please use a modern browser.', 'error');
            return false;
        }
        
        debugLog('Environment check passed');
        return true;
    }
    
    // Initialize ZXing library
    function initializeZXing() {
        try {
            // Wait for ZXing to be available
            let attempts = 0;
            const maxAttempts = 10;
            
            const checkZXing = () => {
                attempts++;
                
                // Check if ZXing is loaded
                if (typeof ZXing !== 'undefined') {
                    // Create code reader instance
                    codeReader = new ZXing.BrowserMultiFormatReader();
                    debugLog('ZXing initialized successfully');
                    return true;
                }
                
                // Try alternative namespace
                if (typeof ZXingBrowser !== 'undefined') {
                    window.ZXing = ZXingBrowser;
                    codeReader = new ZXing.BrowserMultiFormatReader();
                    debugLog('Using ZXingBrowser namespace');
                    return true;
                }
                
                if (attempts < maxAttempts) {
                    debugLog(`ZXing not ready, attempt ${attempts}/${maxAttempts}`);
                    setTimeout(checkZXing, 100);
                    return false;
                } else {
                    debugLog('ZXing library failed to load after multiple attempts!', true);
                    showNotification('Scanner library failed to load. Please refresh the page.', 'error');
                    return false;
                }
            };
            
            return checkZXing();
            
        } catch (error) {
            debugLog(`ZXing initialization error: ${error.message}`, true);
            showNotification('Failed to initialize scanner library', 'error');
            return false;
        }
    }
    
    // Setup all event listeners
    function setupEventListeners() {
        // Camera controls
        const startBtn = document.getElementById('startButton');
        const stopBtn = document.getElementById('stopButton');
        const switchBtn = document.getElementById('switchButton');
        const manualInput = document.getElementById('manualInput');
        
        if (startBtn) {
            startBtn.addEventListener('click', startCamera);
        }
        
        if (stopBtn) {
            stopBtn.addEventListener('click', stopCamera);
        }
        
        if (switchBtn) {
            switchBtn.addEventListener('click', switchCamera);
        }
        
        if (manualInput) {
            manualInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const value = e.target.value.trim();
                    if (value) {
                        handleScan(value);
                        e.target.value = '';
                    }
                }
            });
        }
        
        // Operation selection
        document.querySelectorAll('.operation-card').forEach(card => {
            card.addEventListener('click', function() {
                selectOperation(this);
            });
        });
        
        debugLog('Event listeners setup completed');
    }
    
    // Check available cameras
    async function checkCameras() {
        try {
            // First request permission (this will trigger permission prompt)
            debugLog('Requesting camera permission...');
            
            const tempStream = await navigator.mediaDevices.getUserMedia({ 
                video: {
                    width: { ideal: 1280, min: 640 },
                    height: { ideal: 720, min: 480 },
                    facingMode: { ideal: 'environment' }, // Prefer back camera
                    focusMode: { ideal: 'continuous' },
                    exposureMode: { ideal: 'continuous' }
                },
                audio: false 
            });
            
            // Stop the temporary stream
            tempStream.getTracks().forEach(track => track.stop());
            debugLog('Camera permission granted');
            
            // Now enumerate devices (will have labels after permission)
            const devices = await navigator.mediaDevices.enumerateDevices();
            const cameras = devices.filter(d => d.kind === 'videoinput');
            
            debugLog(`Found ${cameras.length} camera(s)`);
            
            if (cameras.length === 0) {
                debugLog('No cameras found!', true);
                showNotification('No cameras found on this device', 'warning');
                focusManualInput();
                return false;
            }
            
            cameras.forEach((cam, i) => {
                debugLog(`Camera ${i + 1}: ${cam.label || 'Unnamed'}`);
            });
            
            return true;
            
        } catch (error) {
            debugLog(`Camera check error: ${error.name} - ${error.message}`, true);
            
            if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                showNotification('Camera permission denied. Please allow camera access and refresh.', 'error');
            } else if (error.name === 'NotFoundError') {
                showNotification('No camera found on this device', 'error');
            } else {
                showNotification(`Camera error: ${error.message}`, 'error');
            }
            
            focusManualInput();
            return false;
        }
    }
    
    // Start camera and scanning - SIMPLIFIED VERSION
    async function startCamera() {
        const startButton = document.getElementById('startButton');
        
        try {
            debugLog('üé• Starting camera...');
            
            // Update button
            startButton.disabled = true;
            startButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
            
            // Simple camera start
            isScanning = true;
            
            await codeReader.decodeFromVideoDevice(
                undefined, // Let ZXing choose camera
                'video',
                (result, error) => {
                    if (result && isScanning) {
                        debugLog(`‚úÖ Scanned: ${result.text}`);
                        handleScanResult(result.text);
                    }
                }
            );
            
            debugLog('‚úÖ Camera working!');
            showNotification('üì∑ Camera ready! Scan your code now.', 'success');
            
            // Update UI
            startButton.style.display = 'none';
            document.getElementById('stopButton').style.display = 'inline-block';
            document.getElementById('scanStatus').textContent = 'Ready';
            document.getElementById('scanStatus').className = 'badge badge-success';
            
        } catch (error) {
            debugLog(`‚ùå Camera failed: ${error.message}`, true);
            
            // Reset button
            startButton.disabled = false;
            startButton.innerHTML = '<i class="fas fa-camera"></i> Try Camera';
            
            showNotification('Camera failed. Use manual input below.', 'warning');
            focusManualInput();
        }
    }
    
    // Stop camera
    function stopCamera() {
        debugLog('Stopping camera...');
        
        isScanning = false;
        
        if (codeReader) {
            codeReader.reset();
        }
        
        // Update UI
        document.getElementById('startButton').style.display = 'inline-block';
        document.getElementById('stopButton').style.display = 'none';
        document.getElementById('switchButton').style.display = 'none';
        document.getElementById('scanStatus').textContent = 'Stopped';
        document.getElementById('scanStatus').className = 'badge badge-secondary';
        document.getElementById('scanOverlay').style.display = 'none';
        
        debugLog('Camera stopped');
    }
    
    // Switch between cameras
    async function switchCamera() {
        try {
            const videoInputDevices = await codeReader.listVideoInputDevices();
            
            if (videoInputDevices.length <= 1) {
                debugLog('No other cameras to switch to');
                return;
            }
            
            // Find current camera index
            const currentIndex = videoInputDevices.findIndex(d => d.deviceId === selectedDeviceId);
            const nextIndex = (currentIndex + 1) % videoInputDevices.length;
            selectedDeviceId = videoInputDevices[nextIndex].deviceId;
            
            debugLog(`Switching to camera: ${videoInputDevices[nextIndex].label || selectedDeviceId}`);
            
            // Reset current stream
            codeReader.reset();
            
            // Start with new camera
            isScanning = true;
            await codeReader.decodeFromVideoDevice(
                selectedDeviceId,
                'video',
                (result, error) => {
                    if (result && isScanning) {
                        debugLog(`Code detected: ${result.text}`);
                        handleScanResult(result.text);
                    }
                    if (error && !(error instanceof ZXing.NotFoundException)) {
                        console.error('Scan error:', error);
                        debugLog(`Scan error: ${error.name} - ${error.message}`, true);
                    }
                }
            );
            
            debugLog('Camera switched successfully');
            
        } catch (error) {
            debugLog(`Error switching camera: ${error.message}`, true);
            showNotification('Failed to switch camera', 'error');
        }
    }
    
    // Select best camera (prefer back camera on mobile)
    function selectBestCamera(cameras) {
        // Try to find back/environment camera
        const backCamera = cameras.find(camera => {
            const label = (camera.label || '').toLowerCase();
            return label.includes('back') || 
                   label.includes('rear') || 
                   label.includes('environment');
        });
        
        if (backCamera) {
            debugLog('Selected back camera');
            return backCamera;
        }
        
        // On mobile devices without labeled cameras, last one is usually back camera
        if (cameras.length > 1 && isMobileDevice()) {
            debugLog('Selected last camera (likely back on mobile)');
            return cameras[cameras.length - 1];
        }
        
        // Default to first camera
        debugLog('Selected default camera');
        return cameras[0];
    }
    
    // Check if mobile device
    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    
    // Handle successful scan
    function handleScanResult(code) {
        // Prevent duplicate scans
        const now = Date.now();
        if (window.lastScanTime && (now - window.lastScanTime) < 2000) {
            debugLog('Duplicate scan ignored');
            return;
        }
        window.lastScanTime = now;
        
        debugLog(`‚úÖ Successfully scanned: ${code}`);
        
        // Strong visual feedback
        const video = document.getElementById('video');
        video.style.border = '5px solid #00ff00';
        video.style.boxShadow = '0 0 20px #00ff00';
        setTimeout(() => {
            video.style.border = 'none';
            video.style.boxShadow = 'none';
        }, 1000);
        
        // Audio feedback
        const beep = document.getElementById('beepSound');
        if (beep) {
            beep.play().catch(e => console.log('Audio play failed:', e));
        }
        
        // Update scan count
        scanCount++;
        document.getElementById('scanCount').textContent = scanCount;
        
        // Update scan status
        document.getElementById('scanStatus').textContent = 'Processing...';
        document.getElementById('scanStatus').className = 'badge badge-warning';
        
        // Show immediate feedback
        showNotification(`üì± Code scanned: ${code.substring(0, 20)}...`, 'success');
        
        // Process the scan
        handleScan(code);
    }
    
    // Handle camera errors
    function handleCameraError(error) {
        let errorMessage = 'Camera error';
        
        switch(error.name) {
            case 'NotAllowedError':
            case 'PermissionDeniedError':
                errorMessage = 'Camera permission denied. Please allow camera access in browser settings.';
                break;
            case 'NotFoundError':
            case 'DevicesNotFoundError':
                errorMessage = 'No camera found on this device.';
                break;
            case 'NotReadableError':
            case 'TrackStartError':
                errorMessage = 'Camera is being used by another application.';
                break;
            case 'OverconstrainedError':
                errorMessage = 'Camera constraints could not be satisfied.';
                break;
            default:
                errorMessage = `Camera error: ${error.message}`;
        }
        
        showNotification(errorMessage, 'error');
    }
    
    // Focus on manual input field
    function focusManualInput() {
        const manualInput = document.getElementById('manualInput');
        if (manualInput) {
            manualInput.focus();
            manualInput.placeholder = 'Camera not available - Enter code manually';
        }
    }
    
    // Update session timer
    function updateSessionTime() {
        const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        const timeElement = document.getElementById('sessionTime');
        if (timeElement) {
            timeElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    }
    
    // Select operation
    function selectOperation(card) {
        document.querySelectorAll('.operation-card').forEach(c => {
            c.classList.remove('selected');
        });
        card.classList.add('selected');
        selectedOperation = {
            id: card.dataset.operationId,
            code: card.dataset.operationCode
        };
        debugLog(`Selected operation: ${selectedOperation.code}`);
    }
    
    // Process scan result
    function handleScan(code) {
        // Send to server
        fetch("{% url 'maintenance:scan_qr_code' %}", {  // ÿ™ÿ∫ŸäŸäÿ± ÿ•ŸÑŸâ scan_qr_code ÿ®ÿØŸÑÿßŸã ŸÖŸÜ scan_qr_code_api
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                qr_code: code,
                session_id: window.currentSessionId || ('{{ session.session_id }}' === 'pending' ? null : '{{ session.session_id }}'),
                operation_code: selectedOperation ? selectedOperation.code : null
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Scan response:', data);
            
            if (data.success) {
                addToHistory(data);
                
                // If new session created (first user scan), update session_id
                if (data.session_id && '{{ session.session_id }}' === 'pending') {
                    // Update the current session_id for future scans
                    window.currentSessionId = data.session_id;
                    showNotification('New session started! Continue scanning device and patient.', 'success');
                }
                
                // Show notifications
                if (data.notifications) {
                    data.notifications.forEach(msg => {
                        showNotification(msg, 'info');
                    });
                }
                
                // Show warnings
                if (data.warnings) {
                    data.warnings.forEach(msg => {
                        showNotification(msg, 'warning');
                    });
                }
                
                // Check if we have available operations to show (User + Device scanned)
                if (data.available_operations && data.available_operations.length > 0) {
                    showOperationsModal(data.available_operations, data.requires_third_step, data.entity_id, data.entity_type);
                }
                
                // If operation executed, refresh pending executions
                if (data.operation_executed) {
                    showNotification('Operation executed successfully!', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                }
            } else {
                showNotification(data.error || 'Scan failed', 'error');
            }
        })
        .catch(error => {
            console.error('Network error:', error);
            showNotification('Network error: ' + error.message, 'error');
        });
    }
    
    // Add scan to history display
    function addToHistory(data) {
        const container = document.getElementById('scanHistoryContainer');
        const iconMap = {
            'device': 'fa-laptop-medical',
            'patient': 'fa-user-injured',
            'user': 'fa-user-md',
            'badge': 'fa-id-badge',
            'bed': 'fa-bed'
        };
        
        const icon = iconMap[data.entity_type] || 'fa-qrcode';
        const time = new Date().toLocaleTimeString();
        
        const scanItem = document.createElement('div');
        scanItem.className = 'scan-item';
        scanItem.innerHTML = `
            <div class="scan-item-icon ${data.entity_type}">
                <i class="fas ${icon}"></i>
            </div>
            <div class="scan-item-details">
                <strong>${data.entity_type}: ${data.entity_id}</strong>
                <div class="scan-item-time">${time}</div>
            </div>
        `;
        
        // Remove "No scans yet" message if exists
        const noScansMsg = container.querySelector('.text-muted');
        if (noScansMsg) {
            noScansMsg.remove();
        }
        
        container.insertBefore(scanItem, container.firstChild);
        
        // Keep only last 20 items
        while (container.children.length > 20) {
            container.removeChild(container.lastChild);
        }
    }
    
    // Show notification message
    function showNotification(message, type) {
        const alertClass = {
            'success': 'alert-success',
            'error': 'alert-danger',
            'warning': 'alert-warning',
            'info': 'alert-info'
        }[type] || 'alert-info';
        
        const alert = document.createElement('div');
        alert.className = `alert ${alertClass} position-fixed`;
        alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alert.innerHTML = message;
        
        document.body.appendChild(alert);
        
        setTimeout(() => {
            alert.remove();
        }, 5000);
    }
    
    // Get CSRF cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Confirm operation execution
    function confirmExecution(executionId) {
        if (confirm('Are you sure you want to confirm this operation?')) {
            fetch(`/maintenance/operations/execution/${executionId}/confirm/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Operation confirmed successfully', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showNotification(data.error || 'Failed to confirm', 'error');
                }
            });
        }
    }
    
    // Cancel operation execution
    function cancelExecution(executionId) {
        if (confirm('Are you sure you want to cancel this operation?')) {
            fetch(`/maintenance/operations/execution/${executionId}/cancel/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Operation cancelled', 'info');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showNotification(data.error || 'Failed to cancel', 'error');
                }
            });
        }
    }
    
    // Show operations modal
    function showOperationsModal(operations, requiresThirdStep, entityId, entityType) {
        const operationsContent = document.getElementById('operationsContent');
        const continueBtn = document.getElementById('continueScanning');
        
        // Clear previous content
        operationsContent.innerHTML = '';
        
        // Create header
        const header = document.createElement('div');
        header.className = 'mb-3';
        header.innerHTML = `
            <p class="text-muted">
                <i class="fas fa-info-circle"></i>
                ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸàÿßŸÑÿ¨Ÿáÿßÿ≤. ÿßÿÆÿ™ÿ± ÿßŸÑÿπŸÖŸÑŸäÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©:
            </p>
        `;
        operationsContent.appendChild(header);
        
        // Create operation buttons grid
        const operationsGrid = document.createElement('div');
        operationsGrid.className = 'row g-3';
        
        operations.forEach(op => {
            const col = document.createElement('div');
            col.className = 'col-md-6';
            
            const button = document.createElement('button');
            button.className = `btn btn-${op.color || 'primary'} w-100 p-3 operation-btn`;
            button.innerHTML = `
                <i class="${op.icon || 'fas fa-cog'} fs-3 mb-2"></i><br>
                <strong>${op.name}</strong>
                ${op.requires_third_step ? '<br><small class="text-white-50">Ÿäÿ≠ÿ™ÿßÿ¨ ÿÆÿ∑Ÿàÿ© ÿ•ÿ∂ÿßŸÅŸäÿ©</small>' : ''}
            `;
            
            // Add click handler
            button.addEventListener('click', function() {
                checkOperationRequirements(op.code, entityId, op.two_step);
            });
            
            col.appendChild(button);
            operationsGrid.appendChild(col);
        });
        
        operationsContent.appendChild(operationsGrid);
        
        // Show/hide continue scanning button based on whether third step is needed
        if (requiresThirdStep) {
            continueBtn.style.display = 'block';
        } else {
            continueBtn.style.display = 'none';
        }
        
        // Show modal using Bootstrap 5
        const modal = new bootstrap.Modal(document.getElementById('operationsModal'));
        modal.show();
    }
    
    // Check if operation needs additional data
    function checkOperationRequirements(operationCode, deviceId, isTwoStep) {
        const needsAdditionalData = {
            'DEVICE_CLEANING': {
                fields: [
                    { type: 'file', name: 'before_image', label: 'ÿµŸàÿ±ÿ© ŸÇÿ®ŸÑ ÿßŸÑÿ™ŸÜÿ∏ŸäŸÅ', required: false },
                    { type: 'file', name: 'after_image', label: 'ÿµŸàÿ±ÿ© ÿ®ÿπÿØ ÿßŸÑÿ™ŸÜÿ∏ŸäŸÅ', required: false },
                    { type: 'textarea', name: 'notes', label: 'ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™', required: false }
                ]
            },
            'DEVICE_STERILIZATION': {
                fields: [
                    { type: 'file', name: 'before_image', label: 'ÿµŸàÿ±ÿ© ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿπŸÇŸäŸÖ', required: false },
                    { type: 'file', name: 'after_image', label: 'ÿµŸàÿ±ÿ© ÿ®ÿπÿØ ÿßŸÑÿ™ÿπŸÇŸäŸÖ', required: false },
                    { type: 'select', name: 'method', label: 'ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ™ÿπŸÇŸäŸÖ', required: true, options: [
                        { value: 'autoclave', label: 'ÿ£Ÿàÿ™ŸàŸÉŸÑÿßŸÅ' },
                        { value: 'chemical', label: 'ŸÉŸäŸÖŸäÿßÿ¶Ÿä' },
                        { value: 'uv', label: 'ÿßŸÑÿ£ÿ¥ÿπÿ© ŸÅŸàŸÇ ÿßŸÑÿ®ŸÜŸÅÿ≥ÿ¨Ÿäÿ©' }
                    ]},
                    { type: 'text', name: 'lot_number', label: 'ÿ±ŸÇŸÖ ÿßŸÑÿØŸÅÿπÿ©', required: false },
                    { type: 'textarea', name: 'notes', label: 'ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™', required: false }
                ]
            },
            'MAINTENANCE_OPEN': {
                fields: [
                    { type: 'textarea', name: 'description', label: 'ŸàÿµŸÅ ÿßŸÑŸÖÿ¥ŸÉŸÑÿ©', required: true },
                    { type: 'file', name: 'issue_image', label: 'ÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ¥ŸÉŸÑÿ©', required: false },
                    { type: 'select', name: 'priority', label: 'ÿßŸÑÿ£ŸàŸÑŸàŸäÿ©', required: true, options: [
                        { value: 'low', label: 'ŸÖŸÜÿÆŸÅÿ∂ÿ©' },
                        { value: 'normal', label: 'ÿπÿßÿØŸäÿ©' },
                        { value: 'high', label: 'ÿπÿßŸÑŸäÿ©' },
                        { value: 'critical', label: 'ÿ≠ÿ±ÿ¨ÿ©' }
                    ]}
                ]
            },
            'MAINTENANCE_CLOSE': {
                fields: [
                    { type: 'textarea', name: 'solution', label: 'ÿßŸÑÿ≠ŸÑ ÿßŸÑŸÖÿ∑ÿ®ŸÇ', required: true },
                    { type: 'file', name: 'after_image', label: 'ÿµŸàÿ±ÿ© ÿ®ÿπÿØ ÿßŸÑÿ•ÿµŸÑÿßÿ≠', required: false },
                    { type: 'textarea', name: 'notes', label: 'ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™', required: false }
                ]
            },
            'CALIBRATION': {
                fields: [
                    { type: 'textarea', name: 'reason', label: 'ÿ≥ÿ®ÿ® ÿßŸÑŸÖÿπÿßŸäÿ±ÿ©', required: false },
                    { type: 'date', name: 'next_due', label: 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿπÿßŸäÿ±ÿ© ÿßŸÑŸÇÿßÿØŸÖÿ©', required: false }
                ]
            }
        };
        
        if (needsAdditionalData[operationCode]) {
            showAdditionalDataModal(operationCode, deviceId, isTwoStep, needsAdditionalData[operationCode]);
        } else {
            executeOperation(operationCode, deviceId, isTwoStep, {});
        }
    }
    
    // Show additional data modal
    function showAdditionalDataModal(operationCode, deviceId, isTwoStep, config) {
        const fieldsContainer = document.getElementById('additionalFields');
        fieldsContainer.innerHTML = '';
        
        // Store operation info for later use
        window.pendingOperationData = {
            operationCode: operationCode,
            deviceId: deviceId,
            isTwoStep: isTwoStep
        };
        
        // Generate form fields
        config.fields.forEach(field => {
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'mb-3';
            
            const label = document.createElement('label');
            label.className = 'form-label';
            label.innerHTML = field.label + (field.required ? ' <span class="text-danger">*</span>' : '');
            fieldDiv.appendChild(label);
            
            if (field.type === 'textarea') {
                const textarea = document.createElement('textarea');
                textarea.className = 'form-control';
                textarea.name = field.name;
                textarea.rows = 3;
                textarea.required = field.required;
                fieldDiv.appendChild(textarea);
            } else if (field.type === 'select') {
                const select = document.createElement('select');
                select.className = 'form-control';
                select.name = field.name;
                select.required = field.required;
                
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'ÿßÿÆÿ™ÿ±...';
                select.appendChild(defaultOption);
                
                field.options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.label;
                    select.appendChild(option);
                });
                
                fieldDiv.appendChild(select);
            } else if (field.type === 'file') {
                const input = document.createElement('input');
                input.type = 'file';
                input.className = 'form-control';
                input.name = field.name;
                input.accept = 'image/*';
                input.required = field.required;
                fieldDiv.appendChild(input);
            } else {
                const input = document.createElement('input');
                input.type = field.type;
                input.className = 'form-control';
                input.name = field.name;
                input.required = field.required;
                fieldDiv.appendChild(input);
            }
            
            fieldsContainer.appendChild(fieldDiv);
        });
        
        // Hide operations modal and show additional data modal
        const opsModal = bootstrap.Modal.getInstance(document.getElementById('operationsModal'));
        if (opsModal) opsModal.hide();
        
        const modal = new bootstrap.Modal(document.getElementById('additionalDataModal'));
        modal.show();
    }
    
    // Submit additional data and execute operation
    function submitAdditionalData() {
        const form = document.getElementById('additionalDataForm');
        const formData = new FormData(form);
        const additionalData = {};
        
        // Convert FormData to object
        for (let [key, value] of formData.entries()) {
            additionalData[key] = value;
        }
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('additionalDataModal'));
        modal.hide();
        
        // Execute operation with additional data
        if (window.pendingOperationData) {
            executeOperation(
                window.pendingOperationData.operationCode,
                window.pendingOperationData.deviceId,
                window.pendingOperationData.isTwoStep,
                additionalData
            );
        }
    }
    
    // Execute operation
    async function executeOperation(operationCode, deviceId, isTwoStep, additionalData = {}) {
        try {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('operationsModal'));
            modal.hide();
            
            showNotification('ÿ¨ÿßÿ±Ÿä ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿπŸÖŸÑŸäÿ©...', 'info');
            
            // Send request to execute operation
            const response = await fetch('/maintenance/api/execute-operation/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    operation_code: operationCode,
                    device_id: deviceId,
                    session_id: window.currentSessionId || '{{ session.session_id }}',
                    execute_now: isTwoStep,  // Execute immediately if it's a two-step operation
                    additional_data: additionalData  // Include additional data
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification(`‚úÖ ${data.message || 'ÿ™ŸÖ ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿπŸÖŸÑŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠'}`, 'success');
                
                // If operation needs third step, keep scanning
                if (!isTwoStep) {
                    showNotification('ÿßŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸäÿßŸÜ ÿßŸÑÿ´ÿßŸÑÿ´ ŸÑÿ•ŸÉŸÖÿßŸÑ ÿßŸÑÿπŸÖŸÑŸäÿ©', 'info');
                    window.pendingOperation = operationCode;
                }
            } else {
                showNotification(`ÿÆÿ∑ÿ£: ${data.error}`, 'error');
            }
        } catch (error) {
            showNotification(`ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ: ${error.message}`, 'error');
        }
    }
    
    // Continue scanning button handler
    document.addEventListener('DOMContentLoaded', function() {
        const continueBtn = document.getElementById('continueScanning');
        if (continueBtn) {
            continueBtn.addEventListener('click', function() {
                const modal = bootstrap.Modal.getInstance(document.getElementById('operationsModal'));
                modal.hide();
                showNotification('ÿßÿ≥ÿ™ŸÖÿ± ŸÅŸä ÿßŸÑŸÖÿ≥ÿ≠ ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÉŸäÿßŸÜ ÿßŸÑÿ´ÿßŸÑÿ´...', 'info');
                // Focus on manual input or keep camera active
                const manualInput = document.getElementById('manualInput');
                if (manualInput) {
                    manualInput.focus();
                }
            });
        }
    });
</script>
{% endblock %}
