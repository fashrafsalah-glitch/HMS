{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}Ù…Ø³Ø­ QR/Barcode - Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³Ø­{% endblock %}

{% block extra_css %}
<style>
    .scan-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .scan-input-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 30px;
        margin-bottom: 30px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .scan-input {
        font-size: 24px;
        padding: 15px;
        border: 3px solid #007bff;
        border-radius: 10px;
        width: 100%;
        max-width: 500px;
        text-align: center;
        margin: 20px 0;
    }
    
    .scan-input:focus {
        outline: none;
        border-color: #0056b3;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    
    .session-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .info-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-left: 4px solid #007bff;
    }
    
    .info-card h4 {
        margin: 0 0 15px 0;
        color: #007bff;
        font-size: 18px;
    }
    
    .scan-history {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .scan-chip {
        display: inline-block;
        background: #e9ecef;
        border-radius: 20px;
        padding: 8px 16px;
        margin: 5px;
        font-size: 14px;
        border: 1px solid #dee2e6;
    }
    
    .scan-chip.device { background: #d4edda; border-color: #c3e6cb; }
    .scan-chip.patient { background: #d1ecf1; border-color: #bee5eb; }
    .scan-chip.bed { background: #fff3cd; border-color: #ffeaa7; }
    .scan-chip.user { background: #f8d7da; border-color: #f5c6cb; }
    .scan-chip.lab_tube { background: #e2e3e5; border-color: #d6d8db; }
    
    .operation-selector {
        margin: 20px 0;
    }
    
    .operation-selector select {
        padding: 10px;
        border-radius: 5px;
        border: 2px solid #dee2e6;
        font-size: 16px;
        min-width: 200px;
    }
    
    .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 20px;
    }
    
    .btn-save {
        background: #28a745;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-save:hover { background: #218838; }
    
    .btn-reset {
        background: #dc3545;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-reset:hover { background: #c82333; }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-secondary:hover { background: #5a6268; }
    
    .notifications {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        max-width: 400px;
    }
    
    .notification {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-left: 4px solid #007bff;
        animation: slideIn 0.3s ease-out;
    }
    
    .notification.success { border-left-color: #28a745; }
    .notification.warning { border-left-color: #ffc107; }
    .notification.error { border-left-color: #dc3545; }
    
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-active { background: #28a745; }
    .status-pending { background: #ffc107; }
    .status-error { background: #dc3545; }
    
    .inferred-operation {
        background: #e7f3ff;
        border: 2px solid #007bff;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        text-align: center;
    }
    
    .inferred-operation h5 {
        color: #007bff;
        margin: 0 0 10px 0;
    }
    
    @media (max-width: 768px) {
        .scan-container { padding: 10px; }
        .session-info { grid-template-columns: 1fr; }
        .action-buttons { flex-direction: column; align-items: center; }
        .scan-input { font-size: 18px; }
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}

<script>
function updateSaveButtonState() {
    const operationType = document.getElementById('operationType').value;
    const saveButton = document.getElementById('saveSession');
    const scanCount = parseInt(document.getElementById('scanCount').textContent) || 0;
    
    // Enable if operation type is selected AND we have at least 3 scans (user + patient + device)
    if (operationType && scanCount >= 3) {
        saveButton.disabled = false;
        saveButton.style.opacity = '1';
        saveButton.style.backgroundColor = '#28a745';
    } else {
        saveButton.disabled = true;
        saveButton.style.opacity = '0.5';
        saveButton.style.backgroundColor = '#6c757d';
    }
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        document.querySelector('button[onclick*="scanInput"]').click();
    }
}
</script>

<div class="scan-container">
    <div class="scan-header">
        <h2>ğŸ” Ù†Ø¸Ø§Ù… Ù…Ø³Ø­ QR/Barcode</h2>
        <p class="subtitle">Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù†Ø´Ø·Ø©</p>
    </div>
    <div class="scan-input-section">
        <p class="text-muted">Ø§Ù…Ø³Ø­ Ø§Ù„Ø±Ù…ÙˆØ² Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…ÙˆØ² ÙŠØ¯ÙˆÙŠØ§Ù‹</p>
        
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="text" 
                   id="scanInput" 
                   class="scan-input" 
                   placeholder="Ø§Ù…Ø³Ø­ QR/Barcode Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²..."
                   autofocus
                   onkeypress="handleKeyPress(event)"
                   style="flex: 1;">
            <button onclick="
                const input = document.getElementById('scanInput');
                const qrCode = input.value.trim();
                if (!qrCode) { alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ QR Ø£ÙˆÙ„Ø§Ù‹'); return; }
                
                const scanCsrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
                
                fetch('/maintenance/api/scan-qr/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': scanCsrfToken
                    },
                    body: JSON.stringify({
                        qr_code: qrCode,
                        session_id: '{{ session.session_id }}'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Ù†Ø¬Ø­ Ø§Ù„Ù…Ø³Ø­! ' + (data.notifications ? data.notifications.join(', ') : ''));
                        
                        // Update session display
                        if (data.session_status) {
                            if (data.session_status.user) {
                                document.getElementById('currentUser').textContent = data.session_status.user;
                            }
                            if (data.session_status.patient) {
                                document.getElementById('currentPatient').textContent = data.session_status.patient;
                            }
                            if (data.session_status.bed) {
                                document.getElementById('currentBed').textContent = data.session_status.bed;
                            }
                            if (data.session_status.scan_count) {
                                document.getElementById('scanCount').textContent = data.session_status.scan_count;
                            }
                        }
                        
                        // Add to scan history
                        const historyDiv = document.getElementById('scanHistory');
                        if (historyDiv) {
                            const scanItem = document.createElement('span');
                            scanItem.className = 'scan-chip ' + data.entity_type;
                            scanItem.textContent = data.entity_type + ': ' + (data.entity_data.name || data.entity_data.id || data.entity_id);
                            historyDiv.appendChild(scanItem);
                        }
                        
                        // Update operation type if inferred
                        if (data.inferred_operation) {
                            const operationSelect = document.getElementById('operationType');
                            operationSelect.value = data.inferred_operation;
                        }
                        
                        // Enable save button if we have minimum required scans
                        updateSaveButtonState();
                    } else {
                        alert('ÙØ´Ù„ Ø§Ù„Ù…Ø³Ø­: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message);
                });
                
                input.value = '';
            " 
                    style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„
            </button>
        </div>
        
        <div class="operation-selector">
            <label for="operationType">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</label>
            <select id="operationType">
                <option value="">ØªØ­Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ</option>
                {% for value, label in operation_choices %}
                    <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="session-info">
        <div class="info-card">
            <h4>ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©</h4>
            <div id="sessionInfo">
                <p><strong>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> <span id="currentUser">{{ request.user.get_full_name }}</span></p>
                <p><strong>Ø§Ù„Ø¬Ù„Ø³Ø©:</strong> <span id="sessionId">{{ session.session_id }}</span></p>
                <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="status-indicator status-active"></span><span id="sessionStatus">Ù†Ø´Ø·Ø©</span></p>
                <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³Ø­:</strong> <span id="scanCount">0</span></p>
            </div>
        </div>

        <div class="info-card">
            <h4>ğŸ‘¤ Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ§Ù„Ø³Ø±ÙŠØ±</h4>
            <div id="patientInfo">
                <p><strong>Ø§Ù„Ù…Ø±ÙŠØ¶:</strong> <span id="currentPatient">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span></p>
                <p><strong>Ø§Ù„Ø³Ø±ÙŠØ±:</strong> <span id="currentBed">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span></p>
            </div>
        </div>

        <div class="info-card">
            <h4>ğŸ”§ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø©</h4>
            <div id="devicesList">
                <p class="text-muted">Ù„Ù… ÙŠØªÙ… Ù…Ø³Ø­ Ø£Ø¬Ù‡Ø²Ø© Ø¨Ø¹Ø¯</p>
            </div>
        </div>
    </div>

    <div id="inferredOperation" class="inferred-operation" style="display: none;">
        <h5>ğŸ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©</h5>
        <p id="inferredText"></p>
    </div>

    <div class="scan-history">
        <h4>ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³Ø­</h4>
        <div id="scanHistory">
            {% for scan in recent_scans %}
                <span class="scan-chip {{ scan.entity_type }}">
                    {{ scan.entity_type }}: {{ scan.entity_data.name|default:scan.entity_data.id }}
                </span>
            {% empty %}
                <p class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù…Ø³Ø­</p>
            {% endfor %}
        </div>
    </div>

    <div class="action-buttons">
        <button id="saveSession" class="btn-save" disabled onclick="
            const operationType = document.getElementById('operationType').value;
            const saveCsrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
            fetch('/maintenance/api/save-session/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': saveCsrfToken
                },
                body: JSON.stringify({
                    session_id: '{{ session.session_id }}',
                    operation_type: operationType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­!');
                } else {
                    alert('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©: ' + data.error);
                }
            })
            .catch(error => {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©: ' + error.message);
            });
        ">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
        <button id="resetSession" class="btn-reset" onclick="
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ù„Ø³Ø©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø©.')) {
                const resetCsrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
                fetch('/maintenance/api/reset-session/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': resetCsrfToken
                    },
                    body: JSON.stringify({
                        session_id: '{{ session.session_id }}'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­!');
                        location.reload();
                    } else {
                        alert('ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ù„Ø³Ø©: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ù„Ø³Ø©: ' + error.message);
                });
            }
        ">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
        <button id="newSession" class="btn-secondary" onclick="
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŸ')) {
                const newCsrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
                fetch('/maintenance/api/start-session/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': newCsrfToken
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­!');
                        location.reload();
                    } else {
                        alert('ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©: ' + error.message);
                });
            }
        ">â• Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        <a href="{% url 'laboratory:sample_scan' %}" class="btn-secondary">ğŸ§ª Ù…Ø³Ø­ Ø¹ÙŠÙ†Ø§Øª Ø§Ù„Ù…Ø®ØªØ¨Ø±</a>
    </div>
</div>

<div id="notifications" class="notifications"></div>
{% endblock %}

{% block extra_js %}
<script>
console.log('JavaScript file loaded successfully');
console.log('Session ID from template:', '{{ session.session_id }}');

// Test function to check if JavaScript works
function testFunction() {
    alert('Test function called!');
    const input = document.getElementById('scanInput');
    const qrCode = input.value.trim();
    alert('QR Code: ' + qrCode);
    
    if (qrCode) {
        // Simple fetch without async/await
        fetch('/maintenance/api/scan-qr/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                qr_code: qrCode,
                session_id: '{{ session.session_id }}'
            })
        })
        .then(response => {
            alert('Response status: ' + response.status);
            return response.json();
        })
        .then(data => {
            alert('Success! Data: ' + JSON.stringify(data));
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
        
        input.value = '';
    } else {
        alert('Please enter QR code first');
    }
}

// Get CSRF token function
function getCsrfToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    if (token) return token.value;
    
    const cookie = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
    return cookie ? cookie.split('=')[1] : '';
}

// Save session function
function saveSession() {
    alert('Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©...');
    
    fetch('/maintenance/api/save-session/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            session_id: '{{ session.session_id }}',
            operation_type: document.getElementById('operationType').value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­!');
        } else {
            alert('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©: ' + data.error);
        }
    })
    .catch(error => {
        alert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©: ' + error.message);
    });
}

// Reset session function
function resetSession() {
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ù„Ø³Ø©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø©.')) {
        
        fetch('/maintenance/api/reset-session/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                session_id: '{{ session.session_id }}'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­!');
                location.reload(); // Reload page to show reset state
            } else {
                alert('ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ù„Ø³Ø©: ' + data.error);
            }
        })
        .catch(error => {
            alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ù„Ø³Ø©: ' + error.message);
        });
    }
}

// New session function
function newSession() {
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŸ')) {
        
        fetch('/maintenance/api/start-session/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­!');
                location.reload(); // Reload page with new session
            } else {
                alert('ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©: ' + data.error);
            }
        })
        .catch(error => {
            alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©: ' + error.message);
        });
    }
}

// Simple function to handle key press
function handleKeyPress(event) {
    console.log('Key pressed:', event.key);
    if (event.key === 'Enter') {
        console.log('Enter detected, processing scan...');
        const input = document.getElementById('scanInput');
        const qrCode = input.value.trim();
        console.log('QR Code:', qrCode);
        
        if (qrCode) {
            processScanSimple(qrCode);
        }
    }
}

// Function for submit button
function submitScan() {
    alert('submitScan function called!');
    console.log('Submit button clicked');
    const input = document.getElementById('scanInput');
    const qrCode = input.value.trim();
    console.log('QR Code from button:', qrCode);
    alert('QR Code: ' + qrCode);
    
    if (qrCode) {
        processScanSimple(qrCode);
    } else {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ QR Ø£ÙˆÙ„Ø§Ù‹');
    }
}

// Simple scan processing function
async function processScanSimple(qrCode) {
    alert('processScanSimple called with: ' + qrCode);
    console.log('Processing scan:', qrCode);
    
    try {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1] || '';
        
        console.log('CSRF Token:', csrfToken);
        alert('About to send fetch request...');
        
        const response = await fetch('/maintenance/api/scan-qr/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                qr_code: qrCode,
                session_id: '{{ session.session_id }}'
            })
        });
        
        alert('Response received! Status: ' + response.status);
        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);
        alert('Data received: ' + JSON.stringify(data));
        
        if (data.success) {
            alert('Ù†Ø¬Ø­ Ø§Ù„Ù…Ø³Ø­: ' + JSON.stringify(data.notifications));
        } else {
            alert('ÙØ´Ù„ Ø§Ù„Ù…Ø³Ø­: ' + data.error);
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message);
    }
    
    // Clear input
    document.getElementById('scanInput').value = '';
}

class ScanSessionManager {
    constructor() {
        console.log('ScanSessionManager initializing...');
        this.sessionId = '{{ session.session_id }}';
        this.scanInput = document.getElementById('scanInput');
        this.operationType = document.getElementById('operationType');
        this.notifications = document.getElementById('notifications');
        
        console.log('Elements found:', {
            scanInput: !!this.scanInput,
            operationType: !!this.operationType,
            notifications: !!this.notifications
        });
        
        this.initializeEventListeners();
        this.focusInput();
        this.updateSessionDisplay();
        console.log('ScanSessionManager initialized successfully');
    }
    
    initializeEventListeners() {
        console.log('Setting up event listeners...');
        // Auto-focus and scan input handling
        this.scanInput.addEventListener('keypress', (e) => {
            console.log('Key pressed:', e.key);
            if (e.key === 'Enter') {
                console.log('Enter key detected, calling processScan');
                this.processScan();
            }
        });
        
        // Keep input focused
        this.scanInput.addEventListener('blur', () => {
            setTimeout(() => this.focusInput(), 100);
        });
        
        // Action buttons
        document.getElementById('saveSession').addEventListener('click', () => this.saveSession());
        document.getElementById('resetSession').addEventListener('click', () => this.resetSession());
        document.getElementById('newSession').addEventListener('click', () => this.newSession());
        
        // Operation type change
        this.operationType.addEventListener('change', () => this.updateOperationType());
    }
    
    focusInput() {
        this.scanInput.focus();
        this.scanInput.select();
    }
    
    async processScan() {
        const qrCode = this.scanInput.value.trim();
        console.log('Processing scan:', qrCode);
        if (!qrCode) {
            console.log('Empty QR code, returning');
            return;
        }
        
        console.log('Sending request to backend...');
        try {
            const response = await fetch('/maintenance/api/scan-qr/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    qr_code: qrCode,
                    session_id: this.sessionId
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.handleScanSuccess(data);
            } else {
                console.error('Scan failed:', data);
                this.showNotification(data.error || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø³Ø­', 'error');
            }
        } catch (error) {
            console.error('Scan error:', error);
            this.showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
        }
        
        this.scanInput.value = '';
        this.focusInput();
    }
    
    handleScanSuccess(data) {
        // Update session info
        if (data.session_status) {
            this.updateSessionInfo(data.session_status);
        }
        
        // Update scan history
        if (data.scan_history) {
            this.updateScanHistory(data.scan_history);
        }
        
        // Show inferred operation
        if (data.inferred_operation) {
            this.showInferredOperation(data.inferred_operation);
        }
        
        // Show warnings
        if (data.warnings && data.warnings.length > 0) {
            data.warnings.forEach(warning => {
                this.showNotification(warning, 'warning');
            });
        }
        
        // Show notifications
        if (data.notifications && data.notifications.length > 0) {
            data.notifications.forEach(notification => {
                this.showNotification(notification, 'success');
            });
        } else {
            // Default success message
            this.showNotification(`ØªÙ… Ù…Ø³Ø­ ${data.entity_type}: ${data.entity_data.name || data.entity_data.id || data.entity_id}`, 'success');
        }
        
        // Enable save button if we have enough data
        const hasUser = data.session_status && data.session_status.user;
        const hasPatientOrBed = data.session_status && (data.session_status.patient || data.session_status.bed);
        const hasScanCount = data.session_status && data.session_status.scan_count > 0;
        
        document.getElementById('saveSession').disabled = !(hasUser && (hasPatientOrBed || hasScanCount));
    }
    
    updateSessionInfo(sessionState) {
        if (sessionState.user) {
            document.getElementById('currentUser').textContent = sessionState.user;
        }
        if (sessionState.patient) {
            document.getElementById('currentPatient').textContent = sessionState.patient;
        } else {
            document.getElementById('currentPatient').textContent = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }
        if (sessionState.bed) {
            document.getElementById('currentBed').textContent = sessionState.bed;
        } else {
            document.getElementById('currentBed').textContent = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }
        document.getElementById('scanCount').textContent = sessionState.scan_count || 0;
        
        // Update devices list
        if (sessionState.devices && sessionState.devices.length > 0) {
            const devicesList = document.getElementById('devicesList');
            devicesList.innerHTML = sessionState.devices.map(device => 
                `<div>ğŸ”§ ${device.name} (${device.serial_number || device.id})</div>`
            ).join('');
        }
    }
    
    updateScanHistory(scanHistory) {
        const historyDiv = document.getElementById('scanHistory');
        if (scanHistory && scanHistory.length > 0) {
            historyDiv.innerHTML = scanHistory.map(scan => 
                `<span class="scan-chip ${scan.entity_type}">
                    ${scan.entity_type}: ${scan.entity_data.name || scan.entity_data.id}
                </span>`
            ).join('');
        }
    }
    
    showInferredOperation(operation) {
        const operationDiv = document.getElementById('inferredOperation');
        const operationText = document.getElementById('inferredText');
        
        const operationNames = {
            'usage': 'Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©',
            'transfer': 'Ù†Ù‚Ù„ Ø¬Ù‡Ø§Ø²',
            'patient_transfer': 'Ù†Ù‚Ù„ Ù…Ø±ÙŠØ¶',
            'handover': 'ØªØ³Ù„ÙŠÙ… Ø¬Ù‡Ø§Ø²',
            'clean': 'ØªÙ†Ø¸ÙŠÙ',
            'sterilize': 'ØªØ¹Ù‚ÙŠÙ…',
            'maintenance': 'ØµÙŠØ§Ù†Ø©'
        };
        
        operationText.textContent = operationNames[operation] || operation;
        operationDiv.style.display = 'block';
        
        // Auto-select in dropdown
        this.operationType.value = operation;
    }
    
    async updateOperationType() {
        const selectedType = this.operationType.value;
        if (!selectedType) return;
        
        try {
            await fetch('/maintenance/api/scan-qr/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    qr_code: `op:${selectedType}`,
                    session_id: this.sessionId
                })
            });
            
            this.showNotification(`ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${this.operationType.options[this.operationType.selectedIndex].text}`, 'success');
        } catch (error) {
            this.showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', 'error');
        }
    }
    
    async saveSession() {
        const operationType = this.operationType.value;
        
        try {
            const response = await fetch('/maintenance/api/save-session/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    session_id: this.sessionId,
                    operation_type: operationType
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                setTimeout(() => this.newSession(), 2000);
            } else {
                this.showNotification(data.error || 'Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©', 'error');
            }
        } catch (error) {
            this.showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
        }
    }
    
    async resetSession() {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ù„Ø³Ø©ØŸ Ø³ÙŠØªÙ… ÙÙ‚Ø¯Ø§Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø©.')) {
            return;
        }
        
        try {
            const response = await fetch('/maintenance/api/reset-session/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    session_id: this.sessionId
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.sessionId = data.session_id;
                this.updateSessionDisplay();
                this.showNotification('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ù„Ø³Ø©', 'success');
            }
        } catch (error) {
            this.showNotification('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ù„Ø³Ø©', 'error');
        }
    }
    
    async newSession() {
        try {
            const response = await fetch('/maintenance/api/start-session/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({})
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.sessionId = data.session_id;
                this.updateSessionDisplay();
                this.showNotification('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©', 'success');
            }
        } catch (error) {
            this.showNotification('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©', 'error');
        }
    }
    
    updateSessionDisplay() {
        document.getElementById('sessionId').textContent = this.sessionId;
        document.getElementById('currentPatient').textContent = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        document.getElementById('currentBed').textContent = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        document.getElementById('scanCount').textContent = '0';
        document.getElementById('devicesList').innerHTML = '<p class="text-muted">Ù„Ù… ÙŠØªÙ… Ù…Ø³Ø­ Ø£Ø¬Ù‡Ø²Ø© Ø¨Ø¹Ø¯</p>';
        document.getElementById('scanHistory').innerHTML = '<p class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù…Ø³Ø­</p>';
        document.getElementById('inferredOperation').style.display = 'none';
        document.getElementById('saveSession').disabled = true;
        this.operationType.value = '';
    }
    
    showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 18px; cursor: pointer;">&times;</button>
            </div>
        `;
        
        this.notifications.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }
    
    getCSRFToken() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            return csrfToken.value;
        }
        // Fallback to cookie method
        const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];
        return cookieValue || '';
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM Content Loaded, initializing ScanSessionManager...');
    new ScanSessionManager();
});

// Also try window.onload as fallback
window.onload = function() {
    console.log('Window loaded, checking if ScanSessionManager exists...');
    if (!window.scanManager) {
        console.log('Creating ScanSessionManager via window.onload...');
        window.scanManager = new ScanSessionManager();
    }
};
</script>
{% endblock %}
