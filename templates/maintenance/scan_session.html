{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}ŸÖÿ≥ÿ≠ QR/Barcode - ÿ¨ŸÑÿ≥ÿ© ÿßŸÑŸÖÿ≥ÿ≠{% endblock %}

{% block extra_css %}
<style>
    .scan-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .scan-input-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 30px;
        margin-bottom: 30px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .scan-input {
        font-size: 24px;
        padding: 15px;
        border: 3px solid #007bff;
        border-radius: 10px;
        width: 100%;
        max-width: 500px;
        text-align: center;
        margin: 20px 0;
    }
    
    .scan-input:focus {
        outline: none;
        border-color: #0056b3;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    
    .session-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .info-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-left: 4px solid #007bff;
    }
    
    .info-card h4 {
        margin: 0 0 15px 0;
        color: #007bff;
        font-size: 18px;
    }
    
    .scan-history {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .scan-chip {
        display: inline-block;
        background: #e9ecef;
        border-radius: 20px;
        padding: 8px 16px;
        margin: 5px;
        font-size: 14px;
        border: 1px solid #dee2e6;
    }
    
    .scan-chip.device { background: #d4edda; border-color: #c3e6cb; }
    .scan-chip.patient { background: #d1ecf1; border-color: #bee5eb; }
    .scan-chip.bed { background: #fff3cd; border-color: #ffeaa7; }
    .scan-chip.user { background: #f8d7da; border-color: #f5c6cb; }
    .scan-chip.lab_tube { background: #e2e3e5; border-color: #d6d8db; }
    
    .operation-selector {
        margin: 20px 0;
    }
    
    .operation-selector select {
        padding: 10px;
        border-radius: 5px;
        border: 2px solid #dee2e6;
        font-size: 16px;
        min-width: 200px;
    }
    
    .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 20px;
    }
    
    .btn-save {
        background: #28a745;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-save:hover { background: #218838; }
    
    .btn-reset {
        background: #dc3545;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-reset:hover { background: #c82333; }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-secondary:hover { background: #5a6268; }
    
    .notifications {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        max-width: 400px;
    }
    
    .notification {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-left: 4px solid #007bff;
        animation: slideIn 0.3s ease-out;
    }
    
    .notification.success { border-left-color: #28a745; }
    .notification.warning { border-left-color: #ffc107; }
    .notification.error { border-left-color: #dc3545; }
    
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-active { background: #28a745; }
    .status-pending { background: #ffc107; }
    .status-error { background: #dc3545; }
    
    .inferred-operation {
        background: #e7f3ff;
        border: 2px solid #007bff;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        text-align: center;
    }
    
    .inferred-operation h5 {
        color: #007bff;
        margin: 0 0 10px 0;
    }
    
    @media (max-width: 768px) {
        .scan-container { padding: 10px; }
        .session-info { grid-template-columns: 1fr; }
        .action-buttons { flex-direction: column; align-items: center; }
        .scan-input { font-size: 18px; }
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}

<script>
function updateSaveButtonState() {
    const operationType = document.getElementById('operationType').value;
    const saveButton = document.getElementById('saveSession');
    const scanCount = parseInt(document.getElementById('scanCount').textContent) || 0;
    
    // Enable if operation type is selected AND we have at least 3 scans (user + patient + device)
    if (operationType && scanCount >= 3) {
        saveButton.disabled = false;
        saveButton.style.opacity = '1';
        saveButton.style.backgroundColor = '#28a745';
    } else {
        saveButton.disabled = true;
        saveButton.style.opacity = '0.5';
        saveButton.style.backgroundColor = '#6c757d';
    }
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        document.querySelector('button[onclick*="scanInput"]').click();
    }
}
</script>

<div class="scan-container">
    <div class="scan-header">
        <h2>üîç ŸÜÿ∏ÿßŸÖ ŸÖÿ≥ÿ≠ QR/Barcode</h2>
        <p class="subtitle">ÿ¨ŸÑÿ≥ÿ© ÿßŸÑŸÖÿ≥ÿ≠ ÿßŸÑŸÜÿ¥ÿ∑ÿ©</p>
    </div>
    <div class="scan-input-section">
        <p class="text-muted">ÿßŸÖÿ≥ÿ≠ ÿßŸÑÿ±ŸÖŸàÿ≤ ÿ£Ÿà ÿ£ÿØÿÆŸÑ ÿßŸÑÿ±ŸÖŸàÿ≤ ŸäÿØŸàŸäÿßŸã</p>
        
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="text" 
                   id="scanInput" 
                   class="scan-input" 
                   placeholder="ÿßŸÖÿ≥ÿ≠ QR/Barcode ÿ£Ÿà ÿ£ÿØÿÆŸÑ ÿßŸÑÿ±ŸÖÿ≤..."
                   autofocus
                   onkeypress="handleKeyPress(event)"
                   style="flex: 1;">
            <button onclick="
                const input = document.getElementById('scanInput');
                const qrCode = input.value.trim();
                if (!qrCode) { alert('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸÉŸàÿØ QR ÿ£ŸàŸÑÿßŸã'); return; }
                
                const scanCsrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
                
                fetch('/maintenance/api/scan-qr/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': scanCsrfToken
                    },
                    body: JSON.stringify({
                        qr_code: qrCode,
                        session_id: '{{ session.session_id }}'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('ŸÜÿ¨ÿ≠ ÿßŸÑŸÖÿ≥ÿ≠! ' + (data.notifications ? data.notifications.join(', ') : ''));
                        
                        // Update session display
                        if (data.session_status) {
                            if (data.session_status.user) {
                                document.getElementById('currentUser').textContent = data.session_status.user;
                            }
                            if (data.session_status.patient) {
                                document.getElementById('currentPatient').textContent = data.session_status.patient;
                            }
                            if (data.session_status.bed) {
                                document.getElementById('currentBed').textContent = data.session_status.bed;
                            }
                            if (data.session_status.scan_count) {
                                document.getElementById('scanCount').textContent = data.session_status.scan_count;
                            }
                        }
                        
                        // Add to scan history
                        const historyDiv = document.getElementById('scanHistory');
                        if (historyDiv) {
                            const scanItem = document.createElement('span');
                            scanItem.className = 'scan-chip ' + data.entity_type;
                            scanItem.textContent = data.entity_type + ': ' + (data.entity_data.name || data.entity_data.id || data.entity_id);
                            historyDiv.appendChild(scanItem);
                        }
                        
                        // Update operation type if inferred
                        if (data.inferred_operation) {
                            const operationSelect = document.getElementById('operationType');
                            operationSelect.value = data.inferred_operation;
                        }
                        
                        // Enable save button if we have minimum required scans
                        updateSaveButtonState();
                    } else {
                        alert('ŸÅÿ¥ŸÑ ÿßŸÑŸÖÿ≥ÿ≠: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ: ' + error.message);
                });
                
                input.value = '';
            " 
                    style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                üì§ ÿ•ÿ±ÿ≥ÿßŸÑ
            </button>
        </div>
        
        <div class="operation-selector">
            <label for="operationType">ŸÜŸàÿπ ÿßŸÑÿπŸÖŸÑŸäÿ©:</label>
            <select id="operationType">
                <option value="">ÿ™ÿ≠ÿØŸäÿØ ÿ™ŸÑŸÇÿßÿ¶Ÿä</option>
                {% for value, label in operation_choices %}
                    <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="session-info">
        <div class="info-card">
            <h4>üìã ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¨ŸÑÿ≥ÿ©</h4>
            <div id="sessionInfo">
                <p><strong>ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:</strong> <span id="currentUser">{{ request.user.get_full_name }}</span></p>
                <p><strong>ÿßŸÑÿ¨ŸÑÿ≥ÿ©:</strong> <span id="sessionId">{{ session.session_id }}</span></p>
                <p><strong>ÿßŸÑÿ≠ÿßŸÑÿ©:</strong> <span class="status-indicator status-active"></span><span id="sessionStatus">ŸÜÿ¥ÿ∑ÿ©</span></p>
                <p><strong>ÿπÿØÿØ ÿßŸÑŸÖÿ≥ÿ≠:</strong> <span id="scanCount">0</span></p>
            </div>
        </div>

        <div class="info-card">
            <h4>üë§ ÿßŸÑŸÖÿ±Ÿäÿ∂ ŸàÿßŸÑÿ≥ÿ±Ÿäÿ±</h4>
            <div id="patientInfo">
                <p><strong>ÿßŸÑŸÖÿ±Ÿäÿ∂:</strong> <span id="currentPatient">ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ</span></p>
                <p><strong>ÿßŸÑÿ≥ÿ±Ÿäÿ±:</strong> <span id="currentBed">ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ</span></p>
            </div>
        </div>

        <div class="info-card">
            <h4>üîß ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÖÿ≥ÿ≠Ÿàÿ®ÿ©</h4>
            <div id="devicesList">
                <p class="text-muted">ŸÑŸÖ Ÿäÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ£ÿ¨Ÿáÿ≤ÿ© ÿ®ÿπÿØ</p>
            </div>
        </div>
    </div>

    <div id="inferredOperation" class="inferred-operation" style="display: none;">
        <h5>üéØ ÿßŸÑÿπŸÖŸÑŸäÿ© ÿßŸÑŸÖŸÇÿ™ÿ±ÿ≠ÿ©</h5>
        <p id="inferredText"></p>
    </div>

    <div class="scan-history">
        <h4>üìú ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ≥ÿ≠</h4>
        <div id="scanHistory">
            {% for scan in recent_scans %}
                <span class="scan-chip {{ scan.entity_type }}">
                    {{ scan.entity_type }}: {{ scan.entity_data.name|default:scan.entity_data.id }}
                </span>
            {% empty %}
                <p class="text-muted">ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≥ÿ¨ŸÑ ŸÖÿ≥ÿ≠</p>
            {% endfor %}
        </div>
    </div>

    <div class="action-buttons">
        <button id="saveSession" class="btn-save" disabled onclick="
            const operationType = document.getElementById('operationType').value;
            const saveCsrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
            fetch('/maintenance/api/save-session/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': saveCsrfToken
                },
                body: JSON.stringify({
                    session_id: '{{ session.session_id }}',
                    operation_type: operationType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ¨ŸÑÿ≥ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
                } else {
                    alert('ŸÅÿ¥ŸÑ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ¨ŸÑÿ≥ÿ©: ' + data.error);
                }
            })
            .catch(error => {
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ¨ŸÑÿ≥ÿ©: ' + error.message);
            });
        ">üíæ ÿ≠ŸÅÿ∏ ÿßŸÑÿ¨ŸÑÿ≥ÿ©</button>
        <button id="resetSession" class="btn-reset" onclick="
            if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ¨ŸÑÿ≥ÿ©ÿü ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ≠Ÿàÿ®ÿ©.')) {
                const resetCsrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
                fetch('/maintenance/api/reset-session/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': resetCsrfToken
                    },
                    body: JSON.stringify({
                        session_id: '{{ session.session_id }}'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('ÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ¨ŸÑÿ≥ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
                        location.reload();
                    } else {
                        alert('ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ¨ŸÑÿ≥ÿ©: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ¨ŸÑÿ≥ÿ©: ' + error.message);
                });
            }
        ">üîÑ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ</button>
        <button id="newSession" class="btn-secondary" onclick="
            if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ®ÿØÿ° ÿ¨ŸÑÿ≥ÿ© ÿ¨ÿØŸäÿØÿ©ÿü')) {
                const newCsrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
                fetch('/maintenance/api/start-session/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': newCsrfToken
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿ¨ŸÑÿ≥ÿ© ÿ¨ÿØŸäÿØÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
                        location.reload();
                    } else {
                        alert('ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿ¨ŸÑÿ≥ÿ© ÿ¨ÿØŸäÿØÿ©: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿ¨ŸÑÿ≥ÿ© ÿ¨ÿØŸäÿØÿ©: ' + error.message);
                });
            }
        ">‚ûï ÿ¨ŸÑÿ≥ÿ© ÿ¨ÿØŸäÿØÿ©</button>
        <a href="{% url 'laboratory:sample_scan' %}" class="btn-secondary">üß™ ŸÖÿ≥ÿ≠ ÿπŸäŸÜÿßÿ™ ÿßŸÑŸÖÿÆÿ™ÿ®ÿ±</a>
    </div>
</div>

<div id="notifications" class="notifications"></div>
{% endblock %}

{% block extra_js %}
<script>
console.log('JavaScript file loaded successfully');
console.log('Session ID from template:', '{{ session.session_id }}');

// Test function to check if JavaScript works
function testFunction() {
    alert('Test function called!');
    const input = document.getElementById('scanInput');
    const qrCode = input.value.trim();
    alert('QR Code: ' + qrCode);
    
    if (qrCode) {
        // Simple fetch without async/await
        fetch('/maintenance/api/scan-qr/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                qr_code: qrCode,
                session_id: '{{ session.session_id }}'
            })
        })
        .then(response => {
            alert('Response status: ' + response.status);
            return response.json();
        })
        .then(data => {
            alert('Success! Data: ' + JSON.stringify(data));
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
        
        input.value = '';
    } else {
        alert('Please enter QR code first');
    }
}

// Get CSRF token function
function getCsrfToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    if (token) return token.value;
    
    const cookie = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
    return cookie ? cookie.split('=')[1] : '';
}

// Save session function
function saveSession() {
    alert('ÿ≠ŸÅÿ∏ ÿßŸÑÿ¨ŸÑÿ≥ÿ©...');
    
    fetch('/maintenance/api/save-session/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            session_id: '{{ session.session_id }}',
            operation_type: document.getElementById('operationType').value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ¨ŸÑÿ≥ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
        } else {
            alert('ŸÅÿ¥ŸÑ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ¨ŸÑÿ≥ÿ©: ' + data.error);
        }
    })
    .catch(error => {
        alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ¨ŸÑÿ≥ÿ©: ' + error.message);
    });
}

// Reset session function
function resetSession() {
    if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ¨ŸÑÿ≥ÿ©ÿü ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ≠Ÿàÿ®ÿ©.')) {
        
        fetch('/maintenance/api/reset-session/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                session_id: '{{ session.session_id }}'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('ÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ¨ŸÑÿ≥ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
                location.reload(); // Reload page to show reset state
            } else {
                alert('ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ¨ŸÑÿ≥ÿ©: ' + data.error);
            }
        })
        .catch(error => {
            alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ¨ŸÑÿ≥ÿ©: ' + error.message);
        });
    }
}

// New session function
function newSession() {
    if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ®ÿØÿ° ÿ¨ŸÑÿ≥ÿ© ÿ¨ÿØŸäÿØÿ©ÿü')) {
        
        fetch('/maintenance/api/start-session/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿ¨ŸÑÿ≥ÿ© ÿ¨ÿØŸäÿØÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
                location.reload(); // Reload page with new session
            } else {
                alert('ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿ¨ŸÑÿ≥ÿ© ÿ¨ÿØŸäÿØÿ©: ' + data.error);
            }
        })
        .catch(error => {
            alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿ¨ŸÑÿ≥ÿ© ÿ¨ÿØŸäÿØÿ©: ' + error.message);
        });
    }
}

// Simple function to handle key press
function handleKeyPress(event) {
    console.log('Key pressed:', event.key);
    if (event.key === 'Enter') {
        console.log('Enter detected, processing scan...');
        const input = document.getElementById('scanInput');
        const qrCode = input.value.trim();
        console.log('QR Code:', qrCode);
        
        if (qrCode) {
            processScanSimple(qrCode);
        }
    }
}

// Function for submit button
function submitScan() {
    alert('submitScan function called!');
    console.log('Submit button clicked');
    const input = document.getElementById('scanInput');
    const qrCode = input.value.trim();
    console.log('QR Code from button:', qrCode);
    alert('QR Code: ' + qrCode);
    
    if (qrCode) {
        processScanSimple(qrCode);
    } else {
        alert('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸÉŸàÿØ QR ÿ£ŸàŸÑÿßŸã');
    }
}

// Simple scan processing function
async function processScanSimple(qrCode) {
    alert('processScanSimple called with: ' + qrCode);
    console.log('Processing scan:', qrCode);
    
    try {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1] || '';
        
        console.log('CSRF Token:', csrfToken);
        alert('About to send fetch request...');
        
        const response = await fetch('/maintenance/api/scan-qr/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                qr_code: qrCode,
                session_id: '{{ session.session_id }}'
            })
        });
        
        alert('Response received! Status: ' + response.status);
        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);
        alert('Data received: ' + JSON.stringify(data));
        
        if (data.success) {
            alert('ŸÜÿ¨ÿ≠ ÿßŸÑŸÖÿ≥ÿ≠: ' + JSON.stringify(data.notifications));
        } else {
            alert('ŸÅÿ¥ŸÑ ÿßŸÑŸÖÿ≥ÿ≠: ' + data.error);
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ: ' + error.message);
    }
    
    // Clear input
    document.getElementById('scanInput').value = '';
}

class ScanSessionManager {
    constructor() {
        console.log('ScanSessionManager initializing...');
        this.sessionId = '{{ session.session_id }}';
        this.scanInput = document.getElementById('scanInput');
        this.operationType = document.getElementById('operationType');
        this.notifications = document.getElementById('notifications');
        
        console.log('Elements found:', {
            scanInput: !!this.scanInput,
            operationType: !!this.operationType,
            notifications: !!this.notifications
        });
        
        this.initializeEventListeners();
        this.focusInput();
        this.updateSessionDisplay();
        console.log('ScanSessionManager initialized successfully');
    }
    
    initializeEventListeners() {
        console.log('Setting up event listeners...');
        // Auto-focus and scan input handling
        this.scanInput.addEventListener('keypress', (e) => {
            console.log('Key pressed:', e.key);
            if (e.key === 'Enter') {
                console.log('Enter key detected, calling processScan');
                this.processScan();
            }
        });
        
        // Keep input focused
        this.scanInput.addEventListener('blur', () => {
            setTimeout(() => this.focusInput(), 100);
        });
        
        // Action buttons
        document.getElementById('saveSession').addEventListener('click', () => this.saveSession());
        document.getElementById('resetSession').addEventListener('click', () => this.resetSession());
        document.getElementById('newSession').addEventListener('click', () => this.newSession());
        
        // Operation type change
        this.operationType.addEventListener('change', () => this.updateOperationType());
    }
    
    focusInput() {
        this.scanInput.focus();
        this.scanInput.select();
    }
    
    async processScan() {
        const qrCode = this.scanInput.value.trim();
        console.log('Processing scan:', qrCode);
        if (!qrCode) {
            console.log('Empty QR code, returning');
            return;
        }
        
        console.log('Sending request to backend...');
        try {
            const response = await fetch('/maintenance/api/scan-qr/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    qr_code: qrCode,
                    session_id: this.sessionId
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.handleScanSuccess(data);
            } else {
                console.error('Scan failed:', data);
                this.showNotification(data.error || 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÖÿ≥ÿ≠', 'error');
            }
        } catch (error) {
            console.error('Scan error:', error);
            this.showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ', 'error');
        }
        
        this.scanInput.value = '';
        this.focusInput();
    }
    
    handleScanSuccess(data) {
        // Update session info
        if (data.session_status) {
            this.updateSessionInfo(data.session_status);
        }
        
        // Update scan history
        if (data.scan_history) {
            this.updateScanHistory(data.scan_history);
        }
        
        // Show inferred operation
        if (data.inferred_operation) {
            this.showInferredOperation(data.inferred_operation);
        }
        
        // Show warnings
        if (data.warnings && data.warnings.length > 0) {
            data.warnings.forEach(warning => {
                this.showNotification(warning, 'warning');
            });
        }
        
        // Show notifications
        if (data.notifications && data.notifications.length > 0) {
            data.notifications.forEach(notification => {
                this.showNotification(notification, 'success');
            });
        } else {
            // Default success message
            this.showNotification(`ÿ™ŸÖ ŸÖÿ≥ÿ≠ ${data.entity_type}: ${data.entity_data.name || data.entity_data.id || data.entity_id}`, 'success');
        }
        
        // Enable save button if we have enough data
        const hasUser = data.session_status && data.session_status.user;
        const hasPatientOrBed = data.session_status && (data.session_status.patient || data.session_status.bed);
        const hasScanCount = data.session_status && data.session_status.scan_count > 0;
        
        document.getElementById('saveSession').disabled = !(hasUser && (hasPatientOrBed || hasScanCount));
    }
    
    updateSessionInfo(sessionState) {
        if (sessionState.user) {
            document.getElementById('currentUser').textContent = sessionState.user;
        }
        if (sessionState.patient) {
            document.getElementById('currentPatient').textContent = sessionState.patient;
        } else {
            document.getElementById('currentPatient').textContent = 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
        }
        if (sessionState.bed) {
            document.getElementById('currentBed').textContent = sessionState.bed;
        } else {
            document.getElementById('currentBed').textContent = 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
        }
        document.getElementById('scanCount').textContent = sessionState.scan_count || 0;
        
        // Update devices list
        if (sessionState.devices && sessionState.devices.length > 0) {
            const devicesList = document.getElementById('devicesList');
            devicesList.innerHTML = sessionState.devices.map(device => 
                `<div>üîß ${device.name} (${device.serial_number || device.id})</div>`
            ).join('');
        }
    }
    
    updateScanHistory(scanHistory) {
        const historyDiv = document.getElementById('scanHistory');
        if (scanHistory && scanHistory.length > 0) {
            historyDiv.innerHTML = scanHistory.map(scan => 
                `<span class="scan-chip ${scan.entity_type}">
                    ${scan.entity_type}: ${scan.entity_data.name || scan.entity_data.id}
                </span>`
            ).join('');
        }
    }
    
    showInferredOperation(operation) {
        const operationDiv = document.getElementById('inferredOperation');
        const operationText = document.getElementById('inferredText');
        
        const operationNames = {
            'usage': 'ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ©',
            'transfer': 'ŸÜŸÇŸÑ ÿ¨Ÿáÿßÿ≤',
            'patient_transfer': 'ŸÜŸÇŸÑ ŸÖÿ±Ÿäÿ∂',
            'handover': 'ÿ™ÿ≥ŸÑŸäŸÖ ÿ¨Ÿáÿßÿ≤',
            'clean': 'ÿ™ŸÜÿ∏ŸäŸÅ',
            'sterilize': 'ÿ™ÿπŸÇŸäŸÖ',
            'maintenance': 'ÿµŸäÿßŸÜÿ©'
        };
        
        operationText.textContent = operationNames[operation] || operation;
        operationDiv.style.display = 'block';
        
        // Auto-select in dropdown
        this.operationType.value = operation;
    }
    
    async updateOperationType() {
        const selectedType = this.operationType.value;
        if (!selectedType) return;
        
        try {
            await fetch('/maintenance/api/scan-qr/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    qr_code: `op:${selectedType}`,
                    session_id: this.sessionId
                })
            });
            
            this.showNotification(`ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ŸÜŸàÿπ ÿßŸÑÿπŸÖŸÑŸäÿ©: ${this.operationType.options[this.operationType.selectedIndex].text}`, 'success');
        } catch (error) {
            this.showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ŸÜŸàÿπ ÿßŸÑÿπŸÖŸÑŸäÿ©', 'error');
        }
    }
    
    async saveSession() {
        const operationType = this.operationType.value;
        
        try {
            const response = await fetch('/maintenance/api/save-session/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    session_id: this.sessionId,
                    operation_type: operationType
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.showNotification('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ¨ŸÑÿ≥ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!', 'success');
                setTimeout(() => this.newSession(), 2000);
            } else {
                this.showNotification(data.error || 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ¨ŸÑÿ≥ÿ©', 'error');
            }
        } catch (error) {
            this.showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ', 'error');
        }
    }
    
    async resetSession() {
        if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ¨ŸÑÿ≥ÿ©ÿü ÿ≥Ÿäÿ™ŸÖ ŸÅŸÇÿØÿßŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ≠Ÿàÿ®ÿ©.')) {
            return;
        }
        
        try {
            const response = await fetch('/maintenance/api/reset-session/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    session_id: this.sessionId
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.sessionId = data.session_id;
                this.updateSessionDisplay();
                this.showNotification('ÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ¨ŸÑÿ≥ÿ©', 'success');
            }
        } catch (error) {
            this.showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ¨ŸÑÿ≥ÿ©', 'error');
        }
    }
    
    async newSession() {
        try {
            const response = await fetch('/maintenance/api/start-session/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({})
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.sessionId = data.session_id;
                this.updateSessionDisplay();
                this.showNotification('ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿ¨ŸÑÿ≥ÿ© ÿ¨ÿØŸäÿØÿ©', 'success');
            }
        } catch (error) {
            this.showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿ¨ŸÑÿ≥ÿ© ÿ¨ÿØŸäÿØÿ©', 'error');
        }
    }
    
    updateSessionDisplay() {
        document.getElementById('sessionId').textContent = this.sessionId;
        document.getElementById('currentPatient').textContent = 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
        document.getElementById('currentBed').textContent = 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
        document.getElementById('scanCount').textContent = '0';
        document.getElementById('devicesList').innerHTML = '<p class="text-muted">ŸÑŸÖ Ÿäÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ£ÿ¨Ÿáÿ≤ÿ© ÿ®ÿπÿØ</p>';
        document.getElementById('scanHistory').innerHTML = '<p class="text-muted">ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≥ÿ¨ŸÑ ŸÖÿ≥ÿ≠</p>';
        document.getElementById('inferredOperation').style.display = 'none';
        document.getElementById('saveSession').disabled = true;
        this.operationType.value = '';
    }
    
    showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 18px; cursor: pointer;">&times;</button>
            </div>
        `;
        
        this.notifications.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }
    
    getCSRFToken() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            return csrfToken.value;
        }
        // Fallback to cookie method
        const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];
        return cookieValue || '';
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM Content Loaded, initializing ScanSessionManager...');
    new ScanSessionManager();
});

// Also try window.onload as fallback
window.onload = function() {
    console.log('Window loaded, checking if ScanSessionManager exists...');
    if (!window.scanManager) {
        console.log('Creating ScanSessionManager via window.onload...');
        window.scanManager = new ScanSessionManager();
    }
};
</script>
{% endblock %}
