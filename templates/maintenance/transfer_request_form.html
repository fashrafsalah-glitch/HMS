{% extends "base.html" %}
{% load static %}

{% block title %}طلب نقل جهاز - {{ device.name }}{% endblock %}

{% block content %}
<!-- jQuery CDN -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<div class="container-fluid mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <!-- Device Info Card -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-medical"></i> معلومات الجهاز
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>اسم الجهاز:</strong> {{ device.name }}</p>
                            <p><strong>الرقم التسلسلي:</strong> {{ device.serial_number }}</p>
                            <p><strong>الموديل:</strong> {{ device.model }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>القسم الحالي:</strong> {{ device.department.name }}</p>
                            <p><strong>الغرفة الحالية:</strong> {{ device.room.name|default:"غير محدد" }}</p>
                            <p><strong>الحالة:</strong> 
                                {% if device.status == 'working' %}
                                    <span class="badge badge-success">{{ device.get_status_display|default:"يعمل" }}</span>
                                {% else %}
                                    <span class="badge badge-danger">{{ device.get_status_display|default:"يعمل" }}</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    
                    <!-- Device Eligibility Status -->
                    {% if not device_ready %}
                    <div class="alert alert-danger mt-3">
                        <h6><i class="fas fa-exclamation-triangle"></i> الجهاز غير قابل للنقل حالياً:</h6>
                        <ul class="mb-0">
                            {% for error in eligibility_errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                        <div class="mt-2">
                            <small class="text-muted">يرجى حل هذه المشاكل قبل المتابعة مع طلب النقل</small>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-success mt-3">
                        <h6><i class="fas fa-check-circle"></i> الجهاز جاهز للنقل</h6>
                        <p class="mb-0">جميع الشروط مستوفاة لنقل الجهاز</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Transfer Request Form -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-exchange-alt"></i> طلب نقل الجهاز
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="transferRequestForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <!-- Destination Department -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.to_department.id_for_label }}" class="form-label">
                                    {{ form.to_department.label }} <span class="text-danger">*</span>
                                </label>
                                <select name="to_department" id="id_to_department" class="form-control" required>
                                    <option value="">-- اختر القسم --</option>
                                    {% for dept in form.to_department.field.queryset %}
                                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                                    {% endfor %}
                                </select>
                                {% if form.to_department.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.to_department.errors.0 }}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Destination Room -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.to_room.id_for_label }}" class="form-label">
                                    {{ form.to_room.label }}
                                </label>
                                <select name="to_room" id="id_to_room" class="form-control">
                                    <option value="">-- اختر الغرفة --</option>
                                </select>
                                {% if form.to_room.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.to_room.errors.0 }}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <!-- Patient -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.patient.id_for_label }}" class="form-label">
                                    {{ form.patient.label }}
                                </label>
                                <select name="patient" id="id_patient" class="form-control">
                                    <option value="">-- اختر المريض --</option>
                                </select>
                                <small class="form-text text-muted">اختر المريض إذا كان النقل لمريض محدد</small>
                                {% if form.patient.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.patient.errors.0 }}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Bed -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.to_bed.id_for_label }}" class="form-label">
                                    {{ form.to_bed.label }}
                                </label>
                                <select name="to_bed" id="id_to_bed" class="form-control">
                                    <option value="">-- اختر السرير --</option>
                                </select>
                                {% if form.to_bed.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.to_bed.errors.0 }}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <!-- Reason -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.reason.id_for_label }}" class="form-label">
                                    {{ form.reason.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form.reason }}
                                {% if form.reason.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.reason.errors.0 }}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Priority -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.priority.id_for_label }}" class="form-label">
                                    {{ form.priority.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form.priority }}
                                {% if form.priority.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.priority.errors.0 }}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Reason Details -->
                        <div class="mb-3">
                            <label for="{{ form.reason_details.id_for_label }}" class="form-label">
                                {{ form.reason_details.label }}
                            </label>
                            {{ form.reason_details }}
                            {% if form.reason_details.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.reason_details.errors.0 }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Include Accessories -->
                        <div class="mb-3">
                            <div class="form-check">
                                {{ form.include_accessories }}
                                <label class="form-check-label" for="{{ form.include_accessories.id_for_label }}">
                                    {{ form.include_accessories.label }}
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle"></i> 
                                إذا كان للجهاز إكسسوارات مرتبطة به، يمكن نقلها معه
                            </small>
                            {% if form.include_accessories.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.include_accessories.errors.0 }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Device Readiness Status -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">حالة جاهزية الجهاز</h6>
                            </div>
                            <div class="card-body">
                                {% if device_ready %}
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="d-flex align-items-center text-success">
                                                <i class="fas fa-check-circle me-2"></i>
                                                <span>تم فحص الجهاز</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="d-flex align-items-center text-success">
                                                <i class="fas fa-check-circle me-2"></i>
                                                <span>تم تنظيف الجهاز</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="d-flex align-items-center text-success">
                                                <i class="fas fa-check-circle me-2"></i>
                                                <span>تم تعقيم الجهاز</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-success"><i class="fas fa-info-circle"></i> الجهاز جاهز للنقل</small>
                                    </div>
                                {% else %}
                                    <div class="text-danger">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <strong>الجهاز غير جاهز للنقل حالياً</strong>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">يرجى حل المشاكل المذكورة أعلاه أولاً</small>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'maintenance:device_detail' device.id %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> رجوع
                            </a>
                            <button type="submit" class="btn btn-primary" {% if not device_ready %}disabled{% endif %}>
                                <i class="fas fa-paper-plane"></i> إرسال طلب النقل
                            </button>
                            {% if not device_ready %}
                            <small class="text-danger mt-1 d-block">
                                <i class="fas fa-info-circle"></i> لا يمكن إرسال طلب النقل - الجهاز غير جاهز
                            </small>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    console.log('Transfer form script loaded');
    
    // Auto-select department if coming from department page
    {% if from_department_id %}
    var fromDepartmentId = '{{ from_department_id }}';
    if (fromDepartmentId) {
        setTimeout(function() {
            document.getElementById('id_to_department').value = fromDepartmentId;
            $('#id_to_department').trigger('change');
        }, 100);
    }
    {% endif %}
    
    // Dynamic room loading based on department
    $('#id_to_department').change(function() {
        console.log('Department changed:', $(this).val());
        var departmentId = $(this).val();
        var roomSelect = $('#id_to_room');
        var patientSelect = $('#id_patient');
        var bedSelect = $('#id_to_bed');
        
        // Clear room, patient and bed dropdowns
        roomSelect.empty();
        roomSelect.append('<option value="">-- اختر الغرفة --</option>');
        patientSelect.empty();
        patientSelect.append('<option value="">-- اختر المريض --</option>');
        bedSelect.empty();
        bedSelect.append('<option value="">-- اختر السرير --</option>');
        
        if (departmentId) {
            console.log('Loading rooms and patients for department:', departmentId);
            
            // Load rooms
            $.ajax({
                url: '{% url "maintenance:get_department_rooms" %}',
                data: { 'department_id': departmentId },
                dataType: 'json',
                success: function(data) {
                    console.log('Rooms loaded successfully:', data);
                    if (data.rooms && data.rooms.length > 0) {
                        $.each(data.rooms, function(index, room) {
                            roomSelect.append('<option value="' + room.id + '">' + room.name + '</option>');
                        });
                    } else {
                        console.log('No rooms found for department');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading rooms:', error);
                    console.error('Response:', xhr.responseText);
                }
            });
            
            // Load patients
            $.ajax({
                url: '{% url "maintenance:get_department_patients" %}',
                data: { 'department_id': departmentId },
                dataType: 'json',
                success: function(data) {
                    console.log('Patients loaded successfully:', data);
                    if (data.patients && data.patients.length > 0) {
                        $.each(data.patients, function(index, patient) {
                            patientSelect.append('<option value="' + patient.id + '">' + patient.name + '</option>');
                        });
                    } else {
                        console.log('No patients found for department');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading patients:', error);
                    console.error('Response:', xhr.responseText);
                }
            });
        }
    });
    
    // Dynamic bed loading based on room
    $('#id_to_room').change(function() {
        console.log('Room changed:', $(this).val());
        var roomId = $(this).val();
        var bedSelect = $('#id_to_bed');
        
        bedSelect.empty();
        bedSelect.append('<option value="">-- اختر السرير --</option>');
        
        if (roomId) {
            console.log('Loading beds for room:', roomId);
            $.ajax({
                url: '{% url "maintenance:get_room_beds" %}',
                data: { 'room_id': roomId },
                dataType: 'json',
                success: function(data) {
                    console.log('Beds loaded successfully:', data);
                    if (data.beds && data.beds.length > 0) {
                        $.each(data.beds, function(index, bed) {
                            bedSelect.append('<option value="' + bed.id + '">' + bed.name + '</option>');
                        });
                    } else {
                        console.log('No beds found for room');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading beds:', error);
                    console.error('Response:', xhr.responseText);
                }
            });
        }
    });
    
    // Show/hide reason details based on reason selection
    $('#id_reason').change(function() {
        if ($(this).val() === 'other') {
            $('#id_reason_details').closest('.mb-3').show();
            $('#id_reason_details').attr('required', true);
        } else {
            $('#id_reason_details').closest('.mb-3').hide();
            $('#id_reason_details').attr('required', false);
        }
    }).trigger('change');
});
</script>
{% endblock %}
