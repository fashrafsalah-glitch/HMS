{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ operation.name }} | HMS{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>
                <i class="fas fa-cogs"></i> {{ operation.name }}
                <span class="badge badge-secondary">{{ operation.get_code_display }}</span>
            </h2>
            <p class="text-muted">{{ operation.description|default:"No description available" }}</p>
        </div>
        <div class="col-md-4 text-right">
            <a href="{% url 'maintenance:operation_edit' operation.id %}" class="btn btn-warning">
                <i class="fas fa-edit"></i> {% trans "Edit" %}
            </a>
            <a href="{% url 'maintenance:operations_list' %}" class="btn btn-secondary">
                <i class="fas fa-list"></i> {% trans "Back to List" %}
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Operation Details -->
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> {% trans "Operation Details" %}</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <th width="40%">{% trans "Status" %}:</th>
                            <td>
                                {% if operation.is_active %}
                                    <span class="badge badge-success">{% trans "Active" %}</span>
                                {% else %}
                                    <span class="badge badge-danger">{% trans "Inactive" %}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>{% trans "Auto Execute" %}:</th>
                            <td>
                                {% if operation.auto_execute %}
                                    <span class="badge badge-success">{% trans "Yes" %}</span>
                                {% else %}
                                    <span class="badge badge-secondary">{% trans "No" %}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>{% trans "Requires Confirmation" %}:</th>
                            <td>
                                {% if operation.requires_confirmation %}
                                    <span class="badge badge-warning">{% trans "Yes" %}</span>
                                {% else %}
                                    <span class="badge badge-info">{% trans "No" %}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>{% trans "Session Timeout" %}:</th>
                            <td>{{ operation.session_timeout_minutes }} {% trans "minutes" %}</td>
                        </tr>
                        <tr>
                            <th>{% trans "Requires Badge" %}:</th>
                            <td>
                                {% if operation.requires_badge %}
                                    <span class="badge badge-warning">{% trans "Yes" %}</span>
                                {% else %}
                                    <span class="badge badge-secondary">{% trans "No" %}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>{% trans "Multiple Executions" %}:</th>
                            <td>
                                {% if operation.allow_multiple_executions %}
                                    <span class="badge badge-success">{% trans "Allowed" %}</span>
                                {% else %}
                                    <span class="badge badge-danger">{% trans "Not Allowed" %}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>{% trans "Logging Settings" %}:</th>
                            <td>
                                {% if operation.log_to_usage %}
                                    <span class="badge badge-info">Usage</span>
                                {% endif %}
                                {% if operation.log_to_transfer %}
                                    <span class="badge badge-info">Transfer</span>
                                {% endif %}
                                {% if operation.log_to_handover %}
                                    <span class="badge badge-info">Handover</span>
                                {% endif %}
                                {% if not operation.log_to_usage and not operation.log_to_transfer and not operation.log_to_handover %}
                                    <span class="text-muted">{% trans "No logging" %}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>{% trans "Created" %}:</th>
                            <td>{{ operation.created_at|date:"Y-m-d H:i" }}</td>
                        </tr>
                        <tr>
                            <th>{% trans "Updated" %}:</th>
                            <td>{{ operation.updated_at|date:"Y-m-d H:i" }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Operation Steps -->
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-tasks"></i> {% trans "Operation Steps" %}</h5>
                    <button type="button" class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#addStepModal">
                        <i class="fas fa-plus"></i> {% trans "Add Step" %}
                    </button>
                </div>
                <div class="card-body">
                    {% if steps %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>{% trans "Order" %}</th>
                                    <th>{% trans "Entity Type" %}</th>
                                    <th>{% trans "Required" %}</th>
                                    <th>{% trans "Description" %}</th>
                                    <th>{% trans "Actions" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for step in steps %}
                                <tr>
                                    <td>{{ step.order }}</td>
                                    <td>
                                        <span class="badge badge-secondary">{{ step.get_entity_type_display }}</span>
                                    </td>
                                    <td>
                                        {% if step.is_required %}
                                            <i class="fas fa-check text-danger"></i>
                                        {% else %}
                                            <i class="fas fa-minus text-muted"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ step.description|default:"-" }}</small>
                                    </td>
                                    <td>
                                        <a href="{% url 'maintenance:delete_operation_step' step.id %}" 
                                           class="btn btn-sm btn-danger" 
                                           onclick="return confirm('Are you sure you want to delete this step?')">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center">{% trans "No steps defined for this operation" %}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Executions -->
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-history"></i> {% trans "Recent Executions" %}</h5>
                </div>
                <div class="card-body">
                    {% if recent_executions %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>{% trans "Date/Time" %}</th>
                                    <th>{% trans "User" %}</th>
                                    <th>{% trans "Session" %}</th>
                                    <th>{% trans "Status" %}</th>
                                    <th>{% trans "Scanned Entities" %}</th>
                                    <th>{% trans "Actions" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for execution in recent_executions %}
                                <tr>
                                    <td>{{ execution.created_at|date:"Y-m-d H:i:s" }}</td>
                                    <td>{{ execution.user.username }}</td>
                                    <td>
                                        <a href="{% url 'maintenance:session_detail' execution.session.id %}">
                                            {{ execution.session.session_id|truncatechars:12 }}
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge badge-{% if execution.status == 'completed' %}success{% elif execution.status == 'pending' %}warning{% else %}danger{% endif %}">
                                            {{ execution.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% for entity in execution.scanned_entities %}
                                            <span class="badge badge-info">{{ entity.type }}:{{ entity.id }}</span>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <a href="{% url 'maintenance:execution_detail' execution.id %}" class="btn btn-sm btn-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center">{% trans "No executions yet" %}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Allowed Badges Section -->
{% if operation.requires_badge %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0"><i class="fas fa-id-badge"></i> {% trans "Allowed Badges" %}</h5>
            </div>
            <div class="card-body">
                {% if operation.allowed_badges.exists %}
                <div class="row">
                    {% for badge in operation.allowed_badges.all %}
                    <div class="col-md-3 mb-2">
                        <div class="badge-item p-2 border rounded">
                            <strong>{{ badge.badge_id }}</strong><br>
                            <small class="text-muted">
                                {% if badge.user %}
                                    <i class="fas fa-user"></i> {{ badge.user.get_full_name|default:badge.user.username }}
                                {% else %}
                                    {% trans "Unassigned" %}
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center">{% trans "No badges assigned yet" %}</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Add Step Modal -->
<div class="modal fade" id="addStepModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'maintenance:add_operation_step' operation.id %}">
                {% csrf_token %}
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">{% trans "Add Operation Step" %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>{% trans "Order" %}</label>
                        <input type="number" name="order" class="form-control" min="1" value="{{ steps.count|add:1 }}" required>
                    </div>
                    <div class="form-group">
                        <label>{% trans "Entity Type" %}</label>
                        <select name="entity_type" id="entityTypeSelect" class="form-control" required>
                            <option value="">{% trans "Select Entity Type" %}</option>
                            <!-- Options will be populated dynamically based on operation type -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>{% trans "Description" %}</label>
                        <input type="text" name="description" class="form-control" placeholder="{% trans 'Optional description' %}">
                    </div>
                    <div class="form-group">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" name="is_required" class="custom-control-input" id="isRequired" checked>
                            <label class="custom-control-label" for="isRequired">
                                {% trans "Required Step" %}
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {% trans "Cancel" %}
                    </button>
                    <button type="submit" class="btn btn-info">
                        <i class="fas fa-plus"></i> {% trans "Add Step" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

</div>

<!-- Add jQuery for modal events -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Smart entity type selection based on operation code
    const operationCode = '{{ operation.code }}';
    
    // Define which entity types are relevant for each operation
    const operationEntityTypes = {
        'BADGE_AUTH': ['user'],
        'DEVICE_USAGE': ['user', 'device', 'patient'],
        'END_DEVICE_USAGE': ['user', 'device', 'patient'],
        'DEVICE_TRANSFER': ['user', 'device', 'department'],
        'PATIENT_TRANSFER': ['user', 'patient', 'bed', 'room'],
        'DEVICE_HANDOVER': ['user', 'device'], // Two users for from/to
        'ACCESSORY_USAGE': ['user', 'accessory', 'patient'],
        'DEVICE_CLEANING': ['user', 'device'],
        'DEVICE_STERILIZATION': ['user', 'device'],
        'MAINTENANCE_OPEN': ['user', 'device'],
        'MAINTENANCE_CLOSE': ['user', 'device'],
        'DEVICE_LENDING': ['user', 'device', 'department'],
        'OUT_OF_SERVICE': ['user', 'device'], // Two users for double auth
        'INVENTORY_CHECK': ['user', 'device', 'accessory'],
        'QUALITY_CONTROL': ['user', 'device'],
        'CALIBRATION': ['user', 'device'],
        'INSPECTION': ['user', 'device'],
        'AUDIT_REPORT': ['user', 'device'],
        'CUSTOM': ['user', 'patient', 'device', 'accessory', 'bed', 'department', 'room', 'lab_tube']
    };
    
    // Entity type labels
    const entityTypeLabels = {
        'user': '{% trans "User/Badge" %}',
        'patient': '{% trans "Patient" %}',
        'device': '{% trans "Device" %}',
        'accessory': '{% trans "Accessory" %}',
        'bed': '{% trans "Bed" %}',
        'department': '{% trans "Department" %}',
        'room': '{% trans "Room" %}',
        'lab_tube': '{% trans "Lab Tube" %}'
    };
    
    // Use Bootstrap 5 native events (without jQuery dependency)
    document.addEventListener('DOMContentLoaded', function() {
        const addStepModal = document.getElementById('addStepModal');
        if (addStepModal) {
            addStepModal.addEventListener('show.bs.modal', function (event) {
                const entitySelect = document.getElementById('entityTypeSelect');
                
                // Clear existing options
                entitySelect.innerHTML = '<option value="">{% trans "Select Entity Type" %}</option>';
                
                // Get relevant entity types for this operation
                const relevantTypes = operationEntityTypes[operationCode] || [];
                
                // Add relevant options
                relevantTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = entityTypeLabels[type];
                    
                    // Add helpful hints for specific operations
                    if (operationCode === 'DEVICE_HANDOVER' && type === 'user') {
                        option.textContent += ' ({% trans "From/To User" %})';
                    } else if (operationCode === 'OUT_OF_SERVICE' && type === 'user') {
                        option.textContent += ' ({% trans "Supervisor + Employee" %})';
                    } else if (operationCode === 'DEVICE_LENDING' && type === 'department') {
                        option.textContent += ' ({% trans "Optional - Can be User or Dept" %})';
                    }
                    
                    entitySelect.appendChild(option);
                });
                
                // Show hint based on operation
                const hints = {
                    'DEVICE_HANDOVER': '{% trans "Tip: Add 2 User steps for handover (from and to)" %}',
                    'OUT_OF_SERVICE': '{% trans "Tip: Add 2 User steps for double authentication" %}',
                    'DEVICE_USAGE': '{% trans "Tip: User → Device → Patient sequence" %}',
                    'END_DEVICE_USAGE': '{% trans "Tip: User → Device → Patient (same patient to end)" %}',
                    'DEVICE_TRANSFER': '{% trans "Tip: User → Device → Department sequence" %}'
                };
                
                if (hints[operationCode]) {
                    const hintDiv = document.createElement('div');
                    hintDiv.className = 'alert alert-info mt-2';
                    hintDiv.innerHTML = '<i class="fas fa-lightbulb"></i> ' + hints[operationCode];
                    
                    const existingHint = document.getElementById('operationHint');
                    if (existingHint) {
                        existingHint.remove();
                    }
                    
                    hintDiv.id = 'operationHint';
                    entitySelect.parentElement.appendChild(hintDiv);
                }
            });
        }
    });
</script>
{% endblock %}
