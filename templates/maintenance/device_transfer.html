{% extends 'base.html' %}
{% load i18n %}

{% block title %}نقل جهاز - {{ device.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-exchange-alt"></i>
                        نقل الجهاز: {{ device.name }}
                    </h3>
                </div>
                
                <div class="card-body">
                    <!-- Device Info -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="info-box bg-info">
                                <span class="info-box-icon"><i class="fas fa-laptop-medical"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">الجهاز الحالي</span>
                                    <span class="info-box-number">{{ device.name }}</span>
                                    <span class="progress-description">
                                        {{ device.department.name }} - {{ device.room.name|default:"بدون غرفة" }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-box bg-secondary">
                                <span class="info-box-icon"><i class="fas fa-info-circle"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">حالة الجهاز</span>
                                    <span class="info-box-number">
                                        {% if device.status %}
                                            {{ device.get_status_display }}
                                        {% else %}
                                            غير محدد
                                        {% endif %}
                                    </span>
                                    <span class="progress-description">
                                        {% if device.clean_status %}
                                            {{ device.get_clean_status_display }} | 
                                        {% endif %}
                                        {% if device.sterilization_status %}
                                            {{ device.get_sterilization_status_display }}
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Transfer Validation Errors -->
                    {% if transfer_errors %}
                    <div class="alert alert-danger">
                        <h5><i class="icon fas fa-ban"></i> لا يمكن نقل الجهاز!</h5>
                        <ul class="mb-0">
                            {% for error in transfer_errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                        <hr>
                        <p class="mb-0">
                            <strong>يجب تحديث حالة الجهاز قبل النقل:</strong>
                            <br>• الحالة: يعمل
                            <br>• النظافة: نظيف
                            <br>• التعقيم: معقم
                            <br>• التوفر: متاح
                        </p>
                    </div>
                    {% endif %}

                    <!-- Transfer Form -->
                    <form method="post" {% if transfer_errors %}style="opacity: 0.5; pointer-events: none;"{% endif %}>
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.department.id_for_label }}">
                                        <i class="fas fa-building"></i> القسم الجديد
                                    </label>
                                    {{ form.department }}
                                    {% if form.department.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.department.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.room.id_for_label }}">
                                        <i class="fas fa-door-open"></i> الغرفة الجديدة
                                    </label>
                                    {{ form.room }}
                                    {% if form.room.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.room.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="form-group">
                                    <label for="{{ form.reason.id_for_label }}">
                                        <i class="fas fa-comment"></i> سبب النقل
                                    </label>
                                    {{ form.reason }}
                                    {% if form.reason.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.reason.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-primary" {% if transfer_errors %}disabled{% endif %}>
                                <i class="fas fa-paper-plane"></i> إرسال طلب النقل
                            </button>
                            <a href="{% url 'maintenance:device_detail' device.id %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> العودة
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-filter rooms by department
document.getElementById('id_department').addEventListener('change', function() {
    const departmentId = this.value;
    const roomSelect = document.getElementById('id_room');
    
    // Clear current options
    roomSelect.innerHTML = '<option value="">---------</option>';
    
    if (departmentId) {
        fetch(`/manager/api/rooms/?department=${departmentId}`)
            .then(response => response.json())
            .then(data => {
                data.forEach(room => {
                    const option = document.createElement('option');
                    option.value = room.id;
                    option.textContent = room.name;
                    roomSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error loading rooms:', error));
    }
});
</script>
{% endblock %}
