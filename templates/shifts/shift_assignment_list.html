{% extends "base.html" %}
{% load i18n %}
{% block title %}{% trans "Shift Assignments" %}{% endblock %}
{% block content %}
<div class="container my-5">
    <h2 class="mb-4 text-center fw-bold">
        <i class="bi bi-calendar-check me-2" aria-hidden="true"></i>{% trans "Shift Assignments" %}
    </h2>

    <!-- Filters -->
    <form id="filter-form" method="get">
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <label for="department-filter" class="form-label fw-medium">{% trans "Department" %}</label>
                <select name="department" id="department-filter" class="form-select">
                    <option value="">{% trans "All Departments" %}</option>
                    {% for dept in departments %}
                        <option value="{{ dept.id }}" {% if request.GET.department == dept.id|stringformat:"s" %}selected{% endif %}>
                            {{ dept.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="date-filter" class="form-label fw-medium">{% trans "Date" %}</label>
                <input type="date" name="date" id="date-filter" class="form-control" value="{{ request.GET.date }}">
            </div>
            <div class="col-md-4 align-self-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-funnel me-2" aria-hidden="true"></i>{% trans "Filter" %}
                </button>
                {% if request.GET.department or request.GET.date %}
                <a href="." class="btn btn-outline-secondary w-100 mt-2">
                    <i class="bi bi-x-circle me-2" aria-hidden="true"></i>{% trans "Reset" %}
                </a>
                {% endif %}
            </div>
        </div>
    </form>

    <!-- HR Action Buttons -->
    {% if user.role == 'hr' %}
    <div class="text-end mb-4">
        <a href="{% url 'hr:schedule_create' %}" class="btn btn-primary me-2">
            <i class="bi bi-calendar-plus me-2" aria-hidden="true"></i>{% trans "New Schedule" %}
        </a>
        <a href="{% url 'hr:shift_assignment_create' %}" class="btn btn-primary">
            <i class="bi bi-person-plus me-2" aria-hidden="true"></i>{% trans "New Shift Assignment" %}
        </a>
    </div>
    {% endif %}

    <!-- Shift Assignments -->
    {% for department in departments %}
    <h3 class="mt-4 fw-bold">{{ department.name }}</h3>

    {% for schedule in schedules %}
    {% if schedule.department == department %}
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
            <h5 class="mb-0 fw-bold">
                {{ schedule.start_date|date:"Y-m-d" }} â€“ {{ schedule.end_date|date:"Y-m-d" }}
                <span class="badge bg-primary-subtle text-primary ms-2">{{ schedule.schedule_type|title }}</span>
                <span class="badge bg-secondary-subtle text-secondary ms-1">{{ schedule.shift_period|title }}</span>
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-light sticky-header">
                        <tr>
                            <th scope="col"><i class="bi bi-person me-1" aria-hidden="true"></i>{% trans "Staff" %}</th>
                            <th scope="col"><i class="bi bi-tag me-1" aria-hidden="true"></i>{% trans "Role" %}</th>
                            <th scope="col"><i class="bi bi-building me-1" aria-hidden="true"></i>{% trans "Work Area" %}</th>
                            <th scope="col"><i class="bi bi-calendar me-1" aria-hidden="true"></i>{% trans "Date" %}</th>
                            {% if user.role == 'hr' %}
                            <th class="d-none d-md-table-cell" scope="col"><i class="bi bi-clock-history me-1" aria-hidden="true"></i>{% trans "Created" %}</th>
                            {% endif %}
                            <th scope="col"><i class="bi bi-gear me-1" aria-hidden="true"></i>{% trans "Actions" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for shift in shift_assignments %}
                        {% if shift.schedule == schedule %}
                        <tr>
                            <td>{{ shift.staff.get_full_name|default:shift.staff.username }}</td>
                            <td>
                                <span class="badge bg-info-subtle text-dark">{{ shift.staff.get_role_display }}</span>
                            </td>
                            <td>{{ shift.work_area.name }}</td>
                            <td>{{ shift.date|date:"Y-m-d" }}</td>
                            {% if user.role == 'hr' %}
                            <td class="d-none d-md-table-cell">{{ shift.created_at|date:"Y-m-d H:i" }}</td>
                            {% endif %}
                            <td>
                                {% if user.role == 'hr' %}
                                <a href="{% url 'hr:shift_assignment_update' shift.pk %}" class="btn btn-sm btn-warning me-1" aria-label="Edit shift">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="{% url 'hr:shift_assignment_delete' shift.pk %}" class="btn btn-sm btn-danger" aria-label="Delete shift">
                                    <i class="bi bi-trash"></i>
                                </a>
                                {% else %}
                                <a href="{% url 'hr:shift_swap_request_create' shift.pk %}" class="btn btn-sm btn-info" aria-label="Request shift swap">
                                    <i class="bi bi-arrow-left-right"></i>
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endif %}
                        {% empty %}
                        <tr>
                            <td colspan="{% if user.role == 'hr' %}6{% else %}5{% endif %}" class="text-center text-muted py-4">
                                <i class="bi bi-calendar-x me-2" style="font-size: 1.5rem;"></i>
                                {% trans "No shifts assigned for this schedule." %}
                                {% if user.role == 'hr' %}
                                <br><a href="{% url 'hr:shift_assignment_create' %}" class="btn btn-sm btn-primary mt-2">{% trans "Assign Staff" %}</a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% endif %}
    {% endfor %}
    {% empty %}
    <div class="card text-center text-muted py-5">
        <div class="card-body">
            <i class="bi bi-building-x me-2" style="font-size: 2rem;"></i>
            <p>{% trans "No departments or schedules found." %}</p>
            {% if user.role == 'hr' %}
            <a href="{% url 'hr:schedule_create' %}" class="btn btn-primary">{% trans "Create a Schedule" %}</a>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}
{% block extra_css %}
<style>
    .sticky-header th {
        position: sticky;
        top: 0;
        background-color: var(--card-bg);
        color: var(--table-color);
        z-index: 1;
    }
    .table tbody tr:hover {
        background-color: var(--table-hover-bg);
    }
    .card {
        border: none;
        border-radius: 0.75rem;
        background-color: var(--card-bg);
    }
    .table td, .table th {
        padding: 0.75rem;
        vertical-align: middle;
    }
    @media (max-width: 576px) {
        .table th, .table td {
            font-size: 0.9rem;
        }
        .btn-sm {
            padding: 0.25rem 0.5rem;
        }
    }
</style>
{% endblock %}