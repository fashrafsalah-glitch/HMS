{% extends 'base.html' %}
{% load static %}

{% block title %}تحليلات قطع الغيار | لوحة التحكم{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h2 class="page-title">تحليلات قطع الغيار</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">الرئيسية</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'maintenance:dashboard:cmms_dashboard' %}">لوحة التحكم</a></li>
                    <li class="breadcrumb-item active" aria-current="page">تحليلات قطع الغيار</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- بطاقات المؤشرات الرئيسية -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card dashboard-card">
                <div class="card-body">
                    <h5 class="card-title">إجمالي قطع الغيار</h5>
                    <h2 class="text-primary">{{ spare_parts_stats.total_parts }}</h2>
                    <p class="text-muted">عدد قطع الغيار المسجلة</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card dashboard-card">
                <div class="card-body">
                    <h5 class="card-title">القيمة الإجمالية</h5>
                    <h2 class="text-success">{{ spare_parts_stats.total_value|floatformat:2 }}</h2>
                    <p class="text-muted">ريال سعودي</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card dashboard-card">
                <div class="card-body">
                    <h5 class="card-title">قطع غيار تحت الحد الأدنى</h5>
                    <h2 class="text-{{ spare_parts_stats.below_threshold_color }}">{{ spare_parts_stats.below_threshold_count }}</h2>
                    <p class="text-muted">تحتاج إلى إعادة طلب</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card dashboard-card">
                <div class="card-body">
                    <h5 class="card-title">معدل دوران المخزون</h5>
                    <h2 class="text-info">{{ spare_parts_stats.inventory_turnover|floatformat:1 }}</h2>
                    <p class="text-muted">في السنة</p>
                </div>
            </div>
        </div>
    </div>

    <!-- توزيع قطع الغيار حسب الفئة -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card dashboard-section">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">توزيع قطع الغيار حسب الفئة</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="sparePartsCategoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card dashboard-section">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">توزيع قطع الغيار حسب الموردين</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="supplierDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- قطع الغيار الأكثر استخداماً -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card dashboard-section">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">قطع الغيار الأكثر استخداماً</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>رقم القطعة</th>
                                    <th>اسم القطعة</th>
                                    <th>الفئة</th>
                                    <th>عدد مرات الاستخدام</th>
                                    <th>آخر استخدام</th>
                                    <th>المخزون الحالي</th>
                                    <th>حالة المخزون</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for part in most_used_parts %}
                                <tr>
                                    <td>{{ part.part_number }}</td>
                                    <td>{{ part.name }}</td>
                                    <td>{{ part.category }}</td>
                                    <td>{{ part.usage_count }}</td>
                                    <td>{{ part.last_used|date:"Y-m-d" }}</td>
                                    <td>{{ part.current_stock }}</td>
                                    <td>
                                        <span class="badge badge-{{ part.stock_status_color }}">{{ part.stock_status }}</span>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center">لا توجد بيانات متاحة</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- اتجاهات استهلاك قطع الغيار -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card dashboard-section">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">اتجاهات استهلاك قطع الغيار (آخر 12 شهر)</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="sparePartsConsumptionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- تحليل تكلفة قطع الغيار -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card dashboard-section">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">تكلفة قطع الغيار حسب الجهاز</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="deviceCostChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card dashboard-section">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">تكلفة قطع الغيار حسب القسم</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="departmentCostChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- قطع الغيار التي تحتاج إعادة طلب -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card dashboard-section">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">قطع الغيار التي تحتاج إعادة طلب</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>رقم القطعة</th>
                                    <th>اسم القطعة</th>
                                    <th>الفئة</th>
                                    <th>المخزون الحالي</th>
                                    <th>الحد الأدنى</th>
                                    <th>الكمية المقترحة للطلب</th>
                                    <th>المورد المفضل</th>
                                    <th>إجراء</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for part in reorder_parts %}
                                <tr>
                                    <td>{{ part.part_number }}</td>
                                    <td>{{ part.name }}</td>
                                    <td>{{ part.category }}</td>
                                    <td>{{ part.current_stock }}</td>
                                    <td>{{ part.min_stock }}</td>
                                    <td>{{ part.suggested_order_qty }}</td>
                                    <td>{{ part.preferred_supplier }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-secondary" disabled>طلب الشراء معطل مؤقتاً</button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center">لا توجد قطع غيار تحتاج إعادة طلب</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // توزيع قطع الغيار حسب الفئة
    const sparePartsCategoryCtx = document.getElementById('sparePartsCategoryChart').getContext('2d');
    const sparePartsCategoryChart = new Chart(sparePartsCategoryCtx, {
        type: 'pie',
        data: {
            labels: {{ spare_parts_category.categories|safe }},
            datasets: [{
                data: {{ spare_parts_category.counts|safe }},
                backgroundColor: [
                    '#17a2b8',
                    '#6f42c1',
                    '#fd7e14',
                    '#ffc107',
                    '#20c997',
                    '#28a745',
                    '#dc3545',
                    '#6c757d'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // توزيع قطع الغيار حسب الموردين
    const supplierDistributionCtx = document.getElementById('supplierDistributionChart').getContext('2d');
    const supplierDistributionChart = new Chart(supplierDistributionCtx, {
        type: 'doughnut',
        data: {
            labels: {{ supplier_distribution.suppliers|safe }},
            datasets: [{
                data: {{ supplier_distribution.counts|safe }},
                backgroundColor: [
                    '#fd7e14',
                    '#20c997',
                    '#17a2b8',
                    '#6f42c1',
                    '#28a745',
                    '#6c757d',
                    '#dc3545',
                    '#ffc107'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // اتجاهات استهلاك قطع الغيار
    const sparePartsConsumptionCtx = document.getElementById('sparePartsConsumptionChart').getContext('2d');
    const sparePartsConsumptionChart = new Chart(sparePartsConsumptionCtx, {
        type: 'line',
        data: {
            labels: {{ consumption_trends.months|safe }},
            datasets: [
                {
                    label: 'عدد قطع الغيار المستهلكة',
                    data: {{ consumption_trends.quantities|safe }},
                    borderColor: '#17a2b8',
                    backgroundColor: 'rgba(23, 162, 184, 0.1)',
                    borderWidth: 2,
                    fill: true
                },
                {
                    label: 'تكلفة قطع الغيار المستهلكة',
                    data: {{ consumption_trends.costs|safe }},
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'الكمية'
                    }
                },
                y1: {
                    beginAtZero: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'التكلفة (ريال)'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });

    // تكلفة قطع الغيار حسب الجهاز
    const deviceCostCtx = document.getElementById('deviceCostChart').getContext('2d');
    const deviceCostChart = new Chart(deviceCostCtx, {
        type: 'bar',
        data: {
            labels: {{ device_cost.devices|safe }},
            datasets: [{
                label: 'تكلفة قطع الغيار',
                data: {{ device_cost.costs|safe }},
                backgroundColor: '#6f42c1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'التكلفة (ريال)'
                    }
                }
            }
        }
    });

    // تكلفة قطع الغيار حسب القسم
    const departmentCostCtx = document.getElementById('departmentCostChart').getContext('2d');
    const departmentCostChart = new Chart(departmentCostCtx, {
        type: 'bar',
        data: {
            labels: {{ department_cost.departments|safe }},
            datasets: [{
                label: 'تكلفة قطع الغيار',
                data: {{ department_cost.costs|safe }},
                backgroundColor: '#fd7e14'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'التكلفة (ريال)'
                    }
                }
            }
        }
    });
</script>
{% endblock %}