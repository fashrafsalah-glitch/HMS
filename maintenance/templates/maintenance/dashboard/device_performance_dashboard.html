{% extends 'base.html' %}
{% load static %}

{% block title %}أداء الأجهزة | لوحة التحكم{% endblock %}

{% block content %}
<!-- JSON Data for Charts -->
{{ device_performance_data|json_script:"device-performance-data" }}
{{ failure_types_labels|json_script:"failure-types-labels" }}
{{ failure_types_data|json_script:"failure-types-data" }}
{{ department_usage_labels|json_script:"department-usage-labels" }}
{{ department_usage_data|json_script:"department-usage-data" }}
{{ device_age_data|json_script:"device-age-data" }}

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h2 class="page-title">لوحة تحكم أداء الأجهزة</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">الرئيسية</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'maintenance:dashboard:cmms_dashboard' %}">لوحة التحكم</a></li>
                    <li class="breadcrumb-item active" aria-current="page">أداء الأجهزة</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- بطاقات المؤشرات الرئيسية -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card dashboard-card">
                <div class="card-body">
                    <h5 class="card-title">متوسط وقت التشغيل</h5>
                    <h2 class="text-primary">{{ device_stats.avg_uptime|floatformat:1 }}%</h2>
                    <p class="text-muted">نسبة التشغيل الفعلي</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card dashboard-card">
                <div class="card-body">
                    <h5 class="card-title">متوسط MTBF</h5>
                    <h2 class="text-success">{{ device_stats.avg_mtbf|floatformat:1 }}</h2>
                    <p class="text-muted">متوسط الوقت بين الأعطال (أيام)</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card dashboard-card">
                <div class="card-body">
                    <h5 class="card-title">متوسط MTTR</h5>
                    <h2 class="text-warning">{{ device_stats.avg_mttr|floatformat:1 }}</h2>
                    <p class="text-muted">متوسط وقت الإصلاح (ساعات)</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card dashboard-card">
                <div class="card-body">
                    <h5 class="card-title">الأجهزة المعطلة</h5>
                    <h2 class="text-danger">{{ device_stats.down_devices_count }}</h2>
                    <p class="text-muted">من إجمالي {{ device_stats.total_devices }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- تصنيف الأجهزة حسب الأداء -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card dashboard-section">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0" style="color: #f7fafc;">تصنيف الأجهزة حسب الأداء</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="devicePerformanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card dashboard-section">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0" style="color: #f7fafc;">الأجهزة الأكثر تعطلاً</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>الجهاز</th>
                                    <th>عدد الأعطال</th>
                                    <th>إجمالي وقت التعطل</th>
                                    <th>مؤشر الأداء</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for device in worst_performing_devices %}
                                <tr>
                                    <td>
                                        <a href="{% url 'maintenance:device_detail' device.device.id %}">{{ device.device.name }}</a>
                                        <small class="text-muted d-block">{{ device.device.serial_number }}</small>
                                    </td>
                                    <td>{{ device.failures_count }}</td>
                                    <td>{{ device.total_downtime }} ساعة</td>
                                    <td>
                                        <div class="progress">
                                            <div class="progress-bar bg-{{ device.performance_color }}" 
                                                role="progressbar" 
                                                style="width: {{ device.performance_score }}%" 
                                                aria-valuenow="{{ device.performance_score }}" 
                                                aria-valuemin="0" 
                                                aria-valuemax="100">
                                                {{ device.performance_score }}%
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center">لا توجد بيانات متاحة</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- تحليل الأعطال والصيانة -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card dashboard-section">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0" style="color: #f7fafc;">تحليل الأعطال حسب النوع</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="failureTypesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- تنقلات الأجهزة بين الأقسام - شارت الجبال الرائع -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card dashboard-section">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h5 class="mb-0">
                        <i class="fas fa-mountain me-2"></i>
                        تنقلات الأجهزة بين الأقسام 
                    </h5>
                    <small class="opacity-75">تتبع حركة الأجهزة عبر الأقسام المختلفة بشكل بصري مذهل</small>
                </div>
                <div class="card-body" style="background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%); min-height: 500px;">
                    <div class="chart-container" style="position: relative; height: 450px;">
                        <canvas id="deviceTransferMountainChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- الأقسام الأكثر استخداماً للأجهزة -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card dashboard-section">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0" style="color: #f7fafc;">الأقسام الأكثر استخداماً للأجهزة</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="departmentUsageChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card dashboard-section">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0" style="color: #f7fafc;">توزيع الأجهزة حسب العمر</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="deviceAgeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Parse JSON data
    const devicePerformanceData = JSON.parse(document.getElementById('device-performance-data').textContent) || {};
    const failureTypesLabels = JSON.parse(document.getElementById('failure-types-labels').textContent) || [];
    const failureTypesData = JSON.parse(document.getElementById('failure-types-data').textContent) || [];
    const departmentUsageLabels = JSON.parse(document.getElementById('department-usage-labels').textContent) || [];
    const departmentUsageData = JSON.parse(document.getElementById('department-usage-data').textContent) || [];
    const deviceAgeData = JSON.parse(document.getElementById('device-age-data').textContent) || {};

    // بيانات تصنيف الأجهزة حسب الأداء
    const devicePerformanceCtx = document.getElementById('devicePerformanceChart').getContext('2d');
    const devicePerformanceChart = new Chart(devicePerformanceCtx, {
        type: 'pie',
        data: {
            labels: ['ممتاز (90-100%)', 'جيد جداً (80-89%)', 'جيد (70-79%)', 'متوسط (50-69%)', 'ضعيف (<50%)'],
            datasets: [{
                data: [
                    devicePerformanceData.excellent || 0,
                    devicePerformanceData.very_good || 0,
                    devicePerformanceData.good || 0,
                    devicePerformanceData.fair || 0,
                    devicePerformanceData.poor || 0
                ],
                backgroundColor: [
                    '#28a745',
                    '#20c997',
                    '#17a2b8',
                    '#ffc107',
                    '#dc3545'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // بيانات تحليل الأعطال حسب النوع
    const failureTypesCtx = document.getElementById('failureTypesChart').getContext('2d');
    
    // التحقق من وجود البيانات
    console.log('Failure Types Labels:', failureTypesLabels);
    console.log('Failure Types Data:', failureTypesData);
    
    // إذا لم توجد بيانات، عرض رسالة
    if (!failureTypesLabels.length || !failureTypesData.length) {
        failureTypesCtx.font = '16px Arial';
        failureTypesCtx.fillStyle = '#6c757d';
        failureTypesCtx.textAlign = 'center';
        failureTypesCtx.fillText('لا توجد بيانات أعطال متاحة', failureTypesCtx.canvas.width / 2, failureTypesCtx.canvas.height / 2);
    } else {
        const failureTypesChart = new Chart(failureTypesCtx, {
            type: 'bar',
            data: {
                labels: failureTypesLabels,
                datasets: [{
                    label: 'عدد الأعطال',
                    data: failureTypesData,
                    backgroundColor: [
                        '#dc3545', // أحمر للأعطال المفاجئة
                        '#fd7e14', // برتقالي للصيانة التصحيحية
                        '#dc3545', // أحمر للحرجة
                        '#ffc107', // أصفر للعالية
                        '#28a745', // أخضر للمتوسطة
                        '#6c757d'  // رمادي للمنخفضة
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y + ' حالة';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }

    // بيانات استخدام الأقسام للأجهزة
    const departmentUsageCtx = document.getElementById('departmentUsageChart').getContext('2d');
    const departmentUsageChart = new Chart(departmentUsageCtx, {
        type: 'doughnut',
        data: {
            labels: departmentUsageLabels,
            datasets: [{
                data: departmentUsageData,
                backgroundColor: [
                    '#4bc0c0',
                    '#ff6384',
                    '#ffce56',
                    '#9966ff',
                    '#36a2eb',
                    '#ff9f40'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // بيانات توزيع الأجهزة حسب العمر
    const deviceAgeCtx = document.getElementById('deviceAgeChart').getContext('2d');
    const deviceAgeChart = new Chart(deviceAgeCtx, {
        type: 'bar',
        data: {
            labels: ['<1 سنة', '1-3 سنوات', '3-5 سنوات', '5-7 سنوات', '>7 سنوات'],
            datasets: [{
                label: 'عدد الأجهزة',
                data: [
                    deviceAgeData.less_than_1_year || 0,
                    deviceAgeData.one_to_3_years || 0,
                    deviceAgeData.three_to_5_years || 0,
                    deviceAgeData.five_to_7_years || 0,
                    deviceAgeData.more_than_7_years || 0
                ],
                backgroundColor: '#9966ff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // 🏔️ شارت الجبال الرائع لتنقلات الأجهزة بين الأقسام - بيانات حقيقية
    const deviceTransferMountainCtx = document.getElementById('deviceTransferMountainChart').getContext('2d');
    
    // جلب البيانات الحقيقية من الخادم
    const transferData = JSON.parse('{{ device_transfer_chart_data|escapejs }}');

    const deviceTransferMountainChart = new Chart(deviceTransferMountainCtx, {
        type: 'line',
        data: transferData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                title: {
                    display: true,
                    text: ' رحلة الأجهزة عبر الأقسام ',
                    font: {
                        size: 18,
                        weight: 'bold'
                    },
                    color: '#2c3e50'
                },
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 20,
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: '#667eea',
                    borderWidth: 2,
                    cornerRadius: 10,
                    displayColors: true,
                    callbacks: {
                        title: function(context) {
                            return '📅 شهر ' + context[0].label;
                        },
                        label: function(context) {
                            return '🏥 ' + context.dataset.label + ': ' + context.parsed.y + ' جهاز';
                        },
                        afterBody: function(context) {
                            return '📊 إجمالي النقلات في هذا الشهر: ' + 
                                   context.reduce((sum, item) => sum + item.parsed.y, 0) + ' جهاز';
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: '📅 الأشهر',
                        font: {
                            size: 14,
                            weight: 'bold'
                        },
                        color: '#2c3e50'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)',
                        lineWidth: 1
                    },
                    ticks: {
                        font: {
                            size: 12,
                            weight: 'bold'
                        },
                        color: '#495057'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: '🔢 عدد الأجهزة المنقولة',
                        font: {
                            size: 14,
                            weight: 'bold'
                        },
                        color: '#2c3e50'
                    },
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)',
                        lineWidth: 1
                    },
                    ticks: {
                        font: {
                            size: 12,
                            weight: 'bold'
                        },
                        color: '#495057',
                        callback: function(value) {
                            return value + ' جهاز';
                        }
                    }
                }
            },
            elements: {
                line: {
                    borderJoinStyle: 'round'
                },
                point: {
                    hoverBorderWidth: 4
                }
            },
            animation: {
                duration: 2000,
                easing: 'easeInOutQuart'
            }
        }
    });

    // إضافة تأثيرات تفاعلية رائعة
    deviceTransferMountainChart.canvas.addEventListener('mousemove', function(e) {
        const points = deviceTransferMountainChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
        if (points.length) {
            e.target.style.cursor = 'pointer';
        } else {
            e.target.style.cursor = 'default';
        }
    });

</script>
{% endblock %}