{% extends 'base.html' %}
{% load static %}

{% block title %}Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© | Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…{% endblock %}

{% block content %}
<!-- JSON Data for Charts -->
{{ device_performance_data|json_script:"device-performance-data" }}
{{ failure_types_labels|json_script:"failure-types-labels" }}
{{ failure_types_data|json_script:"failure-types-data" }}
{{ department_usage_labels|json_script:"department-usage-labels" }}
{{ department_usage_data|json_script:"department-usage-data" }}
{{ device_age_data|json_script:"device-age-data" }}

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h2 class="page-title">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'maintenance:dashboard:cmms_dashboard' %}">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card dashboard-card">
                <div class="card-body">
                    <h5 class="card-title">Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„ØªØ´ØºÙŠÙ„</h5>
                    <h2 class="text-primary">{{ device_stats.avg_uptime|floatformat:1 }}%</h2>
                    <p class="text-muted">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card dashboard-card">
                <div class="card-body">
                    <h5 class="card-title">Ù…ØªÙˆØ³Ø· MTBF</h5>
                    <h2 class="text-success">{{ device_stats.avg_mtbf|floatformat:1 }}</h2>
                    <p class="text-muted">Ù…ØªÙˆØ³Ø· Ø§Ù„ÙˆÙ‚Øª Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ (Ø£ÙŠØ§Ù…)</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card dashboard-card">
                <div class="card-body">
                    <h5 class="card-title">Ù…ØªÙˆØ³Ø· MTTR</h5>
                    <h2 class="text-warning">{{ device_stats.avg_mttr|floatformat:1 }}</h2>
                    <p class="text-muted">Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­ (Ø³Ø§Ø¹Ø§Øª)</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card dashboard-card">
                <div class="card-body">
                    <h5 class="card-title">Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø¹Ø·Ù„Ø©</h5>
                    <h2 class="text-danger">{{ device_stats.down_devices_count }}</h2>
                    <p class="text-muted">Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ {{ device_stats.total_devices }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ØªØµÙ†ÙŠÙ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø­Ø³Ø¨ Ø§Ù„Ø£Ø¯Ø§Ø¡ -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card dashboard-section">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0" style="color: #f7fafc;">ØªØµÙ†ÙŠÙ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø­Ø³Ø¨ Ø§Ù„Ø£Ø¯Ø§Ø¡</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="devicePerformanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card dashboard-section">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0" style="color: #f7fafc;">Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£ÙƒØ«Ø± ØªØ¹Ø·Ù„Ø§Ù‹</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
                                    <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„</th>
                                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙˆÙ‚Øª Ø§Ù„ØªØ¹Ø·Ù„</th>
                                    <th>Ù…Ø¤Ø´Ø± Ø§Ù„Ø£Ø¯Ø§Ø¡</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for device in worst_performing_devices %}
                                <tr>
                                    <td>
                                        <a href="{% url 'maintenance:device_detail' device.device.id %}">{{ device.device.name }}</a>
                                        <small class="text-muted d-block">{{ device.device.serial_number }}</small>
                                    </td>
                                    <td>{{ device.failures_count }}</td>
                                    <td>{{ device.total_downtime }} Ø³Ø§Ø¹Ø©</td>
                                    <td>
                                        <div class="progress">
                                            <div class="progress-bar bg-{{ device.performance_color }}" 
                                                role="progressbar" 
                                                style="width: {{ device.performance_score }}%" 
                                                aria-valuenow="{{ device.performance_score }}" 
                                                aria-valuemin="0" 
                                                aria-valuemax="100">
                                                {{ device.performance_score }}%
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ§Ù„ØµÙŠØ§Ù†Ø© -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card dashboard-section">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0" style="color: #f7fafc;">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="failureTypesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ØªÙ†Ù‚Ù„Ø§Øª Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… - Ø´Ø§Ø±Øª Ø§Ù„Ø¬Ø¨Ø§Ù„ Ø§Ù„Ø±Ø§Ø¦Ø¹ -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card dashboard-section">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h5 class="mb-0">
                        <i class="fas fa-mountain me-2"></i>
                        ØªÙ†Ù‚Ù„Ø§Øª Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… 
                    </h5>
                    <small class="opacity-75">ØªØªØ¨Ø¹ Ø­Ø±ÙƒØ© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø¹Ø¨Ø± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø®ØªÙ„ÙØ© Ø¨Ø´ÙƒÙ„ Ø¨ØµØ±ÙŠ Ù…Ø°Ù‡Ù„</small>
                </div>
                <div class="card-body" style="background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%); min-height: 500px;">
                    <div class="chart-container" style="position: relative; height: 450px;">
                        <canvas id="deviceTransferMountainChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Ù‹ Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card dashboard-section">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0" style="color: #f7fafc;">Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Ù‹ Ù„Ù„Ø£Ø¬Ù‡Ø²Ø©</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="departmentUsageChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card dashboard-section">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0" style="color: #f7fafc;">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ø±</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="deviceAgeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Parse JSON data
    const devicePerformanceData = JSON.parse(document.getElementById('device-performance-data').textContent) || {};
    const failureTypesLabels = JSON.parse(document.getElementById('failure-types-labels').textContent) || [];
    const failureTypesData = JSON.parse(document.getElementById('failure-types-data').textContent) || [];
    const departmentUsageLabels = JSON.parse(document.getElementById('department-usage-labels').textContent) || [];
    const departmentUsageData = JSON.parse(document.getElementById('department-usage-data').textContent) || [];
    const deviceAgeData = JSON.parse(document.getElementById('device-age-data').textContent) || {};

    // Ø¨ÙŠØ§Ù†Ø§Øª ØªØµÙ†ÙŠÙ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø­Ø³Ø¨ Ø§Ù„Ø£Ø¯Ø§Ø¡
    const devicePerformanceCtx = document.getElementById('devicePerformanceChart').getContext('2d');
    const devicePerformanceChart = new Chart(devicePerformanceCtx, {
        type: 'pie',
        data: {
            labels: ['Ù…Ù…ØªØ§Ø² (90-100%)', 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹ (80-89%)', 'Ø¬ÙŠØ¯ (70-79%)', 'Ù…ØªÙˆØ³Ø· (50-69%)', 'Ø¶Ø¹ÙŠÙ (<50%)'],
            datasets: [{
                data: [
                    devicePerformanceData.excellent || 0,
                    devicePerformanceData.very_good || 0,
                    devicePerformanceData.good || 0,
                    devicePerformanceData.fair || 0,
                    devicePerformanceData.poor || 0
                ],
                backgroundColor: [
                    '#28a745',
                    '#20c997',
                    '#17a2b8',
                    '#ffc107',
                    '#dc3545'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Ø¨ÙŠØ§Ù†Ø§Øª ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
    const failureTypesCtx = document.getElementById('failureTypesChart').getContext('2d');
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    console.log('Failure Types Labels:', failureTypesLabels);
    console.log('Failure Types Data:', failureTypesData);
    
    // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø©
    if (!failureTypesLabels.length || !failureTypesData.length) {
        failureTypesCtx.font = '16px Arial';
        failureTypesCtx.fillStyle = '#6c757d';
        failureTypesCtx.textAlign = 'center';
        failureTypesCtx.fillText('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø¹Ø·Ø§Ù„ Ù…ØªØ§Ø­Ø©', failureTypesCtx.canvas.width / 2, failureTypesCtx.canvas.height / 2);
    } else {
        const failureTypesChart = new Chart(failureTypesCtx, {
            type: 'bar',
            data: {
                labels: failureTypesLabels,
                datasets: [{
                    label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„',
                    data: failureTypesData,
                    backgroundColor: [
                        '#dc3545', // Ø£Ø­Ù…Ø± Ù„Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ù…ÙØ§Ø¬Ø¦Ø©
                        '#fd7e14', // Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù„Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ©
                        '#dc3545', // Ø£Ø­Ù…Ø± Ù„Ù„Ø­Ø±Ø¬Ø©
                        '#ffc107', // Ø£ØµÙØ± Ù„Ù„Ø¹Ø§Ù„ÙŠØ©
                        '#28a745', // Ø£Ø®Ø¶Ø± Ù„Ù„Ù…ØªÙˆØ³Ø·Ø©
                        '#6c757d'  // Ø±Ù…Ø§Ø¯ÙŠ Ù„Ù„Ù…Ù†Ø®ÙØ¶Ø©
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y + ' Ø­Ø§Ù„Ø©';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }

    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù„Ù„Ø£Ø¬Ù‡Ø²Ø©
    const departmentUsageCtx = document.getElementById('departmentUsageChart').getContext('2d');
    const departmentUsageChart = new Chart(departmentUsageCtx, {
        type: 'doughnut',
        data: {
            labels: departmentUsageLabels,
            datasets: [{
                data: departmentUsageData,
                backgroundColor: [
                    '#4bc0c0',
                    '#ff6384',
                    '#ffce56',
                    '#9966ff',
                    '#36a2eb',
                    '#ff9f40'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Ø¨ÙŠØ§Ù†Ø§Øª ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ø±
    const deviceAgeCtx = document.getElementById('deviceAgeChart').getContext('2d');
    const deviceAgeChart = new Chart(deviceAgeCtx, {
        type: 'bar',
        data: {
            labels: ['<1 Ø³Ù†Ø©', '1-3 Ø³Ù†ÙˆØ§Øª', '3-5 Ø³Ù†ÙˆØ§Øª', '5-7 Ø³Ù†ÙˆØ§Øª', '>7 Ø³Ù†ÙˆØ§Øª'],
            datasets: [{
                label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©',
                data: [
                    deviceAgeData.less_than_1_year || 0,
                    deviceAgeData.one_to_3_years || 0,
                    deviceAgeData.three_to_5_years || 0,
                    deviceAgeData.five_to_7_years || 0,
                    deviceAgeData.more_than_7_years || 0
                ],
                backgroundColor: '#9966ff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // ğŸ”ï¸ Ø´Ø§Ø±Øª Ø§Ù„Ø¬Ø¨Ø§Ù„ Ø§Ù„Ø±Ø§Ø¦Ø¹ Ù„ØªÙ†Ù‚Ù„Ø§Øª Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… - Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©
    const deviceTransferMountainCtx = document.getElementById('deviceTransferMountainChart').getContext('2d');
    
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
    const transferData = JSON.parse('{{ device_transfer_chart_data|escapejs }}');

    const deviceTransferMountainChart = new Chart(deviceTransferMountainCtx, {
        type: 'line',
        data: transferData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                title: {
                    display: true,
                    text: ' Ø±Ø­Ù„Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø¹Ø¨Ø± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ',
                    font: {
                        size: 18,
                        weight: 'bold'
                    },
                    color: '#2c3e50'
                },
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 20,
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: '#667eea',
                    borderWidth: 2,
                    cornerRadius: 10,
                    displayColors: true,
                    callbacks: {
                        title: function(context) {
                            return 'ğŸ“… Ø´Ù‡Ø± ' + context[0].label;
                        },
                        label: function(context) {
                            return 'ğŸ¥ ' + context.dataset.label + ': ' + context.parsed.y + ' Ø¬Ù‡Ø§Ø²';
                        },
                        afterBody: function(context) {
                            return 'ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ù„Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±: ' + 
                                   context.reduce((sum, item) => sum + item.parsed.y, 0) + ' Ø¬Ù‡Ø§Ø²';
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'ğŸ“… Ø§Ù„Ø£Ø´Ù‡Ø±',
                        font: {
                            size: 14,
                            weight: 'bold'
                        },
                        color: '#2c3e50'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)',
                        lineWidth: 1
                    },
                    ticks: {
                        font: {
                            size: 12,
                            weight: 'bold'
                        },
                        color: '#495057'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'ğŸ”¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ù†Ù‚ÙˆÙ„Ø©',
                        font: {
                            size: 14,
                            weight: 'bold'
                        },
                        color: '#2c3e50'
                    },
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)',
                        lineWidth: 1
                    },
                    ticks: {
                        font: {
                            size: 12,
                            weight: 'bold'
                        },
                        color: '#495057',
                        callback: function(value) {
                            return value + ' Ø¬Ù‡Ø§Ø²';
                        }
                    }
                }
            },
            elements: {
                line: {
                    borderJoinStyle: 'round'
                },
                point: {
                    hoverBorderWidth: 4
                }
            },
            animation: {
                duration: 2000,
                easing: 'easeInOutQuart'
            }
        }
    });

    // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ±Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ© Ø±Ø§Ø¦Ø¹Ø©
    deviceTransferMountainChart.canvas.addEventListener('mousemove', function(e) {
        const points = deviceTransferMountainChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
        if (points.length) {
            e.target.style.cursor = 'pointer';
        } else {
            e.target.style.cursor = 'default';
        }
    });

</script>
{% endblock %}