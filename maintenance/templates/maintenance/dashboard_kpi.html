{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "لوحة مؤشرات الأداء" %}{% endblock %}

{% block extra_css %}
<link href="{% static 'vendor/chart.js/Chart.min.css' %}" rel="stylesheet">
<link href="{% static 'vendor/daterangepicker/daterangepicker.css' %}" rel="stylesheet">
<style>
    .kpi-card {
        border-left: 4px solid;
        margin-bottom: 20px;
    }
    .kpi-card-primary {
        border-left-color: #4e73df;
    }
    .kpi-card-success {
        border-left-color: #1cc88a;
    }
    .kpi-card-warning {
        border-left-color: #f6c23e;
    }
    .kpi-card-danger {
        border-left-color: #e74a3b;
    }
    .kpi-card-info {
        border-left-color: #36b9cc;
    }
    .kpi-card-secondary {
        border-left-color: #858796;
    }
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
    }
    .trend-up {
        color: #1cc88a;
    }
    .trend-down {
        color: #e74a3b;
    }
    .trend-neutral {
        color: #858796;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">{% trans "لوحة مؤشرات الأداء" %}</h1>
        <div>
            <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-calendar fa-sm text-gray-50"></i> {% trans "الفترة" %}
                </button>
                <div class="dropdown-menu dropdown-menu-right">
                    <a class="dropdown-item period-filter" href="#" data-period="7">{% trans "آخر 7 أيام" %}</a>
                    <a class="dropdown-item period-filter" href="#" data-period="30">{% trans "آخر 30 يوم" %}</a>
                    <a class="dropdown-item period-filter" href="#" data-period="90">{% trans "آخر 3 أشهر" %}</a>
                    <a class="dropdown-item period-filter" href="#" data-period="180">{% trans "آخر 6 أشهر" %}</a>
                    <a class="dropdown-item period-filter" href="#" data-period="365">{% trans "آخر سنة" %}</a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="#" id="custom-range">{% trans "فترة مخصصة" %}</a>
                </div>
            </div>
            <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm" id="export-report">
                <i class="fas fa-download fa-sm text-white-50"></i> {% trans "تصدير التقرير" %}
            </a>
        </div>
    </div>

    <!-- Date Range Picker (hidden by default) -->
    <div class="card shadow mb-4" id="date-range-card" style="display: none;">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">{% trans "اختر فترة زمنية" %}</h6>
        </div>
        <div class="card-body">
            <div class="form-group">
                <div id="reportrange" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc; width: 100%">
                    <i class="fa fa-calendar"></i>&nbsp;
                    <span></span> <i class="fa fa-caret-down"></i>
                </div>
            </div>
            <button class="btn btn-primary" id="apply-date-range">{% trans "تطبيق" %}</button>
            <button class="btn btn-secondary" id="cancel-date-range">{% trans "إلغاء" %}</button>
        </div>
    </div>

    <!-- KPI Cards Row -->
    <div class="row">
        <!-- MTTR (Mean Time To Repair) -->
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2 kpi-card kpi-card-primary">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">{% trans "متوسط وقت الإصلاح (MTTR)" %}</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ kpis.mttr }} {% trans "ساعة" %}</div>
                            <div class="text-xs mt-2">
                                {% if kpis.mttr_trend > 0 %}
                                <span class="trend-down"><i class="fas fa-arrow-up"></i> {{ kpis.mttr_trend }}% {% trans "من الفترة السابقة" %}</span>
                                {% elif kpis.mttr_trend < 0 %}
                                <span class="trend-up"><i class="fas fa-arrow-down"></i> {{ kpis.mttr_trend|abs }}% {% trans "من الفترة السابقة" %}</span>
                                {% else %}
                                <span class="trend-neutral"><i class="fas fa-equals"></i> {% trans "لا تغيير عن الفترة السابقة" %}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-wrench fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MTBF (Mean Time Between Failures) -->
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2 kpi-card kpi-card-success">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">{% trans "متوسط الوقت بين الأعطال (MTBF)" %}</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ kpis.mtbf }} {% trans "ساعة" %}</div>
                            <div class="text-xs mt-2">
                                {% if kpis.mtbf_trend > 0 %}
                                <span class="trend-up"><i class="fas fa-arrow-up"></i> {{ kpis.mtbf_trend }}% {% trans "من الفترة السابقة" %}</span>
                                {% elif kpis.mtbf_trend < 0 %}
                                <span class="trend-down"><i class="fas fa-arrow-down"></i> {{ kpis.mtbf_trend|abs }}% {% trans "من الفترة السابقة" %}</span>
                                {% else %}
                                <span class="trend-neutral"><i class="fas fa-equals"></i> {% trans "لا تغيير عن الفترة السابقة" %}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Equipment Availability -->
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2 kpi-card kpi-card-info">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">{% trans "توافر الأجهزة" %}</div>
                            <div class="row no-gutters align-items-center">
                                <div class="col-auto">
                                    <div class="h5 mb-0 mr-3 font-weight-bold text-gray-800">{{ kpis.availability }}%</div>
                                </div>
                                <div class="col">
                                    <div class="progress progress-sm mr-2">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: {{ kpis.availability }}%" aria-valuenow="{{ kpis.availability }}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-xs mt-2">
                                {% if kpis.availability_trend > 0 %}
                                <span class="trend-up"><i class="fas fa-arrow-up"></i> {{ kpis.availability_trend }}% {% trans "من الفترة السابقة" %}</span>
                                {% elif kpis.availability_trend < 0 %}
                                <span class="trend-down"><i class="fas fa-arrow-down"></i> {{ kpis.availability_trend|abs }}% {% trans "من الفترة السابقة" %}</span>
                                {% else %}
                                <span class="trend-neutral"><i class="fas fa-equals"></i> {% trans "لا تغيير عن الفترة السابقة" %}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clipboard-check fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preventive Maintenance Compliance -->
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2 kpi-card kpi-card-warning">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">{% trans "الالتزام بالصيانة الوقائية" %}</div>
                            <div class="row no-gutters align-items-center">
                                <div class="col-auto">
                                    <div class="h5 mb-0 mr-3 font-weight-bold text-gray-800">{{ kpis.pm_compliance }}%</div>
                                </div>
                                <div class="col">
                                    <div class="progress progress-sm mr-2">
                                        <div class="progress-bar bg-warning" role="progressbar" style="width: {{ kpis.pm_compliance }}%" aria-valuenow="{{ kpis.pm_compliance }}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-xs mt-2">
                                {% if kpis.pm_compliance_trend > 0 %}
                                <span class="trend-up"><i class="fas fa-arrow-up"></i> {{ kpis.pm_compliance_trend }}% {% trans "من الفترة السابقة" %}</span>
                                {% elif kpis.pm_compliance_trend < 0 %}
                                <span class="trend-down"><i class="fas fa-arrow-down"></i> {{ kpis.pm_compliance_trend|abs }}% {% trans "من الفترة السابقة" %}</span>
                                {% else %}
                                <span class="trend-neutral"><i class="fas fa-equals"></i> {% trans "لا تغيير عن الفترة السابقة" %}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-check fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Work Order Completion Rate -->
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2 kpi-card kpi-card-danger">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">{% trans "معدل إنجاز أوامر العمل" %}</div>
                            <div class="row no-gutters align-items-center">
                                <div class="col-auto">
                                    <div class="h5 mb-0 mr-3 font-weight-bold text-gray-800">{{ kpis.wo_completion_rate }}%</div>
                                </div>
                                <div class="col">
                                    <div class="progress progress-sm mr-2">
                                        <div class="progress-bar bg-danger" role="progressbar" style="width: {{ kpis.wo_completion_rate }}%" aria-valuenow="{{ kpis.wo_completion_rate }}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-xs mt-2">
                                {% if kpis.wo_completion_trend > 0 %}
                                <span class="trend-up"><i class="fas fa-arrow-up"></i> {{ kpis.wo_completion_trend }}% {% trans "من الفترة السابقة" %}</span>
                                {% elif kpis.wo_completion_trend < 0 %}
                                <span class="trend-down"><i class="fas fa-arrow-down"></i> {{ kpis.wo_completion_trend|abs }}% {% trans "من الفترة السابقة" %}</span>
                                {% else %}
                                <span class="trend-neutral"><i class="fas fa-equals"></i> {% trans "لا تغيير عن الفترة السابقة" %}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-tasks fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Maintenance Cost -->
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card border-left-secondary shadow h-100 py-2 kpi-card kpi-card-secondary">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">{% trans "تكلفة الصيانة" %}</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ kpis.maintenance_cost }}</div>
                            <div class="text-xs mt-2">
                                {% if kpis.maintenance_cost_trend > 0 %}
                                <span class="trend-down"><i class="fas fa-arrow-up"></i> {{ kpis.maintenance_cost_trend }}% {% trans "من الفترة السابقة" %}</span>
                                {% elif kpis.maintenance_cost_trend < 0 %}
                                <span class="trend-up"><i class="fas fa-arrow-down"></i> {{ kpis.maintenance_cost_trend|abs }}% {% trans "من الفترة السابقة" %}</span>
                                {% else %}
                                <span class="trend-neutral"><i class="fas fa-equals"></i> {% trans "لا تغيير عن الفترة السابقة" %}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row">
        <!-- Work Order by Type Chart -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "أوامر العمل حسب النوع" %}</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="workOrderTypeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Maintenance Cost Trend Chart -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "اتجاه تكلفة الصيانة" %}</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="maintenanceCostChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Equipment Downtime by Category Chart -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "توقف الأجهزة حسب الفئة" %}</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="downtimeCategoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top 5 Failing Equipment Chart -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">{% trans "أكثر 5 أجهزة تعطلاً" %}</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="topFailingEquipmentChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed KPI Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">{% trans "تفاصيل مؤشرات الأداء" %}</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="kpiTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>{% trans "المؤشر" %}</th>
                            <th>{% trans "القيمة الحالية" %}</th>
                            <th>{% trans "القيمة السابقة" %}</th>
                            <th>{% trans "التغيير" %}</th>
                            <th>{% trans "الهدف" %}</th>
                            <th>{% trans "الحالة" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>{% trans "متوسط وقت الإصلاح (MTTR)" %}</td>
                            <td>{{ kpis.mttr }} {% trans "ساعة" %}</td>
                            <td>{{ kpis.mttr_previous }} {% trans "ساعة" %}</td>
                            <td>
                                {% if kpis.mttr_trend > 0 %}
                                <span class="trend-down"><i class="fas fa-arrow-up"></i> {{ kpis.mttr_trend }}%</span>
                                {% elif kpis.mttr_trend < 0 %}
                                <span class="trend-up"><i class="fas fa-arrow-down"></i> {{ kpis.mttr_trend|abs }}%</span>
                                {% else %}
                                <span class="trend-neutral"><i class="fas fa-equals"></i> 0%</span>
                                {% endif %}
                            </td>
                            <td>{{ kpis.mttr_target }} {% trans "ساعة" %}</td>
                            <td>
                                {% if kpis.mttr <= kpis.mttr_target %}
                                <span class="badge badge-success">{% trans "جيد" %}</span>
                                {% else %}
                                <span class="badge badge-danger">{% trans "يحتاج تحسين" %}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>{% trans "متوسط الوقت بين الأعطال (MTBF)" %}</td>
                            <td>{{ kpis.mtbf }} {% trans "ساعة" %}</td>
                            <td>{{ kpis.mtbf_previous }} {% trans "ساعة" %}</td>
                            <td>
                                {% if kpis.mtbf_trend > 0 %}
                                <span class="trend-up"><i class="fas fa-arrow-up"></i> {{ kpis.mtbf_trend }}%</span>
                                {% elif kpis.mtbf_trend < 0 %}
                                <span class="trend-down"><i class="fas fa-arrow-down"></i> {{ kpis.mtbf_trend|abs }}%</span>
                                {% else %}
                                <span class="trend-neutral"><i class="fas fa-equals"></i> 0%</span>
                                {% endif %}
                            </td>
                            <td>{{ kpis.mtbf_target }} {% trans "ساعة" %}</td>
                            <td>
                                {% if kpis.mtbf >= kpis.mtbf_target %}
                                <span class="badge badge-success">{% trans "جيد" %}</span>
                                {% else %}
                                <span class="badge badge-danger">{% trans "يحتاج تحسين" %}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>{% trans "توافر الأجهزة" %}</td>
                            <td>{{ kpis.availability }}%</td>
                            <td>{{ kpis.availability_previous }}%</td>
                            <td>
                                {% if kpis.availability_trend > 0 %}
                                <span class="trend-up"><i class="fas fa-arrow-up"></i> {{ kpis.availability_trend }}%</span>
                                {% elif kpis.availability_trend < 0 %}
                                <span class="trend-down"><i class="fas fa-arrow-down"></i> {{ kpis.availability_trend|abs }}%</span>
                                {% else %}
                                <span class="trend-neutral"><i class="fas fa-equals"></i> 0%</span>
                                {% endif %}
                            </td>
                            <td>{{ kpis.availability_target }}%</td>
                            <td>
                                {% if kpis.availability >= kpis.availability_target %}
                                <span class="badge badge-success">{% trans "جيد" %}</span>
                                {% else %}
                                <span class="badge badge-danger">{% trans "يحتاج تحسين" %}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>{% trans "الالتزام بالصيانة الوقائية" %}</td>
                            <td>{{ kpis.pm_compliance }}%</td>
                            <td>{{ kpis.pm_compliance_previous }}%</td>
                            <td>
                                {% if kpis.pm_compliance_trend > 0 %}
                                <span class="trend-up"><i class="fas fa-arrow-up"></i> {{ kpis.pm_compliance_trend }}%</span>
                                {% elif kpis.pm_compliance_trend < 0 %}
                                <span class="trend-down"><i class="fas fa-arrow-down"></i> {{ kpis.pm_compliance_trend|abs }}%</span>
                                {% else %}
                                <span class="trend-neutral"><i class="fas fa-equals"></i> 0%</span>
                                {% endif %}
                            </td>
                            <td>{{ kpis.pm_compliance_target }}%</td>
                            <td>
                                {% if kpis.pm_compliance >= kpis.pm_compliance_target %}
                                <span class="badge badge-success">{% trans "جيد" %}</span>
                                {% else %}
                                <span class="badge badge-danger">{% trans "يحتاج تحسين" %}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>{% trans "معدل إنجاز أوامر العمل" %}</td>
                            <td>{{ kpis.wo_completion_rate }}%</td>
                            <td>{{ kpis.wo_completion_previous }}%</td>
                            <td>
                                {% if kpis.wo_completion_trend > 0 %}
                                <span class="trend-up"><i class="fas fa-arrow-up"></i> {{ kpis.wo_completion_trend }}%</span>
                                {% elif kpis.wo_completion_trend < 0 %}
                                <span class="trend-down"><i class="fas fa-arrow-down"></i> {{ kpis.wo_completion_trend|abs }}%</span>
                                {% else %}
                                <span class="trend-neutral"><i class="fas fa-equals"></i> 0%</span>
                                {% endif %}
                            </td>
                            <td>{{ kpis.wo_completion_target }}%</td>
                            <td>
                                {% if kpis.wo_completion_rate >= kpis.wo_completion_target %}
                                <span class="badge badge-success">{% trans "جيد" %}</span>
                                {% else %}
                                <span class="badge badge-danger">{% trans "يحتاج تحسين" %}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>{% trans "تكلفة الصيانة" %}</td>
                            <td>{{ kpis.maintenance_cost }}</td>
                            <td>{{ kpis.maintenance_cost_previous }}</td>
                            <td>
                                {% if kpis.maintenance_cost_trend > 0 %}
                                <span class="trend-down"><i class="fas fa-arrow-up"></i> {{ kpis.maintenance_cost_trend }}%</span>
                                {% elif kpis.maintenance_cost_trend < 0 %}
                                <span class="trend-up"><i class="fas fa-arrow-down"></i> {{ kpis.maintenance_cost_trend|abs }}%</span>
                                {% else %}
                                <span class="trend-neutral"><i class="fas fa-equals"></i> 0%</span>
                                {% endif %}
                            </td>
                            <td>{{ kpis.maintenance_cost_target }}</td>
                            <td>
                                {% if kpis.maintenance_cost <= kpis.maintenance_cost_target %}
                                <span class="badge badge-success">{% trans "جيد" %}</span>
                                {% else %}
                                <span class="badge badge-danger">{% trans "يحتاج تحسين" %}</span>
                                {% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'vendor/chart.js/Chart.min.js' %}"></script>
<script src="{% static 'vendor/daterangepicker/moment.min.js' %}"></script>
<script src="{% static 'vendor/daterangepicker/daterangepicker.js' %}"></script>
<script>
    // Chart.js global settings
    Chart.defaults.global.defaultFontFamily = 'Nunito';
    Chart.defaults.global.defaultFontColor = '#858796';
    
    $(document).ready(function() {
        // Initialize charts with data from the server
        initializeCharts();
        
        // Date Range Picker
        var start = moment().subtract(29, 'days');
        var end = moment();
        
        function cb(start, end) {
            $('#reportrange span').html(start.format('YYYY-MM-DD') + ' - ' + end.format('YYYY-MM-DD'));
        }
        
        $('#reportrange').daterangepicker({
            startDate: start,
            endDate: end,
            ranges: {
                'اليوم': [moment(), moment()],
                'أمس': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                'آخر 7 أيام': [moment().subtract(6, 'days'), moment()],
                'آخر 30 يوم': [moment().subtract(29, 'days'), moment()],
                'هذا الشهر': [moment().startOf('month'), moment().endOf('month')],
                'الشهر الماضي': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
            },
            locale: {
                direction: 'rtl',
                applyLabel: 'تطبيق',
                cancelLabel: 'إلغاء',
                fromLabel: 'من',
                toLabel: 'إلى',
                customRangeLabel: 'مخصص',
                daysOfWeek: ['أحد', 'إثنين', 'ثلاثاء', 'أربعاء', 'خميس', 'جمعة', 'سبت'],
                monthNames: ['يناير', 'فبراير', 'مارس', 'إبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'],
                firstDay: 0
            }
        }, cb);
        
        cb(start, end);
        
        // Custom range button click
        $('#custom-range').click(function(e) {
            e.preventDefault();
            $('#date-range-card').show();
        });
        
        // Cancel date range button
        $('#cancel-date-range').click(function() {
            $('#date-range-card').hide();
        });
        
        // Apply date range button
        $('#apply-date-range').click(function() {
            $('#date-range-card').hide();
            var dateRange = $('#reportrange').data('daterangepicker');
            loadKpiData(dateRange.startDate.format('YYYY-MM-DD'), dateRange.endDate.format('YYYY-MM-DD'));
        });
        
        // Period filter click
        $('.period-filter').click(function(e) {
            e.preventDefault();
            var days = $(this).data('period');
            var endDate = moment().format('YYYY-MM-DD');
            var startDate = moment().subtract(days, 'days').format('YYYY-MM-DD');
            loadKpiData(startDate, endDate);
        });
        
        // Export report button
        $('#export-report').click(function(e) {
            e.preventDefault();
            var dateRange = $('#reportrange').data('daterangepicker');
            var startDate = dateRange.startDate.format('YYYY-MM-DD');
            var endDate = dateRange.endDate.format('YYYY-MM-DD');
            window.location.href = "{% url 'maintenance:kpi_export_pdf' %}?start_date=" + startDate + "&end_date=" + endDate;
        });
    });
    
    function initializeCharts() {
        // Work Order by Type Chart
        var workOrderCtx = document.getElementById("workOrderTypeChart");
        var workOrderTypeChart = new Chart(workOrderCtx, {
            type: 'pie',
            data: {
                labels: {{ chart_data.work_order_types_labels|safe }},
                datasets: [{
                    data: {{ chart_data.work_order_types_data|safe }},
                    backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'],
                    hoverBackgroundColor: ['#2e59d9', '#17a673', '#2c9faf', '#dda20a', '#be2617', '#60616f'],
                    hoverBorderColor: "rgba(234, 236, 244, 1)",
                }],
            },
            options: {
                maintainAspectRatio: false,
                tooltips: {
                    backgroundColor: "rgb(255,255,255)",
                    bodyFontColor: "#858796",
                    borderColor: '#dddfeb',
                    borderWidth: 1,
                    xPadding: 15,
                    yPadding: 15,
                    displayColors: false,
                    caretPadding: 10,
                },
                legend: {
                    display: true,
                    position: 'bottom'
                },
                cutoutPercentage: 0,
            },
        });
        
        // Maintenance Cost Trend Chart
        var costCtx = document.getElementById("maintenanceCostChart");
        var maintenanceCostChart = new Chart(costCtx, {
            type: 'line',
            data: {
                labels: {{ chart_data.maintenance_cost_labels|safe }},
                datasets: [{
                    label: "تكلفة الصيانة",
                    lineTension: 0.3,
                    backgroundColor: "rgba(78, 115, 223, 0.05)",
                    borderColor: "rgba(78, 115, 223, 1)",
                    pointRadius: 3,
                    pointBackgroundColor: "rgba(78, 115, 223, 1)",
                    pointBorderColor: "rgba(78, 115, 223, 1)",
                    pointHoverRadius: 3,
                    pointHoverBackgroundColor: "rgba(78, 115, 223, 1)",
                    pointHoverBorderColor: "rgba(78, 115, 223, 1)",
                    pointHitRadius: 10,
                    pointBorderWidth: 2,
                    data: {{ chart_data.maintenance_cost_data|safe }},
                }],
            },
            options: {
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        left: 10,
                        right: 25,
                        top: 25,
                        bottom: 0
                    }
                },
                scales: {
                    xAxes: [{
                        time: {
                            unit: 'date'
                        },
                        gridLines: {
                            display: false,
                            drawBorder: false
                        },
                        ticks: {
                            maxTicksLimit: 7
                        }
                    }],
                    yAxes: [{
                        ticks: {
                            maxTicksLimit: 5,
                            padding: 10,
                            callback: function(value, index, values) {
                                return value;
                            }
                        },
                        gridLines: {
                            color: "rgb(234, 236, 244)",
                            zeroLineColor: "rgb(234, 236, 244)",
                            drawBorder: false,
                            borderDash: [2],
                            zeroLineBorderDash: [2]
                        }
                    }],
                },
                legend: {
                    display: false
                },
                tooltips: {
                    backgroundColor: "rgb(255,255,255)",
                    bodyFontColor: "#858796",
                    titleMarginBottom: 10,
                    titleFontColor: '#6e707e',
                    titleFontSize: 14,
                    borderColor: '#dddfeb',
                    borderWidth: 1,
                    xPadding: 15,
                    yPadding: 15,
                    displayColors: false,
                    intersect: false,
                    mode: 'index',
                    caretPadding: 10,
                    callbacks: {
                        label: function(tooltipItem, chart) {
                            return tooltipItem.yLabel;
                        }
                    }
                }
            }
        });
        
        // Equipment Downtime by Category Chart
        var downtimeCtx = document.getElementById("downtimeCategoryChart");
        var downtimeCategoryChart = new Chart(downtimeCtx, {
            type: 'bar',
            data: {
                labels: {{ chart_data.downtime_category_labels|safe }},
                datasets: [{
                    label: "ساعات التوقف",
                    backgroundColor: "#e74a3b",
                    hoverBackgroundColor: "#be2617",
                    borderColor: "#e74a3b",
                    data: {{ chart_data.downtime_category_data|safe }},
                }],
            },
            options: {
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        left: 10,
                        right: 25,
                        top: 25,
                        bottom: 0
                    }
                },
                scales: {
                    xAxes: [{
                        gridLines: {
                            display: false,
                            drawBorder: false
                        },
                        ticks: {
                            maxTicksLimit: 6
                        },
                        maxBarThickness: 25,
                    }],
                    yAxes: [{
                        ticks: {
                            min: 0,
                            maxTicksLimit: 5,
                            padding: 10,
                        },
                        gridLines: {
                            color: "rgb(234, 236, 244)",
                            zeroLineColor: "rgb(234, 236, 244)",
                            drawBorder: false,
                            borderDash: [2],
                            zeroLineBorderDash: [2]
                        }
                    }],
                },
                legend: {
                    display: false
                },
                tooltips: {
                    titleMarginBottom: 10,
                    titleFontColor: '#6e707e',
                    titleFontSize: 14,
                    backgroundColor: "rgb(255,255,255)",
                    bodyFontColor: "#858796",
                    borderColor: '#dddfeb',
                    borderWidth: 1,
                    xPadding: 15,
                    yPadding: 15,
                    displayColors: false,
                    caretPadding: 10,
                    callbacks: {
                        label: function(tooltipItem, chart) {
                            return tooltipItem.yLabel + " ساعة";
                        }
                    }
                },
            }
        });
        
        // Top 5 Failing Equipment Chart
        var failingEquipmentCtx = document.getElementById("topFailingEquipmentChart");
        var topFailingEquipmentChart = new Chart(failingEquipmentCtx, {
            type: 'horizontalBar',
            data: {
                labels: {{ chart_data.top_failing_equipment_labels|safe }},
                datasets: [{
                    label: "عدد الأعطال",
                    backgroundColor: "#4e73df",
                    hoverBackgroundColor: "#2e59d9",
                    borderColor: "#4e73df",
                    data: {{ chart_data.top_failing_equipment_data|safe }},
                }],
            },
            options: {
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        left: 10,
                        right: 25,
                        top: 25,
                        bottom: 0
                    }
                },
                scales: {
                    xAxes: [{
                        ticks: {
                            min: 0,
                            maxTicksLimit: 5,
                            padding: 10,
                        },
                        gridLines: {
                            color: "rgb(234, 236, 244)",
                            zeroLineColor: "rgb(234, 236, 244)",
                            drawBorder: false,
                            borderDash: [2],
                            zeroLineBorderDash: [2]
                        }
                    }],
                    yAxes: [{
                        gridLines: {
                            display: false,
                            drawBorder: false
                        },
                    }],
                },
                legend: {
                    display: false
                },
                tooltips: {
                    titleMarginBottom: 10,
                    titleFontColor: '#6e707e',
                    titleFontSize: 14,
                    backgroundColor: "rgb(255,255,255)",
                    bodyFontColor: "#858796",
                    borderColor: '#dddfeb',
                    borderWidth: 1,
                    xPadding: 15,
                    yPadding: 15,
                    displayColors: false,
                    caretPadding: 10,
                    callbacks: {
                        label: function(tooltipItem, chart) {
                            return tooltipItem.xLabel + " عطل";
                        }
                    }
                },
            }
        });
    }
    
    function loadKpiData(startDate, endDate) {
        // AJAX call to get KPI data for the selected date range
        $.ajax({
            url: "{% url 'maintenance:kpi_data_api' %}",
            data: {
                start_date: startDate,
                end_date: endDate
            },
            dataType: 'json',
            success: function(data) {
                // Update KPI cards
                updateKpiCards(data.kpis);
                
                // Update charts
                updateCharts(data.chart_data);
                
                // Update KPI table
                updateKpiTable(data.kpis);
            },
            error: function(xhr, status, error) {
                console.error("Error loading KPI data:", error);
                alert("حدث خطأ أثناء تحميل البيانات. يرجى المحاولة مرة أخرى.");
            }
        });
    }
    
    function updateKpiCards(kpis) {
        // Update KPI card values and trends
        // MTTR
        $('.kpi-card-primary .h5').text(kpis.mttr + " ساعة");
        var mttrTrendHtml = '';
        if (kpis.mttr_trend > 0) {
            mttrTrendHtml = '<span class="trend-down"><i class="fas fa-arrow-up"></i> ' + kpis.mttr_trend + '% من الفترة السابقة</span>';
        } else if (kpis.mttr_trend < 0) {
            mttrTrendHtml = '<span class="trend-up"><i class="fas fa-arrow-down"></i> ' + Math.abs(kpis.mttr_trend) + '% من الفترة السابقة</span>';
        } else {
            mttrTrendHtml = '<span class="trend-neutral"><i class="fas fa-equals"></i> لا تغيير عن الفترة السابقة</span>';
        }
        $('.kpi-card-primary .text-xs').html(mttrTrendHtml);
        
        // MTBF
        $('.kpi-card-success .h5').text(kpis.mtbf + " ساعة");
        var mtbfTrendHtml = '';
        if (kpis.mtbf_trend > 0) {
            mtbfTrendHtml = '<span class="trend-up"><i class="fas fa-arrow-up"></i> ' + kpis.mtbf_trend + '% من الفترة السابقة</span>';
        } else if (kpis.mtbf_trend < 0) {
            mtbfTrendHtml = '<span class="trend-down"><i class="fas fa-arrow-down"></i> ' + Math.abs(kpis.mtbf_trend) + '% من الفترة السابقة</span>';
        } else {
            mtbfTrendHtml = '<span class="trend-neutral"><i class="fas fa-equals"></i> لا تغيير عن الفترة السابقة</span>';
        }
        $('.kpi-card-success .text-xs').html(mtbfTrendHtml);
        
        // Similar updates for other KPI cards
        // ...
    }
    
    function updateCharts(chartData) {
        // Update all charts with new data
        var workOrderTypeChart = Chart.instances[0];
        workOrderTypeChart.data.labels = chartData.work_order_types_labels;
        workOrderTypeChart.data.datasets[0].data = chartData.work_order_types_data;
        workOrderTypeChart.update();
        
        var maintenanceCostChart = Chart.instances[1];
        maintenanceCostChart.data.labels = chartData.maintenance_cost_labels;
        maintenanceCostChart.data.datasets[0].data = chartData.maintenance_cost_data;
        maintenanceCostChart.update();
        
        var downtimeCategoryChart = Chart.instances[2];
        downtimeCategoryChart.data.labels = chartData.downtime_category_labels;
        downtimeCategoryChart.data.datasets[0].data = chartData.downtime_category_data;
        downtimeCategoryChart.update();
        
        var topFailingEquipmentChart = Chart.instances[3];
        topFailingEquipmentChart.data.labels = chartData.top_failing_equipment_labels;
        topFailingEquipmentChart.data.datasets[0].data = chartData.top_failing_equipment_data;
        topFailingEquipmentChart.update();
    }
    
    function updateKpiTable(kpis) {
        // Update KPI table values
        var table = $('#kpiTable');
        var rows = table.find('tbody tr');
        
        // MTTR row
        $(rows[0]).find('td:nth-child(2)').text(kpis.mttr + " ساعة");
        $(rows[0]).find('td:nth-child(3)').text(kpis.mttr_previous + " ساعة");
        var mttrTrendHtml = '';
        if (kpis.mttr_trend > 0) {
            mttrTrendHtml = '<span class="trend-down"><i class="fas fa-arrow-up"></i> ' + kpis.mttr_trend + '%</span>';
        } else if (kpis.mttr_trend < 0) {
            mttrTrendHtml = '<span class="trend-up"><i class="fas fa-arrow-down"></i> ' + Math.abs(kpis.mttr_trend) + '%</span>';
        } else {
            mttrTrendHtml = '<span class="trend-neutral"><i class="fas fa-equals"></i> 0%</span>';
        }
        $(rows[0]).find('td:nth-child(4)').html(mttrTrendHtml);
        var mttrStatusHtml = '';
        if (kpis.mttr <= kpis.mttr_target) {
            mttrStatusHtml = '<span class="badge badge-success">جيد</span>';
        } else {
            mttrStatusHtml = '<span class="badge badge-danger">يحتاج تحسين</span>';
        }
        $(rows[0]).find('td:nth-child(6)').html(mttrStatusHtml);
        
        // Update other rows similarly
        // ...
    }
});
</script>
{% endblock %}