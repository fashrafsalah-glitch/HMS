{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "تفاصيل الجهاز" %} - {{ device.name }}{% endblock %}

{% block content %}
<style>
    .device-card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
    }
    .device-header {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        border-radius: 0.5rem 0.5rem 0 0 !important;
        padding: 1.25rem;
    }
    .action-card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
    }
    .action-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border-radius: 0.5rem 0.5rem 0 0 !important;
        padding: 1rem;
    }
    .records-header {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        color: white;
        border-radius: 0.5rem 0.5rem 0 0 !important;
        padding: 1rem;
    }
    .qr-header {
        background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
        color: white;
        border-radius: 0.5rem 0.5rem 0 0 !important;
        padding: 1rem;
    }
    .operation-btn {
        border-radius: 0.375rem;
        padding: 0.75rem;
        transition: all 0.3s ease;
    }
    .operation-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.15);
    }
    .status-badge {
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
    }
</style>

<div class="container-fluid" dir="rtl">
    <div class="row">
        <div class="col-12">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-desktop text-primary me-2"></i>
                        {% trans "تفاصيل الجهاز" %}
                    </h2>
                    <p class="text-muted mb-0">{{ device.name }}</p>
                </div>
                <div class="d-flex flex-wrap gap-2">
                    <a href="{% url 'maintenance:device_info' device.id %}" class="btn btn-primary">
                        <i class="fas fa-info-circle me-1"></i>
                        {% trans "التفاصيل" %}
                    </a>
                    <a href="{% url 'maintenance:device_transfer_history' device.id %}" class="btn btn-outline-primary">
                        <i class="fas fa-history me-1"></i>
                        {% trans "سجل الحركات" %}
                    </a>
                    <a href="{% url 'maintenance:add_accessory' device.id %}" class="btn btn-secondary">
                        <i class="fas fa-plus me-1"></i>
                        {% trans "إضافة ملحق" %}
                    </a>
                    <a href="{% url 'maintenance:maintenance_schedule' device.id %}" class="btn btn-success">
                        <i class="fas fa-calendar me-1"></i>
                        {% trans "مواعيد الصيانة" %}
                    </a>
                    <a href="{% url 'maintenance:add_emergency_request' device.id %}" class="btn btn-danger">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        {% trans "صيانة مستعجلة" %}
                    </a>
                    <a href="{% url 'maintenance:add_spare_part' device.id %}" class="btn btn-warning">
                        <i class="fas fa-cog me-1"></i>
                        {% trans "قطع غيار" %}
                    </a>
                </div>
            </div>

            <!-- Device Information Card -->
            <div class="device-card card">
                <div class="device-header">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h4 class="mb-1">
                                <i class="fas fa-desktop me-2"></i>
                                {{ device.name }}
                            </h4>
                            <p class="mb-0 opacity-75">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                {{ device.department.name }} - {{ device.room.name }}
                                {% if device.serial_number %}
                                    | <i class="fas fa-barcode me-1"></i>{{ device.serial_number }}
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-4 text-start">
                            <span class="status-badge badge bg-{% if device.status == 'working' %}success{% elif device.status == 'needs_maintenance' %}warning{% elif device.status == 'broken' %}danger{% else %}secondary{% endif %} fs-6">
                                <i class="fas fa-circle me-1"></i>
                                {{ device.get_status_display }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="text-muted mb-1">{% trans "الموديل" %}</div>
                                <div class="fw-bold">{{ device.model|default:"-" }}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="text-muted mb-1">{% trans "التنظيف" %}</div>
                                <span class="badge bg-{% if device.clean_status == 'clean' %}success{% elif device.clean_status == 'needs_cleaning' %}warning{% else %}secondary{% endif %}">
                                    {{ device.get_clean_status_display }}
                                </span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="text-muted mb-1">{% trans "التعقيم" %}</div>
                                <span class="badge bg-{% if device.sterilization_status == 'sterilized' %}success{% elif device.sterilization_status == 'needs_sterilization' %}warning{% else %}secondary{% endif %}">
                                    {{ device.get_sterilization_status_display }}
                                </span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="text-muted mb-1">{% trans "آخر صيانة" %}</div>
                                <div class="small">{{ device.last_maintained_at|date:"Y-m-d"|default:"-" }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <!-- Quick Actions -->
                <div class="col-lg-8">
                    <div class="action-card card">
                        <div class="action-header">
                            <h5 class="mb-0">
                                <i class="fas fa-bolt me-2"></i>
                                {% trans "الإجراءات السريعة" %}
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    {% if not active_cleaning %}
                                        <button type="button" class="btn btn-warning operation-btn w-100" 
                                                data-bs-toggle="modal" data-bs-target="#startCleaningModal">
                                            <i class="fas fa-soap me-1"></i>
                                            {% trans "بدء التنظيف" %}
                                        </button>
                                    {% else %}
                                        <button type="button" class="btn btn-success operation-btn w-100" 
                                                data-bs-toggle="modal" data-bs-target="#endCleaningModal">
                                            <i class="fas fa-check-circle me-1"></i>
                                            {% trans "إنهاء التنظيف" %}
                                        </button>
                                    {% endif %}
                                </div>
                                <div class="col-md-3">
                                    {% if not active_sterilization %}
                                        <button type="button" class="btn btn-info operation-btn w-100" 
                                                data-bs-toggle="modal" data-bs-target="#startSterilizationModal">
                                            <i class="fas fa-shield-alt me-1"></i>
                                            {% trans "بدء التعقيم" %}
                                        </button>
                                    {% else %}
                                        <button type="button" class="btn btn-success operation-btn w-100" 
                                                data-bs-toggle="modal" data-bs-target="#endSterilizationModal">
                                            <i class="fas fa-check-circle me-1"></i>
                                            {% trans "إنهاء التعقيم" %}
                                        </button>
                                    {% endif %}
                                </div>
                                <div class="col-md-3">
                                    <a href="{% url 'maintenance:device_maintain' device.id %}" class="btn btn-success operation-btn w-100">
                                        <i class="fas fa-wrench me-1"></i>
                                        {% trans "تسجيل صيانة" %}
                                    </a>
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-primary operation-btn w-100" 
                                            data-bs-toggle="modal" data-bs-target="#cycleHistoryModal">
                                        <i class="fas fa-history me-1"></i>
                                        {% trans "سجل العمليات" %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Records Section -->
                    <div class="action-card card">
                        <div class="records-header">
                            <h5 class="mb-0">
                                <i class="fas fa-history me-2"></i>
                                {% trans "السجلات والتقارير" %}
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <a href="{% url 'maintenance:cleaning_history' device.id %}" class="btn btn-outline-warning operation-btn w-100">
                                        <i class="fas fa-soap me-1"></i>
                                        {% trans "سجل التنظيف" %}
                                    </a>
                                </div>
                                <div class="col-md-4">
                                    <a href="{% url 'maintenance:sterilization_history' device.id %}" class="btn btn-outline-info operation-btn w-100">
                                        <i class="fas fa-shield-alt me-1"></i>
                                        {% trans "سجل التعقيم" %}
                                    </a>
                                </div>
                                <div class="col-md-4">
                                    <a href="{% url 'maintenance:maintenance_history' device.id %}" class="btn btn-outline-success operation-btn w-100">
                                        <i class="fas fa-wrench me-1"></i>
                                        {% trans "سجل الصيانة" %}
                                    </a>
                                </div>
                            </div>
                            
                            {% if device.last_cleaned_by or device.last_sterilized_by or device.last_maintained_by %}
                            <div class="mt-3 pt-3 border-top">
                                <h6 class="text-muted mb-2">{% trans "آخر العمليات" %}</h6>
                                <div class="row g-2">
                                    {% if device.last_cleaned_by %}
                                    <div class="col-md-4">
                                        <small class="text-muted">
                                            <i class="fas fa-soap me-1"></i>
                                            <strong>{% trans "التنظيف:" %}</strong><br>
                                            {{ device.last_cleaned_at|date:"Y-m-d H:i" }}<br>
                                            {% trans "بواسطة" %} {{ device.last_cleaned_by.get_full_name }}
                                        </small>
                                    </div>
                                    {% endif %}
                                    {% if device.last_sterilized_by %}
                                    <div class="col-md-4">
                                        <small class="text-muted">
                                            <i class="fas fa-shield-alt me-1"></i>
                                            <strong>{% trans "التعقيم:" %}</strong><br>
                                            {{ device.last_sterilized_at|date:"Y-m-d H:i" }}<br>
                                            {% trans "بواسطة" %} {{ device.last_sterilized_by.get_full_name }}
                                        </small>
                                    </div>
                                    {% endif %}
                                    {% if device.last_maintained_by %}
                                    <div class="col-md-4">
                                        <small class="text-muted">
                                            <i class="fas fa-wrench me-1"></i>
                                            <strong>{% trans "الصيانة:" %}</strong><br>
                                            {{ device.last_maintained_at|date:"Y-m-d H:i" }}<br>
                                            {% trans "بواسطة" %} {{ device.last_maintained_by.get_full_name }}
                                        </small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Accessories Section -->
                    <div class="action-card card">
                        <div class="action-header">
                            <h5 class="mb-0">
                                <i class="fas fa-cogs me-2"></i>
                                {% trans "ملحقات الجهاز" %}
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if device.accessories.all %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>{% trans "الاسم" %}</th>
                                                <th>{% trans "الحالة" %}</th>
                                                <th>{% trans "الرقم التسلسلي" %}</th>
                                                <th>{% trans "الإجراءات" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for accessory in device.accessories.all %}
                                            <tr>
                                                <td>{{ accessory.name }}</td>
                                                <td>
                                                    <span class="badge bg-{% if accessory.status == 'available' %}success{% elif accessory.status == 'in_use' %}primary{% elif accessory.status == 'maintenance' %}warning{% elif accessory.status == 'damaged' %}danger{% else %}secondary{% endif %}">
                                                        {{ accessory.get_status_display }}
                                                    </span>
                                                </td>
                                                <td>{{ accessory.serial_number|default:"-" }}</td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <a href="{% url 'maintenance:accessory_detail' accessory.id %}" class="btn btn-outline-info" title="{% trans 'التفاصيل' %}">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                        <a href="{% url 'maintenance:accessory_edit' accessory.id %}" class="btn btn-outline-warning" title="{% trans 'تعديل' %}">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        <a href="{% url 'maintenance:accessory_qr_print' accessory.id %}" class="btn btn-outline-secondary" title="{% trans 'طباعة QR' %}">
                                                            <i class="fas fa-qrcode"></i>
                                                        </a>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-cogs fa-3x mb-3"></i>
                                    <h6 class="text-muted">{% trans "لا توجد ملحقات مسجلة" %}</h6>
                                    <p class="text-muted">{% trans "لم يتم تسجيل أي ملحقات لهذا الجهاز حتى الآن" %}</p>
                                    <a href="{% url 'maintenance:add_accessory' device.id %}" class="btn btn-primary">
                                        <i class="fas fa-plus me-1"></i>
                                        {% trans "إضافة أول ملحق" %}
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- QR Code Section -->
                <div class="col-lg-4">
                    <div class="action-card card">
                        <div class="qr-header">
                            <h5 class="mb-0">
                                <i class="fas fa-qrcode me-2"></i>
                                {% trans "رمز QR" %}
                            </h5>
                        </div>
                        <div class="card-body text-center">
                            {% if device.qr_code %}
                                <img src="{{ device.qr_code.url }}" alt="QR Code" class="img-fluid mb-3" style="max-width: 200px; border-radius: 0.375rem;">
                                {% if device.qr_token %}
                                    <div class="small text-muted mb-3">
                                        <code>{{ device.qr_token }}</code>
                                    </div>
                                {% endif %}
                                <a href="{% url 'maintenance:device_transfer' device.id %}" class="btn btn-outline-primary w-100">
                                    <i class="fas fa-exchange-alt me-1"></i>
                                    {% trans "نقل الجهاز" %}
                                </a>
                            {% else %}
                                <div class="text-muted py-4">
                                    <i class="fas fa-qrcode fa-3x mb-3"></i>
                                    <p class="mb-0">{% trans "لا يوجد رمز QR" %}</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container for Notifications -->
<div class="toast-container position-fixed top-0 end-0 p-3">
  <div id="actionToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">{% trans "إشعار" %}</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="toastMessage">
      <!-- Message will be inserted here -->
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Handle AJAX action buttons
    document.querySelectorAll('.ajax-action-btn').forEach(button => {
        button.addEventListener('click', function() {
            const url = this.dataset.url;
            const action = this.dataset.action;
            const deviceId = this.dataset.deviceId;
            const btnText = this.querySelector('.btn-text');
            const spinner = this.querySelector('.spinner-border');
            
            // Disable button and show spinner
            this.disabled = true;
            btnText.classList.add('d-none');
            spinner.classList.remove('d-none');
            
            // Make AJAX request
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update UI based on action type
                    updateDeviceStatus(action, data);
                    
                    // Show success toast
                    showToast(data.message, 'success');
                    
                    // Update button text to show completion
                    btnText.textContent = '✅ تم بنجاح';
                    btnText.classList.remove('d-none');
                    spinner.classList.add('d-none');
                    
                    // Re-enable button after 2 seconds
                    setTimeout(() => {
                        this.disabled = false;
                        btnText.textContent = getOriginalButtonText(action);
                    }, 2000);
                } else {
                    // Show error toast
                    showToast(data.message, 'error');
                    
                    // Re-enable button
                    this.disabled = false;
                    btnText.classList.remove('d-none');
                    spinner.classList.add('d-none');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('حدث خطأ في العملية', 'error');
                
                // Re-enable button
                this.disabled = false;
                btnText.classList.remove('d-none');
                spinner.classList.add('d-none');
            });
        });
    });
    
    function updateDeviceStatus(action, data) {
        // Update status badges in the device info section
        if (action === 'clean') {
            // Find and update clean status badge
            const cleanBadges = document.querySelectorAll('.badge');
            cleanBadges.forEach(badge => {
                if (badge.textContent.includes('نظيف') || badge.textContent.includes('يحتاج')) {
                    badge.textContent = data.clean_status;
                    badge.className = `badge bg-${data.clean_status_class}`;
                }
            });
        } else if (action === 'sterilize') {
            // Find and update sterilization status badge
            const sterilizeBadges = document.querySelectorAll('.badge');
            sterilizeBadges.forEach(badge => {
                if (badge.textContent.includes('معقم') || badge.textContent.includes('تعقيم')) {
                    badge.textContent = data.sterilization_status;
                    badge.className = `badge bg-${data.sterilization_status_class}`;
                }
            });
        }
    }
    
    function getOriginalButtonText(action) {
        switch(action) {
            case 'clean': return 'تنظيف الجهاز';
            case 'sterilize': return 'تعقيم الجهاز';
            case 'maintenance': return 'تسجيل صيانة';
            default: return 'تم';
        }
    }
    
    function showToast(message, type) {
        const toast = document.getElementById('actionToast');
        const toastMessage = document.getElementById('toastMessage');
        const toastHeader = toast.querySelector('.toast-header');
        
        // Set message
        toastMessage.textContent = message;
        
        // Set color based on type
        if (type === 'success') {
            toast.className = 'toast border-success';
            toastHeader.className = 'toast-header bg-success text-white';
        } else {
            toast.className = 'toast border-danger';
            toastHeader.className = 'toast-header bg-danger text-white';
        }
        
        // Show toast
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    }
});
</script>

<!-- Modals -->

<!-- Start Sterilization Modal -->
<div class="modal fade" id="startSterilizationModal" tabindex="-1" aria-labelledby="startSterilizationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="startSterilizationModalLabel">
                    <i class="fas fa-shield-virus me-2"></i>
                    بدء دورة التعقيم - {{ device.name }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'maintenance:start_sterilization' device.id %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="method" class="form-label">طريقة التعقيم</label>
                        <select class="form-select" id="method" name="method" required>
                            <option value="autoclave">أوتوكلاف</option>
                            <option value="chemical">كيميائي</option>
                            <option value="gas">غاز</option>
                            <option value="radiation">إشعاع</option>
                            <option value="dry_heat">حرارة جافة</option>
                            <option value="other">أخرى</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="lot_number" class="form-label">رقم الدفعة</label>
                        <input type="text" class="form-control" id="lot_number" name="lot_number">
                    </div>
                    <div class="mb-3">
                        <label for="indicators" class="form-label">المؤشرات</label>
                        <textarea class="form-control" id="indicators" name="indicators" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="before_image" class="form-label">صورة قبل التعقيم</label>
                        <input type="file" class="form-control" id="before_image" name="before_image" accept="image/*">
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">ملاحظات</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-info">
                        <i class="fas fa-play me-1"></i>
                        بدء التعقيم
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- End Sterilization Modal -->
<div class="modal fade" id="endSterilizationModal" tabindex="-1" aria-labelledby="endSterilizationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="endSterilizationModalLabel">
                    <i class="fas fa-check-circle me-2"></i>
                    إنهاء دورة التعقيم - {{ device.name }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'maintenance:end_sterilization' device.id %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    {% if active_sterilization %}
                    <div class="alert alert-info">
                        <strong>دورة التعقيم النشطة:</strong><br>
                        بدأت: {{ active_sterilization.start_time|date:"Y-m-d H:i" }}<br>
                        الطريقة: {{ active_sterilization.get_method_display }}<br>
                        رقم الدفعة: {{ active_sterilization.lot_number|default:"-" }}
                    </div>
                    {% endif %}
                    <div class="mb-3">
                        <label for="after_image" class="form-label">صورة بعد التعقيم</label>
                        <input type="file" class="form-control" id="after_image" name="after_image" accept="image/*">
                    </div>
                    <div class="mb-3">
                        <label for="final_notes" class="form-label">ملاحظات نهائية</label>
                        <textarea class="form-control" id="final_notes" name="final_notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check me-1"></i>
                        إنهاء التعقيم
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Start Cleaning Modal -->
<div class="modal fade" id="startCleaningModal" tabindex="-1" aria-labelledby="startCleaningModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="startCleaningModalLabel">
                    <i class="fas fa-broom me-2"></i>
                    بدء دورة التنظيف - {{ device.name }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'maintenance:start_cleaning' device.id %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="cleaning_image" class="form-label">صورة التنظيف</label>
                        <input type="file" class="form-control" id="cleaning_image" name="image" accept="image/*">
                    </div>
                    <div class="mb-3">
                        <label for="cleaning_notes" class="form-label">ملاحظات</label>
                        <textarea class="form-control" id="cleaning_notes" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-play me-1"></i>
                        بدء التنظيف
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- End Cleaning Modal -->
<div class="modal fade" id="endCleaningModal" tabindex="-1" aria-labelledby="endCleaningModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="endCleaningModalLabel">
                    <i class="fas fa-check-circle me-2"></i>
                    إنهاء دورة التنظيف - {{ device.name }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'maintenance:end_cleaning' device.id %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    {% if active_cleaning %}
                    <div class="alert alert-info">
                        <strong>دورة التنظيف النشطة:</strong><br>
                        بدأت: {{ active_cleaning.start_time|date:"Y-m-d H:i" }}
                    </div>
                    {% endif %}
                    <div class="mb-3">
                        <label for="final_image" class="form-label">صورة نهائية</label>
                        <input type="file" class="form-control" id="final_image" name="final_image" accept="image/*">
                    </div>
                    <div class="mb-3">
                        <label for="cleaning_final_notes" class="form-label">ملاحظات نهائية</label>
                        <textarea class="form-control" id="cleaning_final_notes" name="final_notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check me-1"></i>
                        إنهاء التنظيف
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Cycle History Modal -->
<div class="modal fade" id="cycleHistoryModal" tabindex="-1" aria-labelledby="cycleHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="cycleHistoryModalLabel">
                    <i class="fas fa-history me-2"></i>
                    سجل العمليات - {{ device.name }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Tabs -->
                <ul class="nav nav-tabs" id="historyTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="sterilization-history-tab" data-bs-toggle="tab" data-bs-target="#sterilization-history" type="button" role="tab">
                            <i class="fas fa-shield-virus me-1"></i>
                            التعقيم
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="cleaning-history-tab" data-bs-toggle="tab" data-bs-target="#cleaning-history" type="button" role="tab">
                            <i class="fas fa-broom me-1"></i>
                            التنظيف
                        </button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content mt-3" id="historyTabsContent">
                    <!-- Sterilization History -->
                    <div class="tab-pane fade show active" id="sterilization-history" role="tabpanel">
                        {% if sterilization_cycles %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>التاريخ</th>
                                        <th>الطريقة</th>
                                        <th>رقم الدفعة</th>
                                        <th>المستخدم</th>
                                        <th>المدة</th>
                                        <th>الحالة</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cycle in sterilization_cycles %}
                                    <tr>
                                        <td>{{ cycle.start_time|date:"Y-m-d H:i" }}</td>
                                        <td>{{ cycle.get_method_display }}</td>
                                        <td>{{ cycle.lot_number|default:"-" }}</td>
                                        <td>{{ cycle.user.get_full_name|default:cycle.user.username }}</td>
                                        <td>
                                            {% if cycle.duration %}
                                                {{ cycle.duration }}
                                            {% elif not cycle.is_completed %}
                                                <span class="badge bg-warning">جاري...</span>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if cycle.is_completed %}
                                                <span class="badge bg-success">مكتمل</span>
                                            {% else %}
                                                <span class="badge bg-warning">نشط</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-shield-virus fa-3x mb-3"></i>
                            <p>لا توجد دورات تعقيم مسجلة</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Cleaning History -->
                    <div class="tab-pane fade" id="cleaning-history" role="tabpanel">
                        {% if cleaning_cycles %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>التاريخ</th>
                                        <th>المستخدم</th>
                                        <th>المدة</th>
                                        <th>الحالة</th>
                                        <th>ملاحظات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cycle in cleaning_cycles %}
                                    <tr>
                                        <td>{{ cycle.start_time|date:"Y-m-d H:i" }}</td>
                                        <td>{{ cycle.user.get_full_name|default:cycle.user.username }}</td>
                                        <td>
                                            {% if cycle.duration %}
                                                {{ cycle.duration }}
                                            {% elif not cycle.is_completed %}
                                                <span class="badge bg-warning">جاري...</span>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if cycle.is_completed %}
                                                <span class="badge bg-success">مكتمل</span>
                                            {% else %}
                                                <span class="badge bg-warning">نشط</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ cycle.notes|truncatechars:50|default:"-" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-broom fa-3x mb-3"></i>
                            <p>لا توجد دورات تنظيف مسجلة</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}