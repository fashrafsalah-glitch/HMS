{% extends "base.html" %}

{% block title %}الأجهزة في {{ department.name }}{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-primary mb-0">الأجهزة الخاصة بالقسم: {{ department.name }}</h3>
        <div>
            <a href="{% url 'maintenance:all_devices_transfer' %}?from_department={{ department.id }}" class="btn btn-primary">
                <i class="fas fa-exchange-alt"></i> طلب نقل جهاز
            </a>
            <a href="{% url 'maintenance:department_transfer_requests' department.id %}" class="btn btn-info">
                <i class="fas fa-list"></i> طلبات النقل للقسم
            </a>
        </div>
    </div>

    
    {% if actual_devices or requested_devices %}
        <h4 class="mt-4">🟢 الأجهزة الفعلية ({{ actual_devices|length }})</h4>
        <table class="table table-striped table-bordered align-middle text-center">
            <thead class="table-success">
                <tr>
                     <th>Serial No.</th>
                    <th>الاسم</th>
                    
                    <th>الغرفة</th>
                   
                     <th>الحالة</th>
                     <th>النظافة</th>
                     <th>التعقيم</th>
                     <th>المريض الحالي</th> 
                    
                     <th>Start use</th>
                    <th>End use</th>
                    <th>الإجراءات</th>
                    <th>الحالة</th>
                </tr>
            </thead>
            <tbody>
                {% for device in actual_devices %}
                <tr>
                    <td>{{ device.id }}</td>
                    <td>{{ device.name }}</td>
                    
                    <td>{{ device.room }}</td>
                   
                    <td>{{ device.get_status_display }}</td>
                    <td>{{ device.get_clean_status_display }}</td>
                    <td>{{ device.get_sterilization_status_display }}</td>
                    <td>{{ device.current_patient }}</td>
                   
                    <td>
                        {% if device.status == 'working' and not device.current_patient %}
                        <a href="{% url 'maintenance:assign_device' device.id %}" class="btn btn-sm btn-primary">📥 استخدام</a>
                         {% else %}
                        <span class="text-muted">قيد الاستخدام</span>
                                  {% endif %}
                   </td>

                   <td>
                      {% if device.current_patient %}
                      <a href="{% url 'maintenance:release_device' device.id %}" class="btn btn-sm btn-warning">⏹️ إنهاء الاستخدام</a>
                      {% else %}
                      <span class="text-muted">-</span>
                      {% endif %}
                    </td> 
                     <td>
                    <a href="{% url 'maintenance:device_detail' device.id %}" class="btn btn-sm btn-info" title="Open">👁️</a>
                    <a href="{% url 'maintenance:device_edit' device.id %}" class="btn btn-sm btn-warning" title="Edit">✏️</a>
                    <a href="{% url 'maintenance:device_delete' device.id %}" class="btn btn-sm btn-danger" title="Delete">🗑️</a>
                    <a href="{% url 'maintenance:device_transfer' device.id %}" class="btn btn-sm btn-secondary" title="Transfer">🔄</a>
                   </td>
                    <td><span class="text-success">✅ نشط</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <!-- إضافة الأجهزة المطلوبة إلى جدول الأجهزة الفعلية -->
        

        {% if false %}
        <h4 class="mt-5">🟡 الأجهزة المطلوبة (بانتظار الموافقة)</h4>
        <table class="table table-striped table-bordered align-middle text-center">
            <thead class="table-warning">
                <tr>
                     <th>Serial No.</th>
                    <th>اسم الجهاز</th>
                    <th>من القسم</th>
                    <th>تاريخ الطلب</th>
                    <th>الحالة</th>
                </tr>
            </thead>
            <tbody>
                {% for request in requested_devices %}
                <tr>
                    <td>{{ request.device.id }}</td>
                    <td>{{ request.device.name }}</td>
                    <td>{{ request.from_department.name }}</td>
                    <td>{{ request.requested_at|date:"Y-m-d H:i" }}</td>
                    <td>
                        {% if request.status == 'pending' %}
                        <span class="badge badge-warning">بانتظار الموافقة</span>
                        {% elif request.status == 'approved' %}
                        <span class="badge badge-success">تمت الموافقة - بانتظار القبول</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        {% if pending_transfers %}
        <h4 class="mt-5">📥 طلبات النقل الواردة (بانتظار الموافقة)</h4>
        <table class="table table-striped table-bordered align-middle text-center">
            <thead class="table-warning">
                <tr>
                     <th>Serial No.</th>
                    <th>اسم الجهاز</th>
                    <th>القسم الطالب</th>
                    <th>إلى القسم</th>
                    <th>طالب النقل</th>
                    <th>الحالة</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody>
                {% for transfer in pending_transfers %}
                <tr>
                    <td>{{ transfer.device.id }}</td>
                    <td>{{ transfer.device.name }}</td>
                    <td>{{ transfer.from_department.name }}</td>
                    <td>{{ transfer.to_department.name }}</td>
                    <td>{{ transfer.requested_by.username }}</td>
                    <td>
                        {% if transfer.status == 'pending' %}
                        <span class="badge badge-warning">بانتظار الموافقة</span>
                        {% elif transfer.status == 'approved' %}
                        <span class="badge badge-info">تمت الموافقة</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if transfer.status == 'pending' %}
                        <div class="btn-group">
                            <form method="post" action="{% url 'maintenance:approve_transfer_request' transfer.id %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-success">✔️ موافقة</button>
                            </form>
                            <form method="post" action="{% url 'maintenance:reject_transfer_request' transfer.id %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-danger">❌ رفض</button>
                            </form>
                        </div>
                        {% elif transfer.status == 'approved' %}
                        <span class="text-info">تمت الموافقة - بانتظار القبول من القسم المستقبل</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        {% if outgoing_transfers %}
        <h4 class="mt-5">📤 طلبات النقل المعلقة ({{ outgoing_transfers|length }})</h4>
        <table class="table table-striped table-bordered align-middle text-center">
            <thead class="table-info">
                <tr>
                     <th>Serial No.</th>
                    <th>اسم الجهاز</th>
                    <th>إلى قسم</th>
                    <th>تاريخ الطلب</th>
                    <th>الحالة</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody>
                {% for transfer in outgoing_transfers %}
                <tr>
                    <td>{{ transfer.device.id }}</td>
                    <td>{{ transfer.device.name }}</td>
                    <td>{{ transfer.to_department.name }}</td>
                    <td>{{ transfer.requested_at|date:"Y-m-d H:i" }}</td>
                    <td>
                        {% if transfer.status == 'pending' %}
                        <span class="badge badge-warning">بانتظار الموافقة</span>
                        {% elif transfer.status == 'approved' %}
                        <span class="badge badge-info">تمت الموافقة - بانتظار القبول</span>
                        {% else %}
                        <span class="badge badge-secondary">{{ transfer.get_status_display }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'maintenance:transfer_request_detail' transfer.pk %}" class="btn btn-sm btn-info">
                            <i class="fas fa-eye"></i> عرض
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    {% else %}
        <p class="text-danger text-center mt-5">لا توجد أجهزة مسجلة لهذا القسم.</p>
    {% endif %}
    <div class="text-center mt-4">
        <a href="{% url 'manager:department_page' department.id %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> العودة لصفحة القسم
        </a>
    </div>
</div>
{% endblock %}