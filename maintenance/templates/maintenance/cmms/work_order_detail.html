{% extends 'base.html' %}
{% load static %}

{% block title %}تفاصيل أمر الشغل{% endblock %}

{% block content %}
<style>
/* Force all text elements to be white in dark mode with maximum specificity */
body.dark-mode * {
    color: #e5e7eb !important;
}

/* Preserve badge colors */
body.dark-mode .badge {
    color: inherit !important;
}

/* Preserve button colors */
body.dark-mode .btn {
    color: inherit !important;
}

/* Links should be blue-ish in dark mode */
body.dark-mode a:not(.btn):not(.nav-link):not(.badge) {
    color: #93c5fd !important;
}

body.dark-mode a:not(.btn):not(.nav-link):not(.badge):hover {
    color: #bfdbfe !important;
}

/* Muted text in dark mode */
body.dark-mode .text-muted {
    color: #9ca3af !important;
}

/* Alert text colors */
body.dark-mode .alert {
    color: inherit !important;
}

/* Card titles and headers */
body.dark-mode .card-title,
body.dark-mode .card-header * {
    color: #f3f4f6 !important;
}

/* Timeline and chat specific fixes */
body.dark-mode .timeline-item {
    background: #2d3748 !important;
    color: #e5e7eb !important;
}

body.dark-mode .direct-chat-text {
    background: #2d3748 !important;
    color: #e5e7eb !important;
}

body.dark-mode .direct-chat-msg.right .direct-chat-text {
    background: #3b82f6 !important;
    color: white !important;
}

/* Comments section fixes */
body.dark-mode .direct-chat-messages {
    background: #1f2937 !important;
    color: #e5e7eb !important;
}

body.dark-mode .comment-form {
    background: #1f2937 !important;
    color: #e5e7eb !important;
}

body.dark-mode .comment-form textarea,
body.dark-mode .comment-form input {
    background: #374151 !important;
    color: #e5e7eb !important;
    border-color: #4b5563 !important;
}

body.dark-mode .comment-form textarea::placeholder,
body.dark-mode .comment-form input::placeholder {
    color: #9ca3af !important;
}

body.dark-mode .comment-form label {
    color: #e5e7eb !important;
}

    .work-order-card {
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-radius: 10px;
    }
    .status-badge {
        font-size: 0.9rem;
        padding: 6px 12px;
    }
    .direct-chat-messages {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
    }
    .direct-chat-msg {
        margin-bottom: 15px;
    }
    .direct-chat-text {
        background: #fff;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        position: relative;
    }
    .direct-chat-msg.right .direct-chat-text {
        background: #007bff;
        color: white;
    }
    .direct-chat-text::before {
        content: '';
        position: absolute;
        top: 10px;
        left: -8px;
        width: 0;
        height: 0;
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
        border-right: 8px solid #fff;
    }
    .direct-chat-msg.right .direct-chat-text::before {
        left: auto;
        right: -8px;
        border-right: none;
        border-left: 8px solid #007bff;
    }
    .timeline {
        position: relative;
        margin: 0;
        padding: 0;
    }
    .timeline::before {
        content: '';
        position: absolute;
        top: 0;
        left: 15px;
        height: 100%;
        width: 2px;
        background: #dee2e6;
    }
    .timeline li {
        position: relative;
        margin-bottom: 20px;
        list-style: none;
    }
    .timeline .fas.fa-circle {
        position: absolute;
        left: 10px;
        top: 5px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        z-index: 2;
    }
    .timeline-item {
        margin-left: 35px;
        background: #fff;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .parts-stats {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .parts-stats .stat-item {
        text-align: center;
    }
    .parts-stats .stat-number {
        font-size: 1.5rem;
        font-weight: bold;
        display: block;
    }
    .parts-stats .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    .comment-form {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
    }
    .btn-circle {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>


<div class="container-fluid">
    <div class="row">
        <div class="col-md-8">
            <!-- بطاقة تفاصيل أمر الشغل -->
            <div class="card work-order-card">
                <div class="card-header">
                    <h3 class="card-title">أمر شغل #WO-{{ work_order.id }}</h3>
                    <div class="card-tools">
                        <a href="{% url 'maintenance:cmms:work_order_list' %}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i> العودة للقائمة
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-4">الجهاز:</dt>
                                <dd class="col-sm-8">
                                    {% if work_order.service_request.device %}
                                        <a href="{% url 'maintenance:device_detail' work_order.service_request.device.id %}">
                                            {{ work_order.service_request.device.name }}{% if work_order.service_request.device.serial_number %} ({{ work_order.service_request.device.serial_number }}){% endif %}
                                        </a>
                                    {% else %}
                                        <span class="text-muted">غير محدد</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-4">حالة الجهاز:</dt>
                                <dd class="col-sm-8">
                                    {% if work_order.service_request.device %}
                                        {% if work_order.service_request.device.status == 'working' %}
                                            <span class="badge badge-success">{{ work_order.service_request.device.get_status_display }}</span>
                                        {% elif work_order.service_request.device.status == 'needs_maintenance' %}
                                            <span class="badge badge-warning">{{ work_order.service_request.device.get_status_display }}</span>
                                        {% elif work_order.service_request.device.status == 'out_of_order' %}
                                            <span class="badge badge-danger">{{ work_order.service_request.device.get_status_display }}</span>
                                        {% elif work_order.service_request.device.status == 'needs_check' %}
                                            <span class="badge badge-info">{{ work_order.service_request.device.get_status_display }}</span>
                                        {% else %}
                                            <span class="badge badge-secondary">{{ work_order.service_request.device.get_status_display }}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">غير محدد</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-4">القسم:</dt>
                                <dd class="col-sm-8">
                                    {% if work_order.service_request.device and work_order.service_request.device.department %}
                                        {{ work_order.service_request.device.department.name }}
                                    {% else %}
                                        <span class="text-muted">غير محدد</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-4">الموقع:</dt>
                                <dd class="col-sm-8">
                                    {% if work_order.service_request.device and work_order.service_request.device.room %}
                                        {{ work_order.service_request.device.room }}
                                    {% else %}
                                        <span class="text-muted">غير محدد</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-4">البلاغ المرتبط:</dt>
                                <dd class="col-sm-8">
                                    {% if work_order.service_request %}
                                        <a href="{% url 'maintenance:cmms:service_request_detail' work_order.service_request.id %}">
                                            SR-{{ work_order.service_request.id }}: {{ work_order.service_request.title }}
                                        </a>
                                    {% else %}
                                        <span class="text-muted">لا يوجد</span>
                                    {% endif %}
                                </dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-4">الحالة:</dt>
                                <dd class="col-sm-8">
                                    {% if work_order.status == 'new' %}
                                        <span class="badge badge-primary status-badge">{{ work_order.get_status_display }}</span>
                                    {% elif work_order.status == 'assigned' %}
                                        <span class="badge badge-info status-badge">{{ work_order.get_status_display }}</span>
                                    {% elif work_order.status == 'in_progress' %}
                                        <span class="badge badge-warning status-badge">{{ work_order.get_status_display }}</span>
                                    {% elif work_order.status == 'on_hold' or work_order.status == 'wait_parts' %}
                                        <span class="badge badge-secondary status-badge">{{ work_order.get_status_display }}</span>
                                    {% elif work_order.status == 'resolved' or work_order.status == 'qa_verified' %}
                                        <span class="badge badge-success status-badge">{{ work_order.get_status_display }}</span>
                                    {% elif work_order.status == 'closed' %}
                                        <span class="badge badge-dark status-badge">{{ work_order.get_status_display }}</span>
                                    {% elif work_order.status == 'cancelled' %}
                                        <span class="badge badge-danger status-badge">{{ work_order.get_status_display }}</span>
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-4">الفني المسؤول:</dt>
                                <dd class="col-sm-8">
                                    {% if work_order.assignee %}
                                        {{ work_order.assignee.get_full_name }}
                                    {% else %}
                                        <span class="text-muted">غير معين</span>
                                        {% if perms.maintenance.assign_workorder %}
                                            <a href="{% url 'maintenance:cmms:work_order_assign' work_order.id %}" class="btn btn-primary btn-sm ml-2">
                                                <i class="fas fa-user-plus"></i> تعيين
                                            </a>
                                        {% endif %}
                                    {% endif %}
                                </dd>
                                
                                <dt class="col-sm-4">تاريخ الإنشاء:</dt>
                                <dd class="col-sm-8">{{ work_order.created_at|date:"Y-m-d H:i" }}</dd>
                                
                                <dt class="col-sm-4">آخر تحديث:</dt>
                                <dd class="col-sm-8">{{ work_order.updated_at|date:"Y-m-d H:i" }}</dd>
                                
                                {% if work_order.start_time %}
                                <dt class="col-sm-4">وقت البدء:</dt>
                                <dd class="col-sm-8">{{ work_order.start_time|date:"Y-m-d H:i" }}</dd>
                                {% endif %}
                                
                                {% if work_order.end_time %}
                                <dt class="col-sm-4">وقت الانتهاء:</dt>
                                <dd class="col-sm-8">{{ work_order.end_time|date:"Y-m-d H:i" }}</dd>
                                {% endif %}
                                
                                {% if work_order.actual_hours %}
                                <dt class="col-sm-4">الساعات الفعلية:</dt>
                                <dd class="col-sm-8">{{ work_order.actual_hours }} ساعة</dd>
                                {% endif %}
                                
                                {% if work_order.labor_cost %}
                                <dt class="col-sm-4">تكلفة العمالة:</dt>
                                <dd class="col-sm-8">{{ work_order.labor_cost }} ريال</dd>
                                {% endif %}
                                
                                {% if work_order.parts_cost %}
                                <dt class="col-sm-4">تكلفة القطع:</dt>
                                <dd class="col-sm-8">{{ work_order.parts_cost }} ريال</dd>
                                {% endif %}
                                
                                {% if work_order.total_cost %}
                                <dt class="col-sm-4">التكلفة الإجمالية:</dt>
                                <dd class="col-sm-8">
                                    <strong class="text-success">{{ work_order.total_cost }} ريال</strong>
                                </dd>
                                {% endif %}
                            </dl>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <h5>وصف العمل:</h5>
                            <div class="p-3 bg-light rounded">
                                {{ work_order.description|linebreaks }}
                            </div>
                        </div>
                    </div>
                    
                    {% if work_order.resolution %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <h5>الحل:</h5>
                            <div class="p-3 bg-light rounded">
                                {{ work_order.resolution|linebreaks }}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                     <!-- قسم قطع الغيار -->
                     <div class="card mt-4">
                         <div class="card-header">
                             <div class="d-flex justify-content-between align-items-center">
                                 <h5 class="mb-0">
                                     <i class="fas fa-tools"></i>
                                     قطع الغيار
                                 </h5>
                                 <div>
                                     {% if can_request_parts %}
                                     <a href="{% url 'maintenance:cmms:work_order_part_request' work_order.id %}" 
                                        class="btn btn-primary btn-sm">
                                         <i class="fas fa-plus"></i> طلب قطعة غيار
                                     </a>
                                     {% endif %}
                                     <a href="{% url 'maintenance:cmms:work_order_parts_list' work_order.id %}" 
                                        class="btn btn-info btn-sm">
                                         <i class="fas fa-list"></i> عرض الكل
                                     </a>
                                 </div>
                             </div>
                         </div>
                         
                         <div class="card-body">
                             {% if parts_requested or spare_part_requests %}
                                <!-- إحصائيات سريعة -->
                                <div class="parts-stats">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="stat-item">
                                                <span class="stat-number">{{ parts_stats.spare_requests_stats.total_requested }}</span>
                                                <span class="stat-label">إجمالي الطلبات</span>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-item">
                                                <span class="stat-number">{{ parts_stats.spare_requests_stats.fulfilled }}</span>
                                                <span class="stat-label">تم الصرف</span>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-item">
                                                <span class="stat-number">{{ parts_stats.spare_requests_stats.pending }}</span>
                                                <span class="stat-label">قيد الانتظار</span>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-item">
                                                <span class="stat-number">{{ work_order.calculate_parts_cost|floatformat:2 }}</span>
                                                <span class="stat-label">التكلفة (ريال)</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                 <!-- قائمة مختصرة لقطع الغيار -->
                                 <div class="table-responsive">
                                     <table class="table table-sm">
                                         <thead>
                                             <tr>
                                                 <th>القطعة</th>
                                                 <th>الكمية</th>
                                                 <th>الحالة</th>
                                             </tr>
                                         </thead>
                                         <tbody>
                                             {% for part in parts_requested|slice:":5" %}
                                             <tr>
                                                 <td>
                                                     <strong>{{ part.spare_part.name }}</strong>
                                                     <br>
                                                     <small class="text-muted">{{ part.spare_part.part_number }}</small>
                                                 </td>
                                                 <td>
                                                     {{ part.quantity_requested }}
                                                     {% if part.quantity_used > 0 %}
                                                         <br>
                                                         <small class="text-success">مصروف: {{ part.quantity_used }}</small>
                                                     {% endif %}
                                                 </td>
                                                 <td>
                                                     {% if part.status == 'requested' %}
                                                         <span class="badge badge-warning">مطلوبة</span>
                                                     {% elif part.status == 'issued' %}
                                                         <span class="badge badge-success">مصروفة</span>
                                                     {% elif part.status == 'returned' %}
                                                         <span class="badge badge-info">مرتجعة</span>
                                                     {% endif %}
                                                 </td>
                                                 <td>
                                                     {% if part.unit_cost %}
                                                         {{ part.unit_cost }} ريال
                                                     {% else %}
                                                         -
                                                     {% endif %}
                                                 </td>
                                             </tr>
                                             {% endfor %}
                                             
                                             <!-- عرض طلبات قطع الغيار من SparePartRequest -->
                                             {% for request in spare_part_requests|slice:":5" %}
                                             <tr class="table-info">
                                                 <td>
                                                     <strong>{{ request.spare_part.name }}</strong>
                                                     <br>
                                                     <small class="text-muted">{{ request.spare_part.part_number }}</small>
                                                     <br>
                                                     <small class="text-info">طلب رقم: {{ request.request_number }}</small>
                                                 </td>
                                                 <td>
                                                     {{ request.quantity_requested }}
                                                 </td>
                                                 <td>
                                                     {% if request.status == 'pending' %}
                                                         <span class="badge badge-warning">في الانتظار</span>
                                                     {% elif request.status == 'approved' %}
                                                         <span class="badge badge-success">موافق عليه</span>
                                                     {% elif request.status == 'rejected' %}
                                                         <span class="badge badge-danger">مرفوض</span>
                                                     {% elif request.status == 'fulfilled' %}
                                                         <span class="badge badge-success">تم التنفيذ</span>
                                                     {% elif request.status == 'cancelled' %}
                                                         <span class="badge badge-secondary">ملغي</span>
                                                     {% endif %}
                                                 </td>
                                             </tr>
                                             {% endfor %}
                                         </tbody>
                                     </table>
                                 </div>
                                 
                                 {% if parts_requested.count > 5 %}
                                 <div class="text-center mt-3">
                                     <a href="{% url 'maintenance:cmms:work_order_parts_list' work_order.id %}" 
                                        class="btn btn-outline-primary btn-sm">
                                         عرض جميع {{ parts_requested.count }} قطعة
                                     </a>
                                 </div>
                                 {% endif %}
                             {% else %}
                                 <div class="text-center py-3">
                                     <i class="fas fa-tools fa-2x text-muted mb-2"></i>
                                     <p class="text-muted">لا توجد قطع غيار مطلوبة</p>
                                     {% if can_request_parts %}
                                     <a href="{% url 'maintenance:cmms:work_order_part_request' work_order.id %}" 
                                        class="btn btn-primary btn-sm">
                                         <i class="fas fa-plus"></i> طلب أول قطعة غيار
                                     </a>
                                     {% endif %}
                                 </div>
                             {% endif %}
                         </div>
                     </div>
                     
                     <!-- نموذج تحديث الحالة -->
                    {% if can_update_status %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card card-primary card-outline">
                                <div class="card-header">
                                    <h5 class="card-title">تحديث حالة أمر الشغل</h5>
                                </div>
                                <div class="card-body">
                                    <form method="post" action="{% url 'maintenance:cmms:work_order_update_status' work_order.id %}" name="update_status">
                                        {% csrf_token %}
                                        <div class="form-row">
                                            <div class="form-group col-md-6">
                                                <label for="{{ status_form.status.id_for_label }}">الحالة الجديدة:</label>
                                                {{ status_form.status }}
                                            </div>
                                            <div class="form-group col-md-6">
                                                {{ status_form.labor_cost.label_tag }}
                                                {{ status_form.labor_cost }}
                                            </div>
                                        </div>

                                        <button type="submit" name="update_status" class="btn btn-primary">
                                            <i class="fas fa-save"></i> تحديث الحالة
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Device Status Update Section -->
                    {% if device_needs_status_change and can_update_status %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card card-success card-outline">
                                <div class="card-header">
                                    <h5 class="card-title">تحديث حالة الجهاز</h5>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i>
                                        الجهاز "{{ work_order.service_request.device.name }}" في حالة "{{ work_order.service_request.device.get_status_display }}" وأمر الشغل مكتمل. 
                                        يمكنك تحديث حالة الجهاز إلى "يعمل" إذا كان الجهاز يعمل بشكل طبيعي.
                                    </div>
                                    <form method="post">
                                        {% csrf_token %}
                                        <button type="submit" name="update_device_status" class="btn btn-success" 
                                                onclick="return confirm('هل أنت متأكد من تغيير حالة الجهاز إلى يعمل؟')">
                                            <i class="fas fa-check-circle"></i> تحديث حالة الجهاز إلى "يعمل"
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- بطاقة التعليقات -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">التعليقات والملاحظات</h3>
                </div>
                <div class="card-body">
                    <!-- قائمة التعليقات -->
                    <div class="direct-chat-messages" style="height: 400px; overflow-y: auto;">
                        {% for comment in comments %}
                            <div class="direct-chat-msg {% if comment.user == request.user %}right{% endif %}">
                                <div class="direct-chat-infos clearfix">
                                    <span class="direct-chat-name {% if comment.user == request.user %}float-right{% else %}float-left{% endif %}">
                                        {{ comment.user.get_full_name }}
                                    </span>
                                    <span class="direct-chat-timestamp {% if comment.user == request.user %}float-left{% else %}float-right{% endif %}">
                                        {{ comment.created_at|date:"Y-m-d H:i" }}
                                    </span>
                                </div>
                                <div class="direct-chat-text">
                                    {{ comment.comment|linebreaks }}
                                </div>
                            </div>
                        {% empty %}
                            <div class="text-center text-muted">
                                <p>لا توجد تعليقات</p>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <!-- نموذج إضافة تعليق -->
                    <div class="comment-form">
                        <form method="post" action="{% url 'maintenance:cmms:work_order_add_comment' work_order.id %}">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="{{ comment_form.comment.id_for_label }}" class="font-weight-bold">
                                    <i class="fas fa-comment"></i> إضافة تعليق جديد
                                </label>
                                {{ comment_form.comment }}
                            </div>
                            <div class="text-right">
                                <button type="submit" class="btn btn-primary btn-sm">
                                    <i class="fas fa-paper-plane"></i> إرسال التعليق
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- بطاقة سجل التغييرات -->
            <div class="card mt-3">
                <div class="card-header">
                    <h3 class="card-title">سجل التغييرات</h3>
                </div>
                <div class="card-body p-0">
                    <ul class="timeline timeline-inverse" style="margin: 0 10px 0 0;">
                        {% for log in status_logs %}
                            <li>
                                <i class="fas fa-circle bg-primary"></i>
                                <div class="timeline-item">
                                    <span class="time"><i class="fas fa-clock"></i> {{ log.created_at|date:"Y-m-d H:i" }}</span>
                                    <h3 class="timeline-header">{{ log.user.get_full_name }} قام بتغيير الحالة</h3>
                                    <div class="timeline-body">
                                        تم تغيير الحالة من 
                                        <span class="badge badge-secondary">{{ log.get_old_status_display }}</span> 
                                        إلى 
                                        <span class="badge badge-primary">{{ log.get_new_status_display }}</span>
                                    </div>
                                </div>
                            </li>
                        {% empty %}
                            <li>
                                <div class="timeline-item">
                                    <div class="timeline-body text-center text-muted">
                                        لا توجد تغييرات مسجلة
                                    </div>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}