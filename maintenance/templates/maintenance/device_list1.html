{% extends 'base.html' %} 
{% load static %}

{% block content %}
<div class="container mt-4" dir="rtl">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h2 class="mb-1">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</h2>
      <p class="text-muted mb-0">Ø§Ø¨Ø­Ø« ÙˆÙÙ„ØªØ± ÙˆØªØµÙØ­ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø¨Ø³Ø±Ø¹Ø©</p>
    </div>
    <div class="d-flex gap-2">
      <a href="{% url 'maintenance:add_device' %}" class="btn btn-primary">â• Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯</a>
      <a href="{% url 'maintenance:qr_test_page' %}" class="btn btn-info">ğŸ” Ø§Ø®ØªØ¨Ø§Ø± QR - Step 2</a>
      <a href="{% url 'maintenance:add_device_category' %}" class="btn btn-outline-secondary">â• ØªØµÙ†ÙŠÙ</a>
      <a href="{% url 'maintenance:add_device_subcategory' %}" class="btn btn-outline-secondary">â• ØªØµÙ†ÙŠÙ ÙØ±Ø¹ÙŠ</a>
      <a href="{% url 'add_company' %}" class="btn btn-outline-secondary">â• Ø´Ø±ÙƒØ©</a>
      <a href="{% url 'add_device_type' %}" class="btn btn-outline-secondary">â• Ù†ÙˆØ¹ Ø¬Ù‡Ø§Ø²</a>
      <a href="{% url 'add_device_usage' %}" class="btn btn-outline-secondary">â• Ø§Ø³ØªØ®Ø¯Ø§Ù…</a>
    </div>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Ø§Ù„ØªØµÙ†ÙŠÙ</label>
          <select name="category" id="category-select" class="form-select">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            {% for cat in categories %}
              <option value="{{ cat.id }}" {% if request.GET.category == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ±Ø¹ÙŠ</label>
          <select name="subcategory" id="subcategory-select" class="form-select">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            {% for sub in subcategories %}
              <option value="{{ sub.id }}" {% if request.GET.subcategory == sub.id|stringformat:"s" %}selected{% endif %}>{{ sub.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Ø§Ù„Ù‚Ø³Ù…</label>
          <select name="department" id="department-select" class="form-select">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            {% for dept in departments %}
              <option value="{{ dept.id }}" {% if request.GET.department == dept.id|stringformat:"s" %}selected{% endif %}>{{ dept.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Ø§Ù„ØºØ±ÙØ©</label>
          <select name="room" id="room-select" class="form-select">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            {% for room in rooms %}
              <option value="{{ room.id }}" data-dept="{{ room.department_id }}" {% if request.GET.room == room.id|stringformat:"s" %}selected{% endif %}>{{ room.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-2">
          <button type="submit" class="btn btn-primary w-100">ğŸ” Ø¨Ø­Ø«</button>
        </div>
        <div class="col-md-2">
          <a href="{% url 'maintenance:device_list' %}" class="btn btn-light border w-100">âŸ² Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</a>
        </div>
      </form>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light sticky-top">
          <tr>
            <th>#</th>
            <th>Ø±Ù‚Ù…</th>
            <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
            <th>Ø§Ù„ÙØ±Ø¹ÙŠ</th>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø§Ù„Ù‚Ø³Ù…</th>
            <th>Ø§Ù„ØºØ±ÙØ©</th>
            <th>Ø§Ù„Ø³Ø±ÙŠØ±</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„Ù†Ø¸Ø§ÙØ©</th>
            <th>Ø§Ù„ØªØ¹Ù‚ÙŠÙ…</th>
            <th>Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
            <th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            <th>Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</th>
            <th>Ø¥Ù†Ù‡Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody>
          {% for device in devices %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ device.id }}</td>
              <td>{{ device.category.name }}</td>
              <td>{{ device.subcategory.name }}</td>
              <td class="fw-semibold">{{ device.name }}</td>
              <td>{{ device.department.name }}</td>
              <td>{{ device.room }}</td>
              <td>{{ device.bed }}</td>
              <td>
                <span class="badge text-bg-{% if device.status == 'working' %}success{% elif device.status == 'in_use' %}info{% elif device.status == 'needs_check' %}warning{% else %}secondary{% endif %}">
                  {{ device.get_status_display }}
                </span>
              </td>
              <td>
                <span class="badge text-bg-{% if device.clean_status == 'clean' %}success{% elif device.clean_status == 'needs_cleaning' %}warning{% else %}secondary{% endif %}">
                  {{ device.get_clean_status_display }}
                </span>
              </td>
              <td>
                <span class="badge text-bg-{% if device.sterilization_status == 'sterilized' %}success{% elif device.sterilization_status == 'needs_sterilization' %}warning{% else %}secondary{% endif %}">
                  {{ device.get_sterilization_status_display }}
                </span>
              </td>
              <td>{{ device.current_patient|default:"-" }}</td>
              <td class="text-center">
                {% if device.qr_code %}
                  <div class="d-flex align-items-center justify-content-center gap-2">
                    <a href="{{ device.qr_code.url }}" target="_blank" title="ÙØªØ­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯">
                      <img src="{{ device.qr_code.url }}" alt="QR" class="img-thumbnail" style="width:56px;height:56px;object-fit:contain;"/>
                    </a>
                    <a href="{{ device.qr_code.url }}" download class="btn btn-sm btn-outline-secondary" title="ØªØ­Ù…ÙŠÙ„">
                      â¬‡ï¸
                    </a>
                  </div>
                {% else %}
                  <span class="badge text-bg-secondary">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>
                {% endif %}
              </td>
              <td class="text-nowrap">
                <a href="{% url 'maintenance:device_detail' device.id %}" class="btn btn-sm btn-outline-info" title="ÙØªØ­">ğŸ‘ï¸</a>
                <a href="{% url 'maintenance:device_edit' device.id %}" class="btn btn-sm btn-outline-warning" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</a>
                <a href="{% url 'maintenance:device_delete' device.id %}" class="btn btn-sm btn-outline-danger" title="Ø­Ø°Ù">ğŸ—‘ï¸</a>
                <a href="{% url 'maintenance:device_transfer' device.id %}" class="btn btn-sm btn-outline-secondary" title="Ù†Ù‚Ù„">ğŸ”„</a>
              </td>
              <td>
                {% if device.status == 'working' and not device.current_patient %}
                  <a href="{% url 'maintenance:assign_device' device.id %}" class="btn btn-sm btn-primary">ğŸ“¥ Ø§Ø³ØªØ®Ø¯Ø§Ù…</a>
                {% else %}
                  <span class="text-muted">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</span>
                {% endif %}
              </td>
              <td>
                {% if device.current_patient %}
                  <a href="{% url 'maintenance:release_device' device.id %}" class="btn btn-sm btn-warning">â¹ï¸ Ø¥Ù†Ù‡Ø§Ø¡</a>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="15" class="text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¬Ù‡Ø²Ø© Ù…Ø·Ø§Ø¨Ù‚Ø©.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ±Ø¹ÙŠ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØªØµÙ†ÙŠÙ
  $('#category-select').on('change', function () {
    var categoryId = $(this).val();
    $.ajax({
      url: "{% url 'maintenance:ajax_load_subcategories' %}",
      data: { 'category_id': categoryId },
      success: function (data) {
        var subcategorySelect = $('#subcategory-select');
        subcategorySelect.empty();
        subcategorySelect.append('<option value="">Ø§Ù„ÙƒÙ„</option>');
        data.forEach(function (subcategory) {
          subcategorySelect.append('<option value="' + subcategory.id + '">' + subcategory.name + '</option>');
        });
      }
    });
  });

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±Ù Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
  document.getElementById('department-select').addEventListener('change', function () {
    const deptId = this.value;
    const roomSelect = document.getElementById('room-select');
    roomSelect.innerHTML = '<option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>';

    fetch(`/maintenance/ajax/load-rooms/?department_id=${deptId}`)
      .then(response => response.json())
      .then(data => {
        roomSelect.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';
        data.forEach(room => {
          const option = document.createElement('option');
          option.value = room.id;
          option.text = room.name;
          roomSelect.appendChild(option);
        });
      });
  });
</script>
{% endblock %}