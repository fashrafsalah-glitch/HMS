{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "إضافة ملحق جديد" %}{% endblock %}

{% block extra_css %}
<style>
    .card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border-radius: 0.5rem;
    }
    .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 0.5rem 0.5rem 0 0 !important;
        padding: 1.25rem;
    }
    .form-control, .form-select {
        border-radius: 0.375rem;
        border: 1px solid #dee2e6;
        padding: 0.75rem;
        transition: all 0.15s ease-in-out;
    }
    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 0.375rem;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
    }
    .btn-secondary {
        background-color: #6c757d;
        border: none;
        border-radius: 0.375rem;
        padding: 0.75rem 1.5rem;
    }
    .required-field::after {
        content: " *";
        color: #dc3545;
    }
    .form-text {
        font-size: 0.875rem;
        color: #6c757d;
    }
    .alert {
        border-radius: 0.375rem;
        border: none;
    }
    .device-info {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" dir="rtl">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-plus-circle text-primary me-2"></i>
                        {% trans "إضافة ملحق جديد" %}
                    </h2>
                    <p class="text-muted mb-0">{% trans "إضافة ملحق جديد للجهاز المحدد" %}</p>
                </div>
                <a href="{% url 'maintenance:device_info' device.id %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-right me-1"></i>
                    {% trans "العودة للجهاز" %}
                </a>
            </div>

            <!-- Device Information Card -->
            <div class="device-info">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-1">
                            <i class="fas fa-desktop text-primary me-2"></i>
                            {{ device.name }}
                        </h5>
                        <p class="text-muted mb-0">
                            <small>
                                <i class="fas fa-map-marker-alt me-1"></i>
                                {{ device.department.name }} - {{ device.room.name }}
                                {% if device.serial_number %}
                                    | <i class="fas fa-barcode me-1"></i>{{ device.serial_number }}
                                {% endif %}
                            </small>
                        </p>
                    </div>
                    <div class="col-md-4 text-start">
                        <span class="badge bg-{% if device.status == 'operational' %}success{% elif device.status == 'maintenance' %}warning{% else %}danger{% endif %} fs-6">
                            {{ device.get_status_display }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Add Accessory Form Card -->
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-puzzle-piece me-2"></i>
                        {% trans "بيانات الملحق الجديد" %}
                    </h4>
                </div>
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% else %}info-circle{% endif %} me-2"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <form method="post" id="accessoryForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <!-- Basic Information -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_name" class="form-label required-field">
                                        <i class="fas fa-tag me-1"></i>
                                        {% trans "اسم الملحق" %}
                                    </label>
                                    <input type="text" class="form-control" id="id_name" name="name" required>
                                    <div class="form-text">{% trans "أدخل اسم الملحق بوضوح" %}</div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_serial_number" class="form-label">
                                        <i class="fas fa-barcode me-1"></i>
                                        {% trans "الرقم التسلسلي" %}
                                    </label>
                                    <input type="text" class="form-control" id="id_serial_number" name="serial_number">
                                    <div class="form-text">{% trans "الرقم التسلسلي للملحق (اختياري)" %}</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_model" class="form-label">
                                        <i class="fas fa-cog me-1"></i>
                                        {% trans "الموديل" %}
                                    </label>
                                    <input type="text" class="form-control" id="id_model" name="model">
                                    <div class="form-text">{% trans "موديل الملحق" %}</div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_manufacturer" class="form-label">
                                        <i class="fas fa-industry me-1"></i>
                                        {% trans "الشركة المصنعة" %}
                                    </label>
                                    <input type="text" class="form-control" id="id_manufacturer" name="manufacturer">
                                    <div class="form-text">{% trans "اسم الشركة المصنعة" %}</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_purchase_date" class="form-label">
                                        <i class="fas fa-calendar-alt me-1"></i>
                                        {% trans "تاريخ الشراء" %}
                                    </label>
                                    <input type="date" class="form-control" id="id_purchase_date" name="purchase_date">
                                    <div class="form-text">{% trans "تاريخ شراء الملحق" %}</div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_warranty_expiry" class="form-label">
                                        <i class="fas fa-shield-alt me-1"></i>
                                        {% trans "انتهاء الضمان" %}
                                    </label>
                                    <input type="date" class="form-control" id="id_warranty_expiry" name="warranty_expiry">
                                    <div class="form-text">{% trans "تاريخ انتهاء ضمان الملحق" %}</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_status" class="form-label required-field">
                                        <i class="fas fa-info-circle me-1"></i>
                                        {% trans "الحالة" %}
                                    </label>
                                    <select class="form-select" id="id_status" name="status" required>
                                        <option value="">{% trans "اختر الحالة" %}</option>
                                        <option value="available" selected>{% trans "متاح" %}</option>
                                        <option value="in_use">{% trans "قيد الاستخدام" %}</option>
                                        <option value="maintenance">{% trans "تحت الصيانة" %}</option>
                                        <option value="damaged">{% trans "تالف" %}</option>
                                        <option value="lost">{% trans "مفقود" %}</option>
                                    </select>
                                    <div class="form-text">{% trans "حالة الملحق الحالية" %}</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="id_description" class="form-label">
                                <i class="fas fa-align-left me-1"></i>
                                {% trans "الوصف" %}
                            </label>
                            <textarea class="form-control" id="id_description" name="description" rows="4" placeholder="{% trans 'وصف تفصيلي للملحق ووظيفته...' %}"></textarea>
                            <div class="form-text">{% trans "وصف تفصيلي للملحق (اختياري)" %}</div>
                        </div>

                        <!-- Hidden device field -->
                        <input type="hidden" name="device" value="{{ device.id }}">

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                            <div class="text-muted">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    {% trans "الحقول المطلوبة مميزة بعلامة" %} <span class="text-danger">*</span>
                                </small>
                            </div>
                            <div>
                                <a href="{% url 'maintenance:device_info' device.id %}" class="btn btn-secondary me-2">
                                    <i class="fas fa-times me-1"></i>
                                    {% trans "إلغاء" %}
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>
                                    {% trans "حفظ الملحق" %}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-apply form-control classes
    const inputs = document.querySelectorAll('input:not([type="hidden"]), select, textarea');
    inputs.forEach(input => {
        if (!input.classList.contains('form-control') && !input.classList.contains('form-select')) {
            if (input.tagName === 'SELECT') {
                input.classList.add('form-select');
            } else {
                input.classList.add('form-control');
            }
        }
    });

    // Form validation
    const form = document.getElementById('accessoryForm');
    form.addEventListener('submit', function(e) {
        const nameField = document.getElementById('id_name');
        const statusField = document.getElementById('id_status');
        
        if (!nameField.value.trim()) {
            e.preventDefault();
            nameField.focus();
            showAlert('يرجى إدخال اسم الملحق', 'error');
            return;
        }
        
        if (!statusField.value) {
            e.preventDefault();
            statusField.focus();
            showAlert('يرجى اختيار حالة الملحق', 'error');
            return;
        }
    });

    // Auto-generate serial number suggestion
    const nameField = document.getElementById('id_name');
    const serialField = document.getElementById('id_serial_number');
    
    nameField.addEventListener('blur', function() {
        if (this.value && !serialField.value) {
            const suggestion = 'ACC-' + Date.now().toString().slice(-6);
            serialField.placeholder = 'مثال: ' + suggestion;
        }
    });

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            <i class="fas fa-exclamation-circle me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const form = document.getElementById('accessoryForm');
        form.insertBefore(alertDiv, form.firstChild);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }
});
</script>
{% endblock %}