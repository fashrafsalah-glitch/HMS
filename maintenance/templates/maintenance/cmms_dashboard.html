{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.css">
<style>
    .kpi-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }
    
    .kpi-card:hover {
        transform: translateY(-5px);
    }
    
    .kpi-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .kpi-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .alert-card {
        border-left: 4px solid #dc3545;
        background: #fff5f5;
        margin-bottom: 10px;
        border-radius: 8px;
    }
    
    .alert-card.severity-high {
        border-left-color: #dc3545;
        background: #fff5f5;
    }
    
    .alert-card.severity-medium {
        border-left-color: #ffc107;
        background: #fffbf0;
    }
    
    .alert-card.severity-low {
        border-left-color: #17a2b8;
        background: #f0f9ff;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .trend-indicator {
        font-size: 0.8rem;
        margin-left: 10px;
    }
    
    .trend-up {
        color: #28a745;
    }
    
    .trend-down {
        color: #dc3545;
    }
    
    .dashboard-section {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- عنوان الصفحة والفلاتر -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="mb-0">
                <i class="fas fa-tachometer-alt text-primary"></i>
                {{ page_title }}
            </h2>
            <p class="text-muted">آخر تحديث: {{ dashboard_data.last_updated|date:"Y-m-d H:i" }}</p>
        </div>
        <div class="col-md-4">
            <form method="GET" class="d-flex">
                <select name="department" class="form-control me-2" onchange="this.form.submit()">
                    <option value="">جميع الأقسام</option>
                    {% for dept in departments %}
                        <option value="{{ dept.id }}" {% if selected_department.id == dept.id %}selected{% endif %}>
                            {{ dept.name }}
                        </option>
                    {% endfor %}
                </select>
                <button type="button" class="btn btn-outline-primary" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- الإحصائيات السريعة -->
    <div class="stats-grid">
        <div class="kpi-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="kpi-value">{{ quick_stats.total_devices }}</div>
            <div class="kpi-label">إجمالي الأجهزة</div>
        </div>
        
        <div class="kpi-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="kpi-value">{{ quick_stats.active_work_orders }}</div>
            <div class="kpi-label">أوامر الشغل النشطة</div>
        </div>
        
        <div class="kpi-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <div class="kpi-value">{{ dashboard_data.availability|floatformat:1 }}%</div>
            <div class="kpi-label">نسبة التوفر</div>
            {% if dashboard_data.availability >= 95 %}
                <span class="trend-indicator trend-up"><i class="fas fa-arrow-up"></i> ممتاز</span>
            {% elif dashboard_data.availability >= 85 %}
                <span class="trend-indicator"><i class="fas fa-minus"></i> جيد</span>
            {% else %}
                <span class="trend-indicator trend-down"><i class="fas fa-arrow-down"></i> يحتاج تحسين</span>
            {% endif %}
        </div>
        
        <div class="kpi-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
            <div class="kpi-value">{{ dashboard_data.pm_compliance|floatformat:1 }}%</div>
            <div class="kpi-label">الالتزام بالصيانة الوقائية</div>
            {% if dashboard_data.pm_compliance >= 90 %}
                <span class="trend-indicator trend-up"><i class="fas fa-arrow-up"></i> ممتاز</span>
            {% elif dashboard_data.pm_compliance >= 70 %}
                <span class="trend-indicator"><i class="fas fa-minus"></i> جيد</span>
            {% else %}
                <span class="trend-indicator trend-down"><i class="fas fa-arrow-down"></i> يحتاج تحسين</span>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- المؤشرات الرئيسية -->
        <div class="col-lg-8">
            <div class="dashboard-section">
                <h5 class="mb-3">
                    <i class="fas fa-chart-line text-primary"></i>
                    المؤشرات الرئيسية
                </h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">MTBF (متوسط الوقت بين الأعطال)</h6>
                                <h3 class="text-primary">{{ dashboard_data.mtbf|floatformat:1 }} ساعة</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">MTTR (متوسط وقت الإصلاح)</h6>
                                <h3 class="text-info">{{ dashboard_data.mttr|floatformat:1 }} ساعة</h3>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- رسم بياني لأوامر الشغل -->
                <div class="mt-4">
                    <h6>توزيع أوامر الشغل حسب الحالة</h6>
                    <div class="chart-container">
                        <canvas id="workOrderChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- إحصائيات قطع الغيار -->
            <div class="dashboard-section">
                <h5 class="mb-3">
                    <i class="fas fa-cogs text-warning"></i>
                    إحصائيات قطع الغيار
                </h5>
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-success">{{ dashboard_data.spare_parts_stats.available_parts }}</h4>
                            <small class="text-muted">متوفرة</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-warning">{{ dashboard_data.spare_parts_stats.low_stock_parts }}</h4>
                            <small class="text-muted">مخزون منخفض</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-danger">{{ dashboard_data.spare_parts_stats.out_of_stock_parts }}</h4>
                            <small class="text-muted">منتهية</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-info">{{ dashboard_data.spare_parts_stats.total_inventory_value|floatformat:0 }}</h4>
                            <small class="text-muted">قيمة المخزون (جنيه)</small>
                        </div>
                    </div>
                </div>
                
                <!-- رسم بياني لقطع الغيار -->
                <div class="mt-4">
                    <div class="chart-container">
                        <canvas id="sparePartsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- التنبيهات الحرجة -->
        <div class="col-lg-4">
            <div class="dashboard-section">
                <h5 class="mb-3">
                    <i class="fas fa-exclamation-triangle text-danger"></i>
                    التنبيهات الحرجة
                    <span class="badge bg-danger">{{ critical_alerts|length }}</span>
                </h5>
                
                <div class="alerts-container" style="max-height: 400px; overflow-y: auto;">
                    {% for alert in critical_alerts %}
                        <div class="alert-card severity-{{ alert.severity }} p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">{{ alert.title }}</h6>
                                    <p class="mb-1 text-muted small">{{ alert.description }}</p>
                                    <small class="text-muted">{{ alert.created_at|timesince }} مضت</small>
                                </div>
                                <div>
                                    {% if alert.severity == 'high' %}
                                        <i class="fas fa-exclamation-circle text-danger"></i>
                                    {% elif alert.severity == 'medium' %}
                                        <i class="fas fa-exclamation-triangle text-warning"></i>
                                    {% else %}
                                        <i class="fas fa-info-circle text-info"></i>
                                    {% endif %}
                                </div>
                            </div>
                            {% if alert.url %}
                                <a href="{{ alert.url }}" class="btn btn-sm btn-outline-primary mt-2">
                                    عرض التفاصيل
                                </a>
                            {% endif %}
                        </div>
                    {% empty %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-check-circle fa-3x mb-3"></i>
                            <p>لا توجد تنبيهات حرجة حالياً</p>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- روابط سريعة -->
            <div class="dashboard-section">
                <h5 class="mb-3">
                    <i class="fas fa-link text-success"></i>
                    روابط سريعة
                </h5>
                
                <div class="d-grid gap-2">
                    <a href="{% url 'maintenance:cmms:service_request_create' %}" class="btn btn-outline-primary">
                        <i class="fas fa-plus"></i> طلب خدمة جديد
                    </a>
                    <a href="{% url 'maintenance:cmms:work_order_list' %}" class="btn btn-outline-info">
                        <i class="fas fa-tasks"></i> أوامر الشغل
                    </a>
                    <a href="{% url 'maintenance:spare_parts:spare_part_list' %}" class="btn btn-outline-warning">
                        <i class="fas fa-cogs"></i> قطع الغيار
                    </a>
                    <a href="{% url 'maintenance:device_list' %}" class="btn btn-outline-success">
                        <i class="fas fa-desktop"></i> الأجهزة
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- الاتجاهات الشهرية -->
    <div class="dashboard-section">
        <h5 class="mb-3">
            <i class="fas fa-chart-area text-info"></i>
            الاتجاهات الشهرية
        </h5>
        
        <div class="chart-container" style="height: 400px;">
            <canvas id="trendsChart"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
// إعدادات الرسوم البيانية
Chart.defaults.font.family = 'Cairo, sans-serif';
Chart.defaults.plugins.legend.rtl = true;

// رسم بياني لأوامر الشغل
const workOrderCtx = document.getElementById('workOrderChart').getContext('2d');
const workOrderChart = new Chart(workOrderCtx, {
    type: 'doughnut',
    data: {
        labels: ['جديد', 'مُعيَّن', 'قيد التنفيذ', 'في انتظار قطع الغيار', 'محلول', 'مُغلق'],
        datasets: [{
            data: [
                {{ dashboard_data.work_order_stats.new }},
                {{ dashboard_data.work_order_stats.assigned }},
                {{ dashboard_data.work_order_stats.in_progress }},
                {{ dashboard_data.work_order_stats.wait_parts }},
                {{ dashboard_data.work_order_stats.resolved }},
                {{ dashboard_data.work_order_stats.closed }}
            ],
            backgroundColor: [
                '#ff6384',
                '#36a2eb',
                '#ffce56',
                '#4bc0c0',
                '#9966ff',
                '#ff9f40'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// رسم بياني لقطع الغيار
const sparePartsCtx = document.getElementById('sparePartsChart').getContext('2d');
const sparePartsChart = new Chart(sparePartsCtx, {
    type: 'bar',
    data: {
        labels: ['متوفرة', 'مخزون منخفض', 'منتهية', 'مطلوبة'],
        datasets: [{
            label: 'عدد قطع الغيار',
            data: [
                {{ dashboard_data.spare_parts_stats.available_parts }},
                {{ dashboard_data.spare_parts_stats.low_stock_parts }},
                {{ dashboard_data.spare_parts_stats.out_of_stock_parts }},
                {{ dashboard_data.spare_parts_stats.on_order_parts }}
            ],
            backgroundColor: [
                '#28a745',
                '#ffc107',
                '#dc3545',
                '#17a2b8'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// رسم بياني للاتجاهات الشهرية
const trendsCtx = document.getElementById('trendsChart').getContext('2d');
const trendsChart = new Chart(trendsCtx, {
    type: 'line',
    data: {
        labels: [
            {% for trend in dashboard_data.monthly_trends %}
                '{{ trend.month_name }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [{
            label: 'نسبة التوفر (%)',
            data: [
                {% for trend in dashboard_data.monthly_trends %}
                    {{ trend.availability|default:0 }}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            borderColor: '#36a2eb',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            tension: 0.4
        }, {
            label: 'الالتزام بالصيانة الوقائية (%)',
            data: [
                {% for trend in dashboard_data.monthly_trends %}
                    {{ trend.pm_compliance|default:0 }}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            borderColor: '#4bc0c0',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100
            }
        },
        plugins: {
            legend: {
                position: 'top'
            }
        }
    }
});

// دالة تحديث الداشبورد
function refreshDashboard() {
    location.reload();
}

// تحديث تلقائي كل 5 دقائق
setInterval(refreshDashboard, 300000);
</script>
{% endblock %}
