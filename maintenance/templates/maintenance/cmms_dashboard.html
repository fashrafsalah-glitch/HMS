{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ page_title }}{% endblock %}


{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.css">
<style>
    /* تحسين الألوان للوضعين الفاتح والغامق */
    .kpi-card {
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        transition: all 0.4s ease;
        position: relative;
        overflow: hidden;
    }
    
    .kpi-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 15px 35px rgba(0,0,0,0.2);
    }
    
    .kpi-value {
        font-size: 3rem;
        font-weight: 800;
        margin-bottom: 8px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .kpi-label {
        font-size: 1rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* تحسين بطاقات التنبيهات */
    .alert-card {
        border: none;
        border-radius: 12px;
        margin-bottom: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .alert-card::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 5px;
    }
    
    .alert-card:hover {
        transform: translateX(5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }
    
    .alert-card.severity-high::before {
        background: linear-gradient(180deg, #dc3545, #c82333);
    }
    
    .alert-card.severity-medium::before {
        background: linear-gradient(180deg, #ffc107, #e0a800);
    }
    
    .alert-card.severity-low::before {
        background: linear-gradient(180deg, #17a2b8, #138496);
    }
    
    .chart-container {
        position: relative;
        height: 350px;
        margin-bottom: 25px;
        padding: 15px;
        background: var(--bs-body-bg);
        border-radius: 15px;
        box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 25px;
        margin-bottom: 35px;
    }
    
    .trend-indicator {
        font-size: 0.85rem;
        margin-left: 12px;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 20px;
        display: inline-block;
    }
    
    .trend-up {
        background: rgba(40, 167, 69, 0.15);
        color: #28a745;
    }
    
    .trend-down {
        background: rgba(220, 53, 69, 0.15);
        color: #dc3545;
    }
    
    .dashboard-section {
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
    }
    
    .dashboard-section:hover {
        box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        transform: translateY(-2px);
    }
    
    /* تحسين عناوين الأقسام */
    .section-title {
        font-size: 1.4rem;
        font-weight: 700;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 3px solid var(--bs-primary);
        position: relative;
    }
    
    .section-title::after {
        content: '';
        position: absolute;
        bottom: -3px;
        left: 0;
        width: 60px;
        height: 3px;
        background: linear-gradient(90deg, var(--bs-primary), var(--bs-info));
        border-radius: 2px;
    }
    
    /* تحسين البطاقات الفرعية */
    .metric-card {
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    
    /* تحسين الأزرار */
    .dashboard-btn {
        border-radius: 12px;
        padding: 12px 20px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    /* تحسين الألوان للوضع الغامق */
    [data-bs-theme="dark"] .alert-card.severity-high {
        background: rgba(220, 53, 69, 0.1);
        color: #f8d7da;
    }
    
    [data-bs-theme="dark"] .alert-card.severity-medium {
        background: rgba(255, 193, 7, 0.1);
        color: #fff3cd;
    }
    
    [data-bs-theme="dark"] .alert-card.severity-low {
        background: rgba(23, 162, 184, 0.1);
        color: #d1ecf1;
    }
    
    /* تحسين التدرجات اللونية */
    .gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .gradient-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
    }
    
    .gradient-info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }
    
    .gradient-warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }
</style>
<div class="container-fluid">
    <!-- عنوان الصفحة والفلاتر -->
    <div class="row mb-5">
        <div class="col-md-8">
            <div class="dashboard-header">
                <h1 class="display-5 fw-bold mb-2">
                    <i class="fas fa-tachometer-alt text-primary me-3"></i>
                    {{ page_title }}
                </h1>
                <p class="lead text-muted mb-0">
                    <i class="fas fa-clock me-2"></i>
                    آخر تحديث: {{ dashboard_data.last_updated|date:"Y-m-d H:i" }}
                </p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="dashboard-controls">
                <form method="GET" class="d-flex gap-2">
                    <select name="department" class="form-select" onchange="this.form.submit()">
                        <option value="">🏥 جميع الأقسام</option>
                        {% for dept in departments %}
                            <option value="{{ dept.id }}" {% if selected_department.id == dept.id %}selected{% endif %}>
                                {{ dept.name }}
                            </option>
                        {% endfor %}
                    </select>
                    <button type="button" class="btn btn-primary dashboard-btn" onclick="refreshDashboard()" title="تحديث البيانات">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- الإحصائيات السريعة -->
    <div class="stats-grid">
        <div class="kpi-card gradient-primary">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <i class="fas fa-desktop fa-2x opacity-75"></i>
                <div class="kpi-value">{{ quick_stats.total_devices }}</div>
            </div>
            <div class="kpi-label">
                <i class="fas fa-microchip me-2"></i>
                إجمالي الأجهزة
            </div>
        </div>
        
        <div class="kpi-card gradient-warning">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <i class="fas fa-tasks fa-2x opacity-75"></i>
                <div class="kpi-value">{{ quick_stats.active_work_orders }}</div>
            </div>
            <div class="kpi-label">
                <i class="fas fa-wrench me-2"></i>
                أوامر الشغل النشطة
            </div>
        </div>
        
        <div class="kpi-card gradient-info">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <i class="fas fa-chart-line fa-2x opacity-75"></i>
                <div class="kpi-value">{{ dashboard_data.availability|floatformat:1 }}%</div>
            </div>
            <div class="kpi-label">
                <i class="fas fa-heartbeat me-2"></i>
                نسبة التوفر
                {% if dashboard_data.availability >= 95 %}
                    <span class="trend-indicator trend-up"><i class="fas fa-arrow-up"></i> ممتاز</span>
                {% elif dashboard_data.availability >= 85 %}
                    <span class="trend-indicator"><i class="fas fa-minus"></i> جيد</span>
                {% else %}
                    <span class="trend-indicator trend-down"><i class="fas fa-arrow-down"></i> يحتاج تحسين</span>
                {% endif %}
            </div>
        </div>
        
        <div class="kpi-card gradient-success">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <i class="fas fa-shield-alt fa-2x opacity-75"></i>
                <div class="kpi-value">{{ dashboard_data.pm_compliance|floatformat:1 }}%</div>
            </div>
            <div class="kpi-label">
                <i class="fas fa-calendar-check me-2"></i>
                الالتزام بالصيانة الوقائية
                {% if dashboard_data.pm_compliance >= 90 %}
                    <span class="trend-indicator trend-up"><i class="fas fa-arrow-up"></i> ممتاز</span>
                {% elif dashboard_data.pm_compliance >= 70 %}
                    <span class="trend-indicator"><i class="fas fa-minus"></i> جيد</span>
                {% else %}
                    <span class="trend-indicator trend-down"><i class="fas fa-arrow-down"></i> يحتاج تحسين</span>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row">
        <!-- المؤشرات الرئيسية -->
        <div class="col-lg-8">
            <div class="dashboard-section">
                <h5 class="mb-3">
                    <i class="fas fa-chart-line text-primary"></i>
                    المؤشرات الرئيسية
                </h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">MTBF (متوسط الوقت بين الأعطال)</h6>
                                <h3 class="text-primary">{{ dashboard_data.mtbf|floatformat:1 }} ساعة</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">MTTR (متوسط وقت الإصلاح)</h6>
                                <h3 class="text-info">{{ dashboard_data.mttr|floatformat:1 }} ساعة</h3>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- رسم بياني لأوامر الشغل -->
                <div class="mt-4">
                    <h6>توزيع أوامر الشغل حسب الحالة</h6>
                    <div class="chart-container">
                        <canvas id="workOrderChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- إحصائيات قطع الغيار -->
            <div class="dashboard-section">
                <h5 class="mb-3">
                    <i class="fas fa-cogs text-warning"></i>
                    إحصائيات قطع الغيار
                </h5>
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-success">{{ dashboard_data.spare_parts_stats.available_parts }}</h4>
                            <small class="text-muted">متوفرة</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-warning">{{ dashboard_data.spare_parts_stats.low_stock_parts }}</h4>
                            <small class="text-muted">مخزون منخفض</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-danger">{{ dashboard_data.spare_parts_stats.out_of_stock_parts }}</h4>
                            <small class="text-muted">منتهية</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-info">{{ dashboard_data.spare_parts_stats.total_inventory_value|floatformat:0 }}</h4>
                            <small class="text-muted">قيمة المخزون (جنيه)</small>
                        </div>
                    </div>
                </div>
                
                <!-- رسم بياني لقطع الغيار -->
                <div class="mt-4">
                    <div class="chart-container">
                        <canvas id="sparePartsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- التنبيهات الحرجة -->
        <div class="col-lg-4">
            <div class="dashboard-section">
                <h5 class="mb-3">
                    <i class="fas fa-exclamation-triangle text-danger"></i>
                    التنبيهات الحرجة
                    <span class="badge bg-danger">{{ critical_alerts|length }}</span>
                </h5>
                
                <div class="alerts-container" style="max-height: 400px; overflow-y: auto;">
                    {% for alert in critical_alerts %}
                        <div class="alert-card severity-{{ alert.severity }} p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">{{ alert.title }}</h6>
                                    <p class="mb-1 text-muted small">{{ alert.description }}</p>
                                    <small class="text-muted">{{ alert.created_at|timesince }} مضت</small>
                                </div>
                                <div>
                                    {% if alert.severity == 'high' %}
                                        <i class="fas fa-exclamation-circle text-danger"></i>
                                    {% elif alert.severity == 'medium' %}
                                        <i class="fas fa-exclamation-triangle text-warning"></i>
                                    {% else %}
                                        <i class="fas fa-info-circle text-info"></i>
                                    {% endif %}
                                </div>
                            </div>
                            {% if alert.url %}
                                <a href="{{ alert.url }}" class="btn btn-sm btn-outline-primary mt-2">
                                    عرض التفاصيل
                                </a>
                            {% endif %}
                        </div>
                    {% empty %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-check-circle fa-3x mb-3"></i>
                            <p>لا توجد تنبيهات حرجة حالياً</p>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- روابط سريعة -->
            <div class="dashboard-section">
                <h5 class="mb-3">
                    <i class="fas fa-link text-success"></i>
                    روابط سريعة
                </h5>
                
                <div class="d-grid gap-2">
                    <a href="{% url 'maintenance:cmms:service_request_create' %}" class="btn btn-outline-primary">
                        <i class="fas fa-plus"></i> طلب خدمة جديد
                    </a>
                    <a href="{% url 'maintenance:cmms:work_order_list' %}" class="btn btn-outline-info">
                        <i class="fas fa-tasks"></i> أوامر الشغل
                    </a>
                    <a href="{% url 'maintenance:spare_parts:spare_part_list' %}" class="btn btn-outline-warning">
                        <i class="fas fa-cogs"></i> قطع الغيار
                    </a>
                    <a href="{% url 'maintenance:device_list' %}" class="btn btn-outline-success">
                        <i class="fas fa-desktop"></i> الأجهزة
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- الاتجاهات الشهرية -->
    <div class="dashboard-section">
        <h5 class="mb-3">
            <i class="fas fa-chart-area text-info"></i>
            الاتجاهات الشهرية
        </h5>
        
        <div class="chart-container" style="height: 400px;">
            <canvas id="trendsChart"></canvas>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
// إعدادات الرسوم البيانية
Chart.defaults.font.family = 'Cairo, sans-serif';
Chart.defaults.plugins.legend.rtl = true;

// رسم بياني لأوامر الشغل
const workOrderCtx = document.getElementById('workOrderChart').getContext('2d');
const workOrderChart = new Chart(workOrderCtx, {
    type: 'doughnut',
    data: {
        labels: ['جديد', 'مُعيَّن', 'قيد التنفيذ', 'في انتظار قطع الغيار', 'محلول', 'مُغلق'],
        datasets: [{
            data: [
                {{ dashboard_data.work_order_stats.new|default:0 }},
                {{ dashboard_data.work_order_stats.assigned|default:0 }},
                {{ dashboard_data.work_order_stats.in_progress|default:0 }},
                {{ dashboard_data.work_order_stats.wait_parts|default:0 }},
                {{ dashboard_data.work_order_stats.resolved|default:0 }},
                {{ dashboard_data.work_order_stats.closed|default:0 }}
            ],
            backgroundColor: [
                '#ff6384',
                '#36a2eb',
                '#ffce56',
                '#4bc0c0',
                '#9966ff',
                '#ff9f40'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// رسم بياني لقطع الغيار
const sparePartsCtx = document.getElementById('sparePartsChart').getContext('2d');
const sparePartsChart = new Chart(sparePartsCtx, {
    type: 'bar',
    data: {
        labels: ['متوفرة', 'مخزون منخفض', 'منتهية', 'مطلوبة'],
        datasets: [{
            label: 'عدد قطع الغيار',
            data: [
                {{ dashboard_data.spare_parts_stats.available_parts }},
                {{ dashboard_data.spare_parts_stats.low_stock_parts }},
                {{ dashboard_data.spare_parts_stats.out_of_stock_parts }},
                {{ dashboard_data.spare_parts_stats.on_order_parts }}
            ],
            backgroundColor: [
                '#28a745',
                '#ffc107',
                '#dc3545',
                '#17a2b8'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// رسم بياني للاتجاهات الشهرية
const trendsCtx = document.getElementById('trendsChart').getContext('2d');
const trendsChart = new Chart(trendsCtx, {
    type: 'line',
    data: {
        labels: [
            {% for trend in dashboard_data.monthly_trends %}
                '{{ trend.month_name }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [{
            label: 'نسبة التوفر (%)',
            data: [
                {% for trend in dashboard_data.monthly_trends %}
                    {{ trend.availability|default:0 }}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            borderColor: '#36a2eb',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            tension: 0.4
        }, {
            label: 'الالتزام بالصيانة الوقائية (%)',
            data: [
                {% for trend in dashboard_data.monthly_trends %}
                    {{ trend.pm_compliance|default:0 }}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            borderColor: '#4bc0c0',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100
            }
        },
        plugins: {
            legend: {
                position: 'top'
            }
        }
    }
});

// دالة تحديث الداشبورد
function refreshDashboard() {
    location.reload();
}

// تحديث تلقائي كل 5 دقائق
setInterval(refreshDashboard, 300000);
</script>
{% endblock %}
