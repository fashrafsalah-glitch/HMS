{% extends 'base.html' %} 
{% load static %}

{% block content %}
<div class="container mt-4" dir="rtl">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h2 class="mb-1">قائمة الأجهزة</h2>
      <p class="text-muted mb-0">ابحث وفلتر وتصفح الأجهزة بسرعة</p>
    </div>
    <div class="d-flex gap-2">
      <a href="{% url 'maintenance:add_device' %}" class="btn btn-primary">➕ إضافة جهاز جديد</a>
      <a href="{% url 'maintenance:qr_test_page' %}" class="btn btn-info">🔍 اختبار QR - Step 2</a>
      <a href="{% url 'maintenance:add_device_category' %}" class="btn btn-outline-secondary">➕ تصنيف</a>
      <a href="{% url 'maintenance:add_device_subcategory' %}" class="btn btn-outline-secondary">➕ تصنيف فرعي</a>
      <a href="{% url 'add_company' %}" class="btn btn-outline-secondary">➕ شركة</a>
      <a href="{% url 'add_device_type' %}" class="btn btn-outline-secondary">➕ نوع جهاز</a>
      <a href="{% url 'add_device_usage' %}" class="btn btn-outline-secondary">➕ استخدام</a>
    </div>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">التصنيف</label>
          <select name="category" id="category-select" class="form-select">
            <option value="">الكل</option>
            {% for cat in categories %}
              <option value="{{ cat.id }}" {% if request.GET.category == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">التصنيف الفرعي</label>
          <select name="subcategory" id="subcategory-select" class="form-select">
            <option value="">الكل</option>
            {% for sub in subcategories %}
              <option value="{{ sub.id }}" {% if request.GET.subcategory == sub.id|stringformat:"s" %}selected{% endif %}>{{ sub.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">القسم</label>
          <select name="department" id="department-select" class="form-select">
            <option value="">الكل</option>
            {% for dept in departments %}
              <option value="{{ dept.id }}" {% if request.GET.department == dept.id|stringformat:"s" %}selected{% endif %}>{{ dept.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">الغرفة</label>
          <select name="room" id="room-select" class="form-select">
            <option value="">الكل</option>
            {% for room in rooms %}
              <option value="{{ room.id }}" data-dept="{{ room.department_id }}" {% if request.GET.room == room.id|stringformat:"s" %}selected{% endif %}>{{ room.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-2">
          <button type="submit" class="btn btn-primary w-100">🔍 بحث</button>
        </div>
        <div class="col-md-2">
          <a href="{% url 'maintenance:device_list' %}" class="btn btn-light border w-100">⟲ إعادة ضبط</a>
        </div>
      </form>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light sticky-top">
          <tr>
            <th>#</th>
            <th>رقم</th>
            <th>التصنيف</th>
            <th>الفرعي</th>
            <th>الاسم</th>
            <th>القسم</th>
            <th>الغرفة</th>
            <th>السرير</th>
            <th>الحالة</th>
            <th>النظافة</th>
            <th>التعقيم</th>
            <th>المريض الحالي</th>
            <th>الباركود</th>
            <th>إجراءات</th>
            <th>بدء الاستخدام</th>
            <th>إنهاء</th>
          </tr>
        </thead>
        <tbody>
          {% for device in devices %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ device.id }}</td>
              <td>{{ device.category.name }}</td>
              <td>{{ device.subcategory.name }}</td>
              <td class="fw-semibold">{{ device.name }}</td>
              <td>{{ device.department.name }}</td>
              <td>{{ device.room }}</td>
              <td>{{ device.bed }}</td>
              <td>
                <span class="badge text-bg-{% if device.status == 'working' %}success{% elif device.status == 'in_use' %}info{% elif device.status == 'needs_check' %}warning{% else %}secondary{% endif %}">
                  {{ device.get_status_display }}
                </span>
              </td>
              <td>
                <span class="badge text-bg-{% if device.clean_status == 'clean' %}success{% elif device.clean_status == 'needs_cleaning' %}warning{% else %}secondary{% endif %}">
                  {{ device.get_clean_status_display }}
                </span>
              </td>
              <td>
                <span class="badge text-bg-{% if device.sterilization_status == 'sterilized' %}success{% elif device.sterilization_status == 'needs_sterilization' %}warning{% else %}secondary{% endif %}">
                  {{ device.get_sterilization_status_display }}
                </span>
              </td>
              <td>{{ device.current_patient|default:"-" }}</td>
              <td class="text-center">
                {% if device.qr_code %}
                  <div class="d-flex align-items-center justify-content-center gap-2">
                    <a href="{{ device.qr_code.url }}" target="_blank" title="فتح الباركود">
                      <img src="{{ device.qr_code.url }}" alt="QR" class="img-thumbnail" style="width:56px;height:56px;object-fit:contain;"/>
                    </a>
                    <a href="{{ device.qr_code.url }}" download class="btn btn-sm btn-outline-secondary" title="تحميل">
                      ⬇️
                    </a>
                  </div>
                {% else %}
                  <span class="badge text-bg-secondary">لا يوجد</span>
                {% endif %}
              </td>
              <td class="text-nowrap">
                <a href="{% url 'maintenance:device_detail' device.id %}" class="btn btn-sm btn-outline-info" title="فتح">👁️</a>
                <a href="{% url 'maintenance:device_edit' device.id %}" class="btn btn-sm btn-outline-warning" title="تعديل">✏️</a>
                <a href="{% url 'maintenance:device_delete' device.id %}" class="btn btn-sm btn-outline-danger" title="حذف">🗑️</a>
                <a href="{% url 'maintenance:device_transfer' device.id %}" class="btn btn-sm btn-outline-secondary" title="نقل">🔄</a>
              </td>
              <td>
                {% if device.status == 'working' and not device.current_patient %}
                  <a href="{% url 'maintenance:assign_device' device.id %}" class="btn btn-sm btn-primary">📥 استخدام</a>
                {% else %}
                  <span class="text-muted">قيد الاستخدام</span>
                {% endif %}
              </td>
              <td>
                {% if device.current_patient %}
                  <a href="{% url 'maintenance:release_device' device.id %}" class="btn btn-sm btn-warning">⏹️ إنهاء</a>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="15" class="text-center py-4">لا توجد أجهزة مطابقة.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  // تحديث التصنيف الفرعي عند تغيير التصنيف
  $('#category-select').on('change', function () {
    var categoryId = $(this).val();
    $.ajax({
      url: "{% url 'maintenance:ajax_load_subcategories' %}",
      data: { 'category_id': categoryId },
      success: function (data) {
        var subcategorySelect = $('#subcategory-select');
        subcategorySelect.empty();
        subcategorySelect.append('<option value="">الكل</option>');
        data.forEach(function (subcategory) {
          subcategorySelect.append('<option value="' + subcategory.id + '">' + subcategory.name + '</option>');
        });
      }
    });
  });

  // تحميل الغرف حسب القسم
  document.getElementById('department-select').addEventListener('change', function () {
    const deptId = this.value;
    const roomSelect = document.getElementById('room-select');
    roomSelect.innerHTML = '<option value="">جاري التحميل...</option>';

    fetch(`/maintenance/ajax/load-rooms/?department_id=${deptId}`)
      .then(response => response.json())
      .then(data => {
        roomSelect.innerHTML = '<option value="">الكل</option>';
        data.forEach(room => {
          const option = document.createElement('option');
          option.value = room.id;
          option.text = room.name;
          roomSelect.appendChild(option);
        });
      });
  });
</script>
{% endblock %}